<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»“åº“ç®¡ç†åŠ©æ‰‹</title>
    <style>
        * {margin:0;padding:0;box-sizing:border-box;font-family:"å¾®è½¯é›…é»‘", "PingFang SC", "Helvetica Neue", Arial, sans-serif}
        html {font-size:16px}
        body {background:#f5f5f5;padding:10px;min-height:100vh}
        .container {max-width:100%;margin:0 auto;background:#fff;border-radius:8px;padding:15px}
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            html {font-size:14px}
            body {padding:5px}
            .container {padding:10px;border-radius:6px}
            .page-title {font-size:20px;margin-bottom:15px}
            .stats-row {gap:8px;margin-bottom:12px}
            .stats-card {padding:8px;font-size:12px}
            .tabs {gap:6px;margin-bottom:12px}
            .tab {padding:6px 10px;font-size:12px}
            .btn-grid {gap:8px;margin-bottom:12px}
            .btn {padding:10px;font-size:14px}
            .form-group {margin-bottom:12px}
            .form-group label {font-size:13px;margin-bottom:4px}
            .form-group input, .form-group select {padding:8px;font-size:14px}
            .form-group input#singleQty, .form-group input#num1, .form-group input#num2, 
            .form-group input#stockInSingleQty, .form-group input#stockInNum1, .form-group input#stockInNum2, 
            .form-group input#stockOutSingleQty, .form-group input#stockOutNum1, .form-group input#stockOutNum2, 
            .form-group input#editGoodsQty, .form-group input#editGoodsBigQty, .form-group input#editGoodsSmallQty, 
            .form-group input#checkBookQty, .form-group input#checkRealQty {font-size:16px;padding:10px}
            .form-group input#goodsPrice, .form-group input#stockInPrice, .form-group input#stockOutPrice, 
            .form-group input#editGoodsPrice {font-size:16px;padding:10px}
            .unit-convert-row {gap:8px;margin-bottom:12px}
            .unit-input-group input {padding:10px;font-size:16px;border:2px solid #e53935}
            .unit-label {font-size:12px;margin-bottom:4px}
            .goods-card {padding:10px;margin-bottom:10px}
            .goods-card-name {font-size:15px}
            .goods-card-info {font-size:13px}
            .goods-card-edit {width:28px;height:28px;font-size:15px}
            
            /* é¦–é¡µç§»åŠ¨ç«¯æ–‡å­—æ”¾å¤§ */
            #homePage .page-title {font-size:21px}
            #homePage .stats-card {font-size:13px}
            #homePage .stats-card div:last-child {font-size:18px}
            #homePage .tab {font-size:13px}
            #homePage .btn {font-size:15px}
            #homePage .empty-tip {font-size:14px}
            #homePage #homeSearchGoods {font-size:13px}
            .stock-header, .add-goods-header, .goods-list-header, .edit-goods-header {padding:12px}
            .stock-header .title, .add-goods-header .title, .goods-list-header .title, .edit-goods-header .title {font-size:16px}
            .stock-form, .add-goods-form, .edit-goods-form {padding:12px}
            
            /* å…¥åº“å•ã€å‡ºåº“å•ã€ç›˜ç‚¹å•ç§»åŠ¨ç«¯æ–‡å­—æ”¾å¤§ */
            #stockInPage .stock-form .form-group label,
            #stockOutPage .stock-form .form-group label,
            #stockCheckPage .stock-form .form-group label {font-size:14px}
            
            #stockInPage .stock-form input,
            #stockInPage .stock-form select,
            #stockOutPage .stock-form input,
            #stockOutPage .stock-form select,
            #stockCheckPage .stock-form input,
            #stockCheckPage .stock-form select {font-size:14px}
            
            #stockInPage .save-btn,
            #stockInPage .cancel-btn,
            #stockOutPage .save-btn,
            #stockOutPage .cancel-btn,
            #stockCheckPage .save-btn,
            #stockCheckPage .cancel-btn {font-size:15px}
            
            /* ç´¯åŠ è¡¨æ ¼ç§»åŠ¨ç«¯é€‚é… */
            .check-accumulate-table {padding:10px !important;min-width:180px !important;}
            .check-accumulate-table input {padding:8px !important;font-size:14px !important;height:38px !important;}
            .check-accumulate-table button {padding:8px !important;font-size:12px !important;}
            .form-footer {margin-top:15px;gap:8px}
            .save-btn, .cancel-btn {padding:10px;font-size:14px}
            .num-row {gap:8px;margin-bottom:12px}
            .num-row .form-group:first-child {flex:1}
            .num-row .form-group:last-child {flex:2}
            .modal-content {width:95%;padding:12px}
            .category-content {width:98%;padding:12px;max-width:none}
            .category-title {font-size:15px;margin-bottom:10px}
            .category-main-item {margin-bottom:8px;border-radius:8px;border-color:#000;background:#fff}
            .category-main-header {padding:10px}
            .main-type-name {font-size:13px}
            .main-type-total {font-size:20px}
            .category-sub-list {padding:0 10px 10px}
            .category-sub-item {padding:6px 8px;margin-bottom:5px;border-color:#e0e0e0;background:#fafafa}
            .category-sub-name {font-size:12px}
            .category-close-btn {padding:8px;font-size:13px;background:#000}
            .batch-textarea {min-height:120px;padding:8px}
            .table-header {font-size:11px;padding:8px 0}
            .table-header > div {padding:0 5px}
            .goods-item {font-size:11px;padding:8px 0}
            .goods-item > div {padding:0 5px}
            .type-header {font-size:14px;padding:10px}
            .pagination {padding:12px;gap:10px}
            .page-btn {padding:6px 10px;font-size:12px}
            /* åº“å­˜æ˜ç»†ç§»åŠ¨ç«¯é€‚é… */
            .type-section {margin-bottom:15px}
            .type-section .table-header {display:flex;font-size:11px}
            .type-section .goods-item {display:flex;align-items:center}
        }
        
        /* å°å±å¹•æ‰‹æœºé€‚é… */
        @media (max-width: 375px) {
            html {font-size:13px}
            .container {padding:8px}
            .page-title {font-size:18px}
            .stats-card {padding:6px;font-size:11px}
            .tab {padding:5px 8px;font-size:11px}
            .btn {padding:8px;font-size:13px}
            .goods-card {padding:8px}
            .goods-card-name {font-size:13px}
            
            /* é¦–é¡µå°å±å¹•æ–‡å­—æ”¾å¤§ */
            #homePage .page-title {font-size:19px}
            #homePage .stats-card {font-size:12px}
            #homePage .stats-card div:last-child {font-size:16px}
            #homePage .tab {font-size:12px}
            #homePage .btn {font-size:14px}
            #homePage .empty-tip {font-size:13px}
        }
        /* æ–°å¢æ ‡é¢˜æ ·å¼ */
        .page-title {
            font-family: "é»‘ä½“", SimHei, sans-serif;
            font-weight: bold;
            font-size: 24px;
            text-align: left;
            margin-bottom: 20px;
            color: #333;
        }
        .stats-row {display:flex;gap:10px;margin-bottom:15px}
        .stats-card {flex:1;padding:10px;border:1px solid #e0e0e0;border-radius:6px;text-align:center;cursor:pointer}
        .search-bar {margin-bottom:15px;padding:10px;border:1px solid #e0e0e0;border-radius:6px}
        .tabs {display:flex;gap:8px;margin-bottom:15px;overflow-x:auto}
        .tab {padding:8px 12px;border-radius:4px;font-size:14px;background:#fff;border:2px solid #000;white-space:nowrap}
        .tab.active {background:#000;color:#fff}
        .btn-grid {display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px}
        .btn {padding:12px;border-radius:6px;border:2px solid #000;text-align:center;cursor:pointer}
        .btn.black {background:#000;color:#fff;border:2px solid #000}
        .empty-tip {text-align:center;color:#999;padding:20px}

        .type-modal {position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;align-items:flex-start;padding-top:20px;z-index:100}
        .modal-content {width:90%;max-width:400px;background:#fff;border-radius:8px;padding:15px;margin:0 auto}
        .modal-title {font-size:18px;font-weight:60;margin-bottom:15px}
        
        /* é€šç”¨æ¨¡æ€æ¡†æ ·å¼ */
        .common-modal {position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;align-items:flex-start;justify-content:center;padding-top:50px;z-index:200}
        .common-modal-content {width:90%;max-width:500px;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,0.3)}
        .common-modal-header {background:#f5f5f5;padding:15px 20px;border-bottom:1px solid #e0e0e0;display:flex;justify-content:space-between;align-items:center}
        .common-modal-header h3 {margin:0;font-size:18px;font-weight:600}
        .common-modal-close {font-size:24px;cursor:pointer;color:#666;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:50%}
        .common-modal-close:hover {background:#e0e0e0}
        .common-modal-body {max-height:70vh;overflow-y:auto}
        .add-type-row {display:flex;gap:10px;margin-bottom:15px}
        .add-type-row input {flex:1;padding:10px;border:1px solid #e0e0e0;border-radius:6px}
        .type-list {margin-bottom:15px;max-height:250px;overflow-y:auto}
        .main-type-item {padding:10px;border:1px solid #e0e0e0;border-radius:6px;margin-bottom:10px}
        .main-type-header {display:flex;justify-content:space-between;align-items:center}
        .main-type-name {font-size:16px;flex:1;margin-right:10px}
        .main-type-input {flex:1;padding:8px;border:1px solid #e0e0e0;border-radius:4px;display:none}
        .main-type-actions {display:flex;gap:8px}
        .action-btn {width:28px;height:28px;border-radius:4px;display:flex;align-items:center;justify-content:center;cursor:pointer}
        .btn-edit {background:#fff8e1;color:#ff8f0;border:1px solid #ffe082}
        .btn-save {background:#e3f2fd;color:#1976d2;border:1px solid #bbdefb;display:none}
        .btn-cancel {background:#ffebee;color:#d32f2f;border:1px solid #ffcdd2;display:none}
        .btn-add-sub {background:#e3f2fd;color:#1976d2;border:1px solid #bbdefb}
        .btn-delete-main {background:#ffebee;color:#d32f2f;border:1px solid #ffcdd2}
        .close-modal {width:100%;padding:10px;background:#f5f5f5;border:1px solid #e0e0e0;border-radius:6px;text-align:center;cursor:pointer}
        .delete-toast {position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#000;color:#fff;padding:8px 15px;border-radius:4px;display:none;z-index:200}

        .sub-type-list {margin-top:8px;padding-left:20px;display:flex;column-gap:5px;flex-direction:column}
        .sub-type-item {padding:6px 8px;border:1px solid #f0f0f0;border-radius:4px;display:flex;justify-content:space-between;align-items:center}
        .sub-type-name {font-size:14px;flex:1}
        .sub-type-input {flex:1;padding:6px;border:1px solid #e0e0e0;border-radius:4px;display:none}

        .add-goods-page {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;z-index:120;overflow-y:auto}
        .add-goods-header {padding:15px;border-bottom:1px solid #e0e0e0;display:flex;align-items:center;gap:10px}
        .add-goods-header .back-btn {font-size:20px;cursor:pointer}
        .add-goods-header .title {font-size:18px;font-weight:60}
        .add-goods-form {padding:15px}
        .form-group {margin-bottom:15px}
        .form-group label {display:block;margin-bottom:5px;font-size:14px}
        .form-group input, .form-group select {width:100%;padding:10px;border:1px solid #e0e0e0;border-radius:6px;outline:none}
        .form-group input#singleQty, .form-group input#num1, .form-group input#num2, .form-group input#stockInSingleQty, .form-group input#stockInNum1, .form-group input#stockInNum2, .form-group input#stockOutSingleQty, .form-group input#stockOutNum1, .form-group input#stockOutNum2, .form-group input#editGoodsQty, .form-group input#editGoodsBigQty, .form-group input#editGoodsSmallQty, .form-group input#checkBookQty, .form-group input#checkRealQty, .form-group input#checkBookSingle, .form-group input#checkRealSingle {font-size:18px;font-weight:700;border:2px solid #e53935;padding:12px}
        .form-group input#goodsPrice, .form-group input#stockInPrice, .form-group input#stockOutPrice, .form-group input#editGoodsPrice {font-size:18px;font-weight:700;border:2px solid #e53935;padding:12px;color:#000}
        .input-row {display:flex;gap:10px;margin-bottom:15px}
        .input-row .input-btn {flex:1;padding:12px;border:1px solid #e0e0e0;border-radius:6px;text-align:center;cursor:pointer}
        .input-row .input-btn.active {background:#000;color:#fff;border-color:#000}
        .save-btn {width:100%;padding:12px;background:#000;color:#fff;border:none;border-radius:6px;font-size:16px;cursor:pointer}
        .cancel-btn {width:100%;padding:12px;background:#f5f5f5;border:1px solid #e0e0e0;border-radius:6px;font-size:16px;cursor:pointer;margin-bottom:10px}

        .batch-input-section {display:none;margin-top:15px}
        .batch-desc {background:#e1f5fe;padding:10px;border-radius:6px;margin-bottom:15px}
        .batch-desc h3 {color:#0277bd;margin-bottom:5px}
        .batch-textarea {width:100%;min-height:150px;padding:10px;border:1px solid #e0e0e0;border-radius:6px;outline:none;margin-bottom:15px}
        .batch-btn-group {display:flex;gap:10px}
        .batch-btn-group button {flex:1;padding:12px;border-radius:6px;font-size:16px;cursor:pointer}
        .btn-blue {background:#2196f3;color:#fff;border:none}
        .btn-gray {background:#f5f5f5;border:1px solid #e0e0e0}

        .stock-page {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;z-index:120;overflow-y:auto}
        .stock-header {padding:15px;border-bottom:1px solid #e0e0e0;display:flex;align-items:center;gap:10px}
        .stock-header .back-btn {font-size:21px;cursor:pointer}
        .stock-header .title {font-size:19px;font-weight:60}
        .stock-form {padding:15px}
        
        /* å…¥åº“å•ã€å‡ºåº“å•ã€ç›˜ç‚¹å•æ–‡å­—æ”¾å¤§ */
        #stockInPage .stock-form .form-group label,
        #stockOutPage .stock-form .form-group label,
        #stockCheckPage .stock-form .form-group label {font-size:15px}
        
        #stockInPage .stock-form input,
        #stockInPage .stock-form select,
        #stockOutPage .stock-form input,
        #stockOutPage .stock-form select,
        #stockCheckPage .stock-form input,
        #stockCheckPage .stock-form select {font-size:15px}
        
        #stockInPage .search-select-input,
        #stockOutPage .search-select-input,
        #stockCheckPage .search-select-input {font-size:15px}
        
        #stockInPage .unit-label,
        #stockOutPage .unit-label,
        #stockCheckPage .unit-label {font-size:15px}
        
        #stockInPage .save-btn,
        #stockInPage .cancel-btn,
        #stockOutPage .save-btn,
        #stockOutPage .cancel-btn,
        #stockCheckPage .save-btn,
        #stockCheckPage .cancel-btn {font-size:17px}
        .search-group {display:flex;align-items:center;gap:8px;margin-bottom:15px}
        .search-group input {flex:1;padding:10px;border:1px solid #e0e0e0;border-radius:6px;outline:none}
        .search-group .search-btn {width:40px;height:40px;border-radius:6px;background:#000;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer}
        .form-footer {display:flex;gap:10px;margin-top:20px}
        .form-footer .cancel-btn {flex:1}
        .form-footer .save-btn {flex:1}

        .unit-convert-row {display:flex;gap:10px;margin-bottom:15px}
        .unit-input-group {flex:1;display:flex;flex-direction:column}
        .unit-input-group.unit-input-small {flex:2}
        .unit-label {font-size:14px;color:#666;margin-bottom:5px}
        .unit-input-group input {width:100%;padding:12px;border:2px solid #e53935;border-radius:6px;font-size:18px;font-weight:700;outline:none;box-sizing:border-box}

        .goods-list-page {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;z-index:130;overflow-y:auto}
        .goods-list-header {padding:15px;border-bottom:1px solid #e0e0e0;display:flex;align-items:center;gap:10px}
        .goods-list-header .back-btn {font-size:20px;cursor:pointer}
        .goods-list-header .title {font-size:18px;font-weight:60}
        .goods-search {padding:15px;background:#f5f5f5;margin-bottom:15px}
        .goods-search input {width:100%;padding:10px;border:1px solid #e0e0e0;border-radius:6px;outline:none}
        .goods-table {padding:0 15px}
        .table-header {display:flex;padding:10px 0;border-bottom:1px solid #e0e0e0;font-weight:600}
        .table-header div {flex:1;text-align:center}
        .table-header div:first-child {flex:2;text-align:left}
        .goods-item {padding:10px;border-bottom:1px solid #f0f0f0;display:flex;align-items:center}
        .goods-item div {flex:1;text-align:center}
        .goods-item div:first-child {flex:2;text-align:left}
        .pagination {display:flex;justify-content:center;gap:15px;padding:15px}
        .page-btn {padding:8px 12px;border:1px solid #e0e0e0;border-radius:4px;cursor:pointer}
        .page-btn.active {background:#000;color:#fff;border-color:#000}

        .low-stock-page {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;z-index:130;overflow-y:auto}
        .low-stock-header {padding:15px;border-bottom:1px solid #e0e0e0;display:flex;align-items:center;justify-content:space-between}
        .low-stock-header .back-btn {font-size:20px;cursor:pointer}
        .low-stock-header .title {font-size:18px;font-weight:60}
        .low-stock-header .close-btn {font-size:20px;cursor:pointer}
        .low-stock-list {padding:15px}
        .low-stock-item {border:2px solid #f44336;border-radius:8px;padding:12px;margin-bottom:15px;background:#fff3f3}
        .low-stock-item .goods-name {font-size:16px;font-weight:60;margin-bottom:8px}
        .low-stock-item .goods-type {color:#666;font-size:14px;margin-bottom:8px}
        .low-stock-item .stock-row {display:flex;justify-content:space-between;margin-bottom:8px}
        .low-stock-item .current-stock {color:#f44336;font-weight:60}
        .low-stock-item .warn-tip {color:#f44336;display:flex;align-items:center;gap:4px}

        .stock-in-warn-page {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;z-index:130;overflow-y:auto}
        .stock-in-warn-header {padding:15px;border-bottom:1px solid #e0e0e0;display:flex;align-items:center;justify-content:space-between}
        .stock-in-warn-header .back-btn {font-size:20px;cursor:pointer}
        .stock-in-warn-header .title {font-size:18px;font-weight:60}
        .stock-in-warn-header .close-btn {font-size:20px;cursor:pointer}
        .stock-in-warn-list {padding:15px}
        .stock-in-warn-item {border:2px solid #f57c00;border-radius:8px;padding:12px;margin-bottom:15px;background:#fff8e1}
        .stock-in-warn-item .goods-name {font-size:16px;font-weight:60;margin-bottom:8px}
        .stock-in-warn-item .goods-type {color:#666;font-size:14px;margin-bottom:8px}
        .stock-in-warn-item .stock-row {display:flex;justify-content:space-between;margin-bottom:8px}
        .stock-in-warn-item .stock-in-time {color:#f57c00;font-weight:60}
        .stock-in-warn-item .warn-tip {color:#f57c00;display:flex;align-items:center;gap:4px}

        .goods-category-modal {position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:100;overflow-y:auto;padding:20px}
        .category-content {width:95%;max-width:500px;background:#fff;border-radius:12px;padding:15px;margin:auto;max-height:90vh;overflow-y:auto}
        .category-title {font-size:16px;font-weight:600;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center}
        .category-close {font-size:20px;cursor:pointer;color:#000}
        
        /* å¤§ç±»å‹å¡ç‰‡æ ·å¼ - é»‘è‰²è¾¹æ¡†ç™½è‰²èƒŒæ™¯ */
        .category-main-item {margin-bottom:10px;border:2px solid #000;border-radius:10px;overflow:hidden;background:#fff}
        .category-main-header {padding:12px;display:flex;justify-content:space-between;align-items:flex-start}
        .main-type-left {flex:1}
        .main-type-name {font-size:14px;font-weight:600;color:#333;margin-bottom:3px}
        .main-type-count {font-size:11px;color:#666}
        .main-type-total {font-size:22px;font-weight:bold;color:#000}
        
        /* å­ç±»å‹åˆ—è¡¨æ ·å¼ - æµ…ç°è¾¹æ¡†ç™½è‰²èƒŒæ™¯ */
        .category-sub-list {padding:0 12px 12px}
        .category-sub-item {display:flex;justify-content:space-between;align-items:center;padding:8px 10px;margin-bottom:6px;border:1px solid #e0e0e0;border-radius:6px;background:#fafafa}
        .category-sub-name {font-size:13px;color:#333}
        .category-sub-info {display:flex;align-items:center;gap:8px;font-size:13px}
        .category-sub-qty {font-weight:600;color:#000}
        .category-sub-count {color:#666;font-size:11px}
        
        /* å…³é—­æŒ‰é’® - é»‘è‰²èƒŒæ™¯ */
        .category-close-btn {width:100%;padding:10px;background:#000;color:#fff;border:none;border-radius:6px;font-size:14px;cursor:pointer;margin-top:8px}
        
        .num-row {display:flex;gap:10px;margin-bottom:15px}
        .num-row .form-group {flex:1;margin-bottom:0}
        .num-row .form-group:first-child {flex:1}
        .num-row .form-group:last-child {flex:2}

        .unit-set-row {display:flex;align-items:center;gap:10px;margin-bottom:15px}
        .unit-set-row .form-group {flex:1;margin-bottom:0}
        .unit-set-btn {font-size:20px;cursor:pointer;padding:0 8px}
        
        /* æœç´¢ä¸‹æ‹‰æ¡†æ ·å¼ */
        .search-select-wrapper {position:relative;width:100%}
        .search-select-input {width:100%;padding:10px;border:1px solid #e0e0e0;border-radius:6px;outline:none;font-size:14px}
        .search-select-dropdown {position:absolute;left:0;top:100%;width:100%;max-height:200px;overflow-y:auto;background:#fff;border:1px solid #e0e0e0;border-radius:6px;margin-top:4px;display:none;z-index:999}
        .search-select-item {padding:8px 12px;cursor:pointer}
        .search-select-item:hover {background:#f0f0f0}
        
        /* å•†å“å¡ç‰‡åˆ—è¡¨æ ·å¼ */
        .goods-list {margin-top:15px}
        .goods-card {
            border:2px solid #000;
            border-radius:8px;
            padding:12px;
            margin-bottom:12px;
            background:#fff;
            position:relative;
        }
        .goods-card-header {
            display:flex;
            justify-content:space-between;
            align-items:flex-start;
            margin-bottom:8px;
        }
        .goods-card-name {
            font-size:17px;
            font-weight:bold;
            color:#333;
            flex:1;
        }
        .goods-card-edit {
            width:24px;
            height:24px;
            cursor:pointer;
            color:#666;
            font-size:19px;
        }
        .goods-card-type {
            font-size:14px;
            color:#666;
            margin-bottom:4px;
        }
        .goods-card-time {
            font-size:13px;
            color:#999;
            margin-bottom:8px;
        }
        .goods-card-stock {
            display:flex;
            align-items:baseline;
            gap:4px;
        }
        .goods-card-qty {
            font-size:29px;
            font-weight:700;
            color:#000;
        }
        .goods-card-unit {
            font-size:15px;
            color:#666;
        }
        
        /* é¦–é¡µæ–‡å­—æ”¾å¤§æ ·å¼ */
        #homePage .page-title {font-size:25px}
        #homePage .stats-card {font-size:15px}
        #homePage .stats-card div:last-child {font-size:22px}
        #homePage .tab {font-size:15px}
        #homePage .btn {font-size:17px}
        #homePage .empty-tip {font-size:16px}
        #homePage #homeSearchGoods {font-size:15px}
        
        /* ç¼–è¾‘å•†å“é¡µé¢æ ·å¼ */
        .edit-goods-page {
            display:none;
            position:fixed;
            top:0;
            left:0;
            width:100%;
            height:100%;
            background:#fff;
            z-index:120;
            overflow-y:auto;
        }
        .edit-goods-header {
            padding:15px;
            border-bottom:1px solid #e0e0e0;
            display:flex;
            align-items:center;
            gap:10px;
        }
        .edit-goods-header .back-btn {
            font-size:20px;
            cursor:pointer;
        }
        .edit-goods-header .title {
            font-size:18px;
            font-weight:600;
        }
        .edit-goods-form {
            padding:15px;
        }
        .edit-goods-form .form-group {
            margin-bottom:15px;
        }
        .edit-goods-form .form-group label {
            display:block;
            margin-bottom:5px;
            font-size:14px;
            color:#666;
        }
        .edit-goods-form .form-group input,
        .edit-goods-form .form-group select {
            width:100%;
            padding:12px;
            border:1px solid #e0e0e0;
            border-radius:6px;
            font-size:14px;
            background:#fff;
        }
        .edit-goods-form .form-group input[readonly],
        .edit-goods-form .form-group select:disabled {
            background:#f5f5f5;
            color:#666;
        }
        .edit-goods-form .cancel-btn {
            width:100%;
            padding:12px;
            background:#f5f5f5;
            border:1px solid #e0e0e0;
            border-radius:6px;
            font-size:16px;
            cursor:pointer;
            margin-bottom:10px;
        }
        .edit-goods-form .delete-btn {
            width:100%;
            padding:12px;
            background:#ffebee;
            border:1px solid #ffcdd2;
            border-radius:6px;
            font-size:16px;
            color:#d32f2f;
            cursor:pointer;
            margin-bottom:10px;
        }
        .edit-goods-form .save-btn {
            width:100%;
            padding:12px;
            background:#000;
            color:#fff;
            border:none;
            border-radius:6px;
            font-size:16px;
            cursor:pointer;
        }
    </style>
</head>
<body>

<!-- ç™»å½•é¡µé¢ -->
<div id="loginPage" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#f5f5f5;z-index:2000;">
    <div style="max-width:400px;margin:80px auto;padding:30px;background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.1);">
        <h2 style="text-align:center;margin-bottom:30px;font-size:24px;color:#333;">ä»“åº“ç®¡ç†ç³»ç»Ÿ</h2>
        <div class="form-group">
            <label>è´¦å·</label>
            <input type="text" id="loginUsername" placeholder="è¯·è¾“å…¥è´¦å·" style="border:2px solid #000;">
        </div>
        <div class="form-group">
            <label>å¯†ç </label>
            <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç " style="border:2px solid #000;">
        </div>
        <div id="loginError" style="color:#e53935;margin-bottom:15px;font-size:14px;display:none;"></div>
        <button class="save-btn" id="doLogin" style="margin-bottom:10px;background:#000;">ç™»å½•</button>
        <button class="cancel-btn" id="goRegister" style="background:#fff;border:2px solid #000;">æ³¨å†Œè´¦å·</button>
    </div>
</div>

<!-- æ³¨å†Œé¡µé¢ -->
<div id="registerPage" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#f5f5f5;z-index:2000;">
    <div style="max-width:400px;margin:80px auto;padding:30px;background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.1);">
        <h2 style="text-align:center;margin-bottom:30px;font-size:24px;color:#333;">æ³¨å†Œè´¦å·</h2>
        <div class="form-group">
            <label>è´¦å·</label>
            <input type="text" id="regUsername" placeholder="è¯·è¾“å…¥è´¦å·" style="border:2px solid #000;">
        </div>
        <div class="form-group">
            <label>å¯†ç </label>
            <input type="password" id="regPassword" placeholder="è¯·è¾“å…¥å¯†ç " style="border:2px solid #000;">
        </div>
        <div class="form-group">
            <label>ç¡®è®¤å¯†ç </label>
            <input type="password" id="regPassword2" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " style="border:2px solid #000;">
        </div>
        <div id="regError" style="color:#e53935;margin-bottom:15px;font-size:14px;display:none;"></div>
        <button class="save-btn" id="doRegister" style="margin-bottom:10px;background:#000;">æ³¨å†Œ</button>
        <button class="cancel-btn" id="backToLogin" style="background:#fff;border:2px solid #000;">è¿”å›ç™»å½•</button>
    </div>
</div>

<!-- åŒæ­¥çŠ¶æ€æç¤º -->
<div id="syncStatus" style="display:none;position:fixed;top:10px;right:10px;padding:10px 15px;background:#4caf50;color:#fff;border-radius:6px;font-size:14px;z-index:1500;">
    åŒæ­¥æˆåŠŸ
</div>

<div class="container" id="homePage">
    <!-- æ–°å¢çš„æ ‡é¢˜ -->
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
        <div class="page-title" style="margin-bottom:0;">ä»“åº“ç®¡ç†åŠ©æ‰‹</div>
        <div style="display:flex;gap:10px;">
            <div class="btn" id="syncBtn" style="padding:8px 15px;font-size:14px;background:#fff;border:2px solid #000;">ğŸ”„ åŒæ­¥</div>
            <div class="btn" id="logoutBtn" style="padding:8px 15px;font-size:14px;background:#fff;border:2px solid #000;">é€€å‡ºç™»å½•</div>
        </div>
    </div>
    
    <div class="stats-row">
        <div class="stats-card" id="goodsCategoryCard" style="border:2px solid #2196f3;cursor:pointer;"><div>å•†å“ç§ç±»</div><div>0</div></div>
        <div class="stats-card" id="stockDetailCard" style="border:2px solid #2196f3;cursor:pointer;"><div>åº“å­˜æ˜ç»†</div><div style="font-size:28px;">ğŸ“¦</div></div>
    </div>
    <div class="stats-row">
        <div class="stats-card" id="lowStockCard" style="border:2px solid #e53935"><div>ä½åº“å­˜é¢„è­¦</div><div>0</div></div>
        <div class="stats-card" id="stockInWarnCard" style="border:2px solid #f57c00"><div>å…¥åº“é¢„è­¦</div><div>0</div></div>
    </div>
    <div class="search-bar-wrapper" style="position:relative;margin:0 0 15px;">
        <input type="text" id="homeSearchGoods" placeholder="æœç´¢å•†å“..." autocomplete="off" style="width:100%;padding:12px 40px 12px 15px;border:2px solid #000;border-radius:8px;font-size:14px;background:#fff;outline:none;box-sizing:border-box;">
        <div style="position:absolute;right:12px;top:50%;transform:translateY(-50%);font-size:18px;color:#666;pointer-events:none;">ğŸ”</div>
        <div class="home-search-dropdown" id="homeSearchDropdown" style="display:none;position:absolute;left:0;right:0;top:100%;background:#fff;border:1px solid #e0e0e0;border-radius:8px;margin-top:4px;max-height:300px;overflow-y:auto;z-index:50;box-shadow:0 4px 12px rgba(0,0,0,0.15);"></div>
    </div>
    <div class="tabs" id="homeTabs"></div>
    <div class="btn-grid">
        <div class="btn black" id="openAddGoods">+æ·»åŠ å•†å“</div>
        <div class="btn" id="openImportExport">å¯¼å…¥å¯¼å‡ºæ•°æ®</div>
    </div>
    <div class="btn-grid">
        <div class="btn" id="openStockIn">å…¥åº“å•</div>
        <div class="btn" id="openStockOut">å‡ºåº“å•</div>
    </div>
    <div class="btn-grid">
        <div class="btn" id="openTypeModal">ç®¡ç†ç±»å‹</div>
        <div class="btn" id="openStockCheck">ç›˜ç‚¹å•</div>
    </div>
    <div class="empty-tip" id="emptyTip">æš‚æ— å•†å“æ•°æ®ï¼Œè¯·æ·»åŠ å•†å“</div>
    <div class="goods-list" id="goodsListContainer"></div>
</div>

<div class="goods-category-modal" id="goodsCategoryModal">
    <div class="category-content">
        <div class="category-title"><span>å„ç±»å•†å“æ•°é‡</span><span class="category-close" id="closeCategoryModal">Ã—</span></div>
        <div id="categoryListContainer"></div>
        <button class="category-close-btn" id="closeCategoryBtn">å…³é—­</button>
    </div>
</div>

<div class="add-goods-page" id="addGoodsPage">
    <div class="add-goods-header"><div class="back-btn" id="backToHomeFromAdd">â†</div><div class="title">æ·»åŠ å•†å“</div></div>
    <div class="add-goods-form">
        <div class="input-row"><div class="input-btn active" id="singleInput">å•ä¸ªå½•å…¥</div><div class="input-btn" id="batchInput">æ‰¹é‡å½•å…¥</div></div>
        <div id="singleInputForm">
            <div class="form-group"><label>å•†å“åç§°</label><input type="text" id="goodsName" placeholder="è¯·è¾“å…¥å•†å“åç§°"></div>
            <div class="form-group"><label>å•†å“è§„æ ¼</label><input type="text" id="goodsSpec" placeholder="è¯·è¾“å…¥å•†å“è§„æ ¼ï¼ˆå¦‚ï¼š500g/ç“¶ï¼‰"></div>
            <div class="form-group"><label>å•†å“ç±»å‹</label><select id="goodsType"></select></div>
            <div class="form-group"><label>å•†å“å­ç±»å‹</label><select id="goodsSubType"></select></div>

            <div class="form-group" id="singleQtyRow">
                <label>æ•°é‡</label>
                <input type="number" id="singleQty">
            </div>

            <div class="unit-set-row">
                <div class="form-group">
                    <label>å•ä½</label>
                    <input type="text" id="unitDisplay" placeholder="ç‚¹å‡»âš™ï¸è®¾ç½®" readonly>
                </div>
                <div class="unit-set-btn" id="toggleUnit">âš™ï¸</div>
            </div>

            <div class="num-row" id="multiUnitRow" style="display:none;">
                <div class="form-group"><label>å¤§å•ä½æ•°é‡</label><input type="number" id="num1"></div>
                <div class="form-group"><label>å°å•ä½æ•°é‡</label><input type="number" id="num2"></div>
            </div>

            <div class="form-group"><label>å•ä»·</label><input type="number" id="goodsPrice" step="0.01"></div>
            <div class="form-group"><label>é‡‘é¢</label><input type="text" id="goodsAmount" readonly></div>
            <div class="form-group"><label>é¢„è­¦é˜ˆå€¼</label><input type="number" id="goodsWarn" min="0" value="1"></div>
            <div class="form-group"><label>å…¥åº“æ—¶é—´</label><input type="date" id="goodsTime"></div>
            <div class="form-group">
                <label>æ—¥æœŸé¢„è­¦è®¾ç½®</label>
                <input type="date" id="goodsWarnDate" placeholder="é€‰æ‹©é¢„è­¦æ—¥æœŸ">
                <div style="font-size:12px;color:#999;margin-top:5px;">ç•™ç©ºåˆ™ä½¿ç”¨å…¨å±€é¢„è­¦å¤©æ•°ï¼ˆ90å¤©ï¼‰</div>
            </div>
            <button class="cancel-btn" id="cancelAddGoods">å–æ¶ˆ</button>
            <button class="save-btn" id="saveGoods">ä¿å­˜</button>
        </div>
        <div class="batch-input-section" id="batchInputForm">
            <div class="batch-desc"><h3>æ‰¹é‡å½•å…¥æ ¼å¼</h3><p>åç§°,æ•°é‡,å•ä½,ç±»å‹,å­ç±»å‹,å•ä»·,é¢„è­¦å€¼,æ—¶é—´,é¢„è­¦å¤©æ•°</p></div>
            <textarea class="batch-textarea" id="batchInputContent"></textarea>
            <div class="batch-btn-group">
                <button class="btn-blue" id="parseBatchData">è§£æ</button>
                <button class="btn-gray" id="cancelBatchInput">å–æ¶ˆ</button>
                <button class="btn black" id="saveBatchGoods">æ‰¹é‡ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div class="type-modal" id="unitModal" style="z-index:150;display:none;">
        <div class="modal-content" style="max-width:350px;">
            <div class="modal-title">å•ä½è®¾ç½®</div>
            <div class="form-group">
                <label>å•ä½ç±»å‹</label>
                <div class="input-row">
                    <div class="input-btn active" id="singleUnitBtn" onclick="switchUnitType('single')">å•ä¸ªå•ä½</div>
                    <div class="input-btn" id="multiUnitBtn" onclick="switchUnitType('multi')">å•ä½æ¢ç®—</div>
                </div>
            </div>
            <div id="singleUnitSection">
                <div class="form-group">
                    <label>å•ä½</label>
                    <input type="text" id="singleUnitInput" placeholder="å¦‚ï¼šä¸ªã€ä»¶ã€ç®±">
                </div>
            </div>
            <div id="multiUnitSection" style="display:none;">
                <div class="form-group">
                    <label>å¤§å•ä½</label>
                    <input type="text" id="bigUnit" placeholder="å¦‚ï¼šç®±ã€ä»¶">
                </div>
                <div class="form-group">
                    <label>æ¢ç®—æ¯”ä¾‹</label>
                    <input type="number" id="unitRate" value="1" min="1">
                </div>
                <div class="form-group">
                    <label>å°å•ä½</label>
                    <input type="text" id="smallUnit" placeholder="å¦‚ï¼šä¸ªã€åŒ…">
                </div>
            </div>
            <div class="form-footer">
                <button class="cancel-btn" id="cancelUnit">å–æ¶ˆ</button>
                <button class="save-btn" id="saveUnit">ç¡®å®š</button>
            </div>
        </div>
    </div>
</div>

<div class="stock-page" id="stockInPage">
    <div class="stock-header"><div class="back-btn" id="backToHomeFromStockIn">â†</div><div class="title">å…¥åº“å•</div></div>
    <div class="stock-form">
        <div class="form-group"><label>å•†å“ç±»å‹</label><select id="stockInGoodsType"></select></div>
        <div class="form-group"><label>å•†å“å­ç±»å‹</label><select id="stockInGoodsSubType"></select></div>

        <div class="form-group">
            <label>é€‰æ‹©å•†å“</label>
            <div class="search-select-wrapper">
                <input type="text" class="search-select-input" id="stockInSearchGoods" placeholder="è¾“å…¥å…³é”®å­—æœç´¢å•†å“">
                <div class="search-select-dropdown" id="stockInGoodsDropdown"></div>
            </div>
        </div>

        <div class="form-group">
            <label>å•†å“è§„æ ¼</label>
            <input type="text" id="stockInSpec" placeholder="é€‰æ‹©å•†å“åè‡ªåŠ¨å¡«å†™" readonly>
        </div>

        <div class="form-group" id="stockInSingleRow">
            <label>æ•°é‡</label>
            <input type="number" id="stockInSingleQty">
        </div>
        
        <div class="form-group">
            <label>å•ä½</label>
            <input type="text" id="stockInUnit" placeholder="å•ä½" readonly>
        </div>
        
        <div class="unit-convert-row" id="stockInMultiRow" style="display:none;">
            <div class="unit-input-group">
                <div class="unit-label" id="stockInBigUnit">KG</div>
                <input type="number" id="stockInNum1">
            </div>
            <div class="unit-input-group unit-input-small">
                <div class="unit-label" id="stockInSmallUnit">g</div>
                <input type="number" id="stockInNum2">
            </div>
        </div>
        
        <div class="form-group"><label>å•ä»·</label><input type="number" id="stockInPrice" step="0.001"></div>
        <div class="form-group"><label>é‡‘é¢</label><input type="text" id="stockInAmount" readonly></div>
        <div class="form-group"><label>å…¥åº“æ—¶é—´</label><input type="date" id="stockInTime"></div>
        <div class="form-group"><label>å¤‡æ³¨</label><input type="text" id="stockInRemark"></div>
        <div class="form-footer">
            <button class="cancel-btn" id="cancelStockIn">å–æ¶ˆ</button>
            <button class="save-btn" id="saveStockIn">ä¿å­˜</button>
        </div>
    </div>
</div>

<div class="stock-page" id="stockOutPage">
    <div class="stock-header"><div class="back-btn" id="backToHomeFromStockOut">â†</div><div class="title">å‡ºåº“å•</div></div>
    <div class="stock-form">
        <div class="form-group"><label>å•†å“ç±»å‹</label><select id="stockOutGoodsType"></select></div>
        <div class="form-group"><label>å•†å“å­ç±»å‹</label><select id="stockOutGoodsSubType"></select></div>

        <div class="form-group">
            <label>é€‰æ‹©å•†å“</label>
            <div class="search-select-wrapper">
                <input type="text" class="search-select-input" id="stockOutSearchGoods" placeholder="è¾“å…¥å…³é”®å­—æœç´¢å•†å“">
                <div class="search-select-dropdown" id="stockOutGoodsDropdown"></div>
            </div>
        </div>

        <div class="form-group">
            <label>å•†å“è§„æ ¼</label>
            <input type="text" id="stockOutSpec" placeholder="é€‰æ‹©å•†å“åè‡ªåŠ¨å¡«å†™" readonly>
        </div>

        <div class="form-group" id="stockOutSingleRow">
            <label>æ•°é‡</label>
            <input type="number" id="stockOutSingleQty">
        </div>
        
        <div class="form-group">
            <label>å•ä½</label>
            <input type="text" id="stockOutUnit" placeholder="å•ä½" readonly>
        </div>
        
        <div class="unit-convert-row" id="stockOutMultiRow" style="display:none;">
            <div class="unit-input-group">
                <div class="unit-label" id="stockOutBigUnit">KG</div>
                <input type="number" id="stockOutNum1">
            </div>
            <div class="unit-input-group unit-input-small">
                <div class="unit-label" id="stockOutSmallUnit">g</div>
                <input type="number" id="stockOutNum2">
            </div>
        </div>
        
        <div class="form-group"><label>å•ä»·</label><input type="number" id="stockOutPrice" step="0.001"></div>
        <div class="form-group"><label>é‡‘é¢</label><input type="text" id="stockOutAmount" readonly></div>
        <div class="form-footer">
            <button class="cancel-btn" id="cancelStockOut">å–æ¶ˆ</button>
            <button class="save-btn" id="saveStockOut">ä¿å­˜</button>
        </div>
    </div>
</div>

<div class="stock-page" id="stockCheckPage">
    <div class="stock-header"><div class="back-btn" id="backToHomeFromStockCheck">â†</div><div class="title">ç›˜ç‚¹å•</div></div>
    <div class="stock-form">
        <div class="form-group"><label>å•†å“ç±»å‹</label><select id="stockCheckGoodsType"></select></div>
        <div class="form-group"><label>å•†å“å­ç±»å‹</label><select id="stockCheckGoodsSubType"></select></div>

        <div class="form-group">
            <label>é€‰æ‹©å•†å“</label>
            <div class="search-select-wrapper">
                <input type="text" class="search-select-input" id="stockCheckSearchGoods" placeholder="è¾“å…¥å…³é”®å­—æœç´¢å•†å“">
                <div class="search-select-dropdown" id="stockCheckGoodsDropdown"></div>
            </div>
        </div>

        <div class="form-group">
            <label>å•†å“è§„æ ¼</label>
            <input type="text" id="stockCheckSpec" placeholder="é€‰æ‹©å•†å“åè‡ªåŠ¨å¡«å†™" readonly>
        </div>

        <div class="check-section-title" style="font-size:16px;font-weight:600;color:#333;margin-bottom:10px;padding-bottom:8px;border-bottom:2px solid #e0e0e0;display:flex;align-items:center;justify-content:space-between;">
            <span>è´¦é¢æ•°é‡</span>
            <button type="button" onclick="showAccumulateModal()" title="æ‰“å¼€æ•°é‡ç´¯åŠ è¡¨" style="width:32px;height:32px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:6px;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;">
                ğŸ§®
            </button>
        </div>
        
        <div class="form-group" id="checkSingleRow">
            <label>æ•°é‡</label>
            <input type="number" id="checkBookSingle" readonly>
        </div>
        
        <div class="form-group">
            <label>å•ä½</label>
            <input type="text" id="stockCheckUnit" placeholder="å•ä½" readonly>
        </div>
        
        <div class="unit-convert-row" id="checkMultiRow" style="display:none;">
            <div class="unit-input-group">
                <div class="unit-label" id="checkBookBigUnit">KG</div>
                <input type="number" id="checkBook1" readonly>
            </div>
            <div class="unit-input-group unit-input-small">
                <div class="unit-label" id="checkBookSmallUnit">g</div>
                <input type="number" id="checkBook2" readonly>
            </div>
        </div>
        
        <div class="check-section-title" style="font-size:16px;font-weight:600;color:#333;margin:20px 0 10px 0;padding-bottom:8px;border-bottom:2px solid #e0e0e0;">å®ç›˜æ•°é‡</div>
        
        <div class="form-group" id="realSingleRow">
            <label>æ•°é‡</label>
            <input type="number" id="checkRealSingle">
        </div>
        <div class="unit-convert-row" id="realMultiRow" style="display:none;">
            <div class="unit-input-group">
                <div class="unit-label" id="checkRealBigUnit">KG</div>
                <input type="number" id="checkReal1">
            </div>
            <div class="unit-input-group unit-input-small">
                <div class="unit-label" id="checkRealSmallUnit">g</div>
                <input type="number" id="checkReal2">
            </div>
        </div>
        
        <div class="form-group"><label>å·®å¼‚</label><input type="text" id="checkDiff" readonly></div>
        <div class="form-group"><label>åŸå› </label><select id="stockCheckReason"><option>æ­£å¸¸æŸè€—</option><option>ç›˜ç›ˆ</option><option>ç›˜äº</option><option>å…¶ä»–</option></select></div>
        <div class="form-group"><label>å¤‡æ³¨</label><input type="text" id="stockCheckRemark"></div>
        <div class="form-footer">
            <button class="cancel-btn" id="cancelStockCheck">å–æ¶ˆ</button>
            <button class="save-btn" id="saveStockCheck">ä¿å­˜</button>
        </div>
    </div>
</div>

<div class="edit-goods-page" id="editGoodsPage">
    <div class="edit-goods-header">
        <div class="back-btn" id="backToHomeFromEdit">â†</div>
        <div class="title">ç¼–è¾‘å•†å“</div>
    </div>
    <div class="edit-goods-form">
        <div class="form-group">
            <label>é€‰æ‹©å•†å“</label>
            <input type="text" id="editGoodsName" readonly>
        </div>
        <div class="form-group">
            <label>å•†å“è§„æ ¼</label>
            <input type="text" id="editGoodsSpec">
        </div>
        <div class="form-group">
            <label>å•†å“ç±»å‹</label>
            <select id="editGoodsType" disabled></select>
        </div>
        <div class="form-group">
            <label>å•†å“å­ç±»å‹</label>
            <select id="editGoodsSubType" disabled></select>
        </div>
        <div class="form-group" id="editSingleUnitRow">
            <label>å•ä½</label>
            <input type="text" id="editGoodsUnit" readonly>
        </div>
        <div class="num-row" id="editMultiUnitRow" style="display:none;">
            <div class="form-group"><label>å¤§å•ä½æ•°é‡</label><input type="number" id="editGoodsBigQty"></div>
            <div class="form-group"><label>å°å•ä½æ•°é‡</label><input type="number" id="editGoodsSmallQty"></div>
        </div>
        <div class="form-group" id="editSingleQtyRow">
            <label>å½“å‰æ•°é‡</label>
            <input type="number" id="editGoodsQty">
        </div>
        <div class="form-group">
            <label>å•ä»·</label>
            <input type="number" id="editGoodsPrice" step="0.001">
        </div>
        <div class="form-group">
            <label>é‡‘é¢</label>
            <input type="text" id="editGoodsAmount" readonly>
        </div>
        <div class="form-group">
            <label>å…¥åº“æ—¶é—´</label>
            <input type="date" id="editGoodsTime">
        </div>
        <button class="cancel-btn" id="cancelEditGoods">å–æ¶ˆ</button>
        <button class="delete-btn" id="deleteGoods">åˆ é™¤</button>
        <button class="save-btn" id="saveEditGoods">ä¿å­˜</button>
    </div>
</div>

<!-- å¯æ‹–åŠ¨ç´¯åŠ è¡¨å¼¹çª— -->
<div id="accumulateModal" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:300px;background:#fff;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.3);z-index:1000;overflow:hidden;touch-action:none;">
    <div id="accumulateModalHeader" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:12px 15px;cursor:move;display:flex;align-items:center;justify-content:space-between;touch-action:none;">
        <div style="color:#fff;font-size:16px;font-weight:600;display:flex;align-items:center;gap:8px;">
            <span>ğŸ“‹</span>
            <span>æ•°é‡ç´¯åŠ è¡¨</span>
        </div>
        <div onclick="closeAccumulateModal()" style="color:#fff;font-size:20px;cursor:pointer;width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='transparent'">Ã—</div>
    </div>
    <div style="padding:12px;background:#f8f9fa;">
        <!-- å•ä½æ˜¾ç¤º -->
        <div id="accumulateUnitDisplay" style="text-align:center;margin-bottom:10px;padding:6px;background:#e3f2fd;border-radius:6px;font-size:12px;color:#1976d2;font-weight:500;">
            å•ä½ï¼š-
        </div>
        
        <!-- è¡¨å¤´ -->
        <div style="display:flex;gap:6px;margin-bottom:6px;">
            <div id="accumulateHeaderBig" style="flex:1;text-align:center;font-size:12px;font-weight:bold;color:#666;">å¤§æ•°é‡</div>
            <div id="accumulateHeaderSmall" style="flex:1;text-align:center;font-size:12px;font-weight:bold;color:#666;">å°æ•°é‡</div>
        </div>
        
        <!-- åŠ¨æ€è¡Œè¾“å…¥ -->
        <div id="accumulateRowsModal" style="max-height:180px;overflow-y:auto;-webkit-overflow-scrolling:touch;">
            <!-- åŠ¨æ€ç”Ÿæˆè¡Œ -->
        </div>
        
        <!-- åˆè®¡è¡Œ -->
        <div style="display:flex;gap:6px;margin-top:10px;padding-top:10px;border-top:2px solid #4CAF50;">
            <div style="flex:1;">
                <input type="number" id="accumulateTotalBigModal" readonly style="width:100%;padding:8px;font-size:14px;font-weight:bold;text-align:center;background:#E8F5E9;border:2px solid #4CAF50;border-radius:6px;" placeholder="åˆè®¡">
            </div>
            <div style="flex:1;">
                <input type="number" id="accumulateTotalSmallModal" readonly style="width:100%;padding:8px;font-size:14px;font-weight:bold;text-align:center;background:#E8F5E9;border:2px solid #4CAF50;border-radius:6px;" placeholder="åˆè®¡">
            </div>
        </div>
        
        <!-- æŒ‰é’® -->
        <div style="display:flex;gap:8px;margin-top:10px;">
            <button onclick="clearAccumulateModal()" style="flex:1;padding:8px;background:#ff5252;border:none;border-radius:6px;color:#fff;font-size:13px;font-weight:600;cursor:pointer;">æ¸…ç©º</button>
            <button onclick="confirmAccumulateModal()" style="flex:2;padding:8px;background:#4CAF50;border:none;border-radius:6px;color:#fff;font-size:13px;font-weight:bold;cursor:pointer;">ç¡®è®¤å¡«å…¥</button>
        </div>
    </div>
</div>

<!-- é®ç½©å±‚ - ç‚¹å‡»ä¸å…³é—­ï¼Œé¿å…è¯¯è§¦ -->
<div id="accumulateModalOverlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.3);z-index:999;"></div>

<div class="goods-list-page" id="goodsListPage">
    <div class="goods-list-header"><div class="back-btn" id="backToHomeFromList">â†</div><div class="title">åº“å­˜æ˜ç»†</div></div>
    <div class="goods-search"><input type="text" id="searchGoods" placeholder="æœç´¢å•†å“"></div>
    <div class="goods-table" id="stockDetailTable" style="overflow-x:auto;-webkit-overflow-scrolling:touch;">
        <div id="stockDetailListContainer" style="min-width:100%;"></div>
    </div>
    <div class="pagination"><div class="page-btn">ä¸Šä¸€é¡µ</div><div class="page-btn active">1</div><div class="page-btn">ä¸‹ä¸€é¡µ</div></div>
</div>

<div class="low-stock-page" id="lowStockPage">
    <div class="low-stock-header"><div class="back-btn" id="backToHomeFromLowStock">â†</div><div class="title">ä½åº“å­˜é¢„è­¦</div><div class="close-btn" id="closeLowStockPage">Ã—</div></div>
    <div class="low-stock-list" id="lowStockListContainer"></div>
</div>

<div class="stock-in-warn-page" id="stockInWarnPage" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#f5f5f5;z-index:100;overflow-y:auto;">
    <div class="stock-in-warn-header" style="display:flex;align-items:center;padding:15px;background:#fff;border-bottom:1px solid #e0e0e0;position:sticky;top:0;z-index:10;">
        <div class="back-btn" id="backToHomeFromStockInWarn" style="font-size:20px;margin-right:10px;cursor:pointer;">â†</div>
        <div class="title" style="font-size:18px;font-weight:600;flex:1;text-align:center;">å…¥åº“æ—¶é—´é¢„è­¦å•†å“</div>
        <div class="close-btn" id="closeStockInWarnPage" style="font-size:24px;cursor:pointer;color:#666;">Ã—</div>
    </div>
    <div class="stock-in-warn-list" id="stockInWarnListContainer" style="padding:15px;"></div>
</div>

<div class="type-modal" id="typeModal">
    <div class="modal-content">
        <div class="modal-title">ç®¡ç†å•†å“ç±»å‹</div>
        <div class="add-type-row"><input type="text" id="newTypeName" placeholder="è¾“å…¥ç±»å‹åç§°"><div class="btn black" id="addMainType">æ·»åŠ </div></div>
        <div class="type-list" id="typeList"></div>
        <div class="close-modal" id="closeMainModal">å…³é—­</div>
    </div>
</div>

<div class="type-modal" id="subTypeModal">
    <div class="modal-content">
        <div class="modal-title" id="subModalTitle">æ·»åŠ å­ç±»å‹</div>
        <div class="add-type-row"><input type="text" id="newSubTypeName" placeholder="è¾“å…¥å­ç±»å‹åç§°"><div class="btn black" id="addSubTypeBtn">æ·»åŠ </div></div>
        <div class="close-modal" id="closeSubModal">å…³é—­</div>
    </div>
</div>

<div class="delete-toast" id="deleteToast">æ“ä½œæˆåŠŸ</div>

<!-- é€šç”¨æ¨¡æ€æ¡† -->
<div class="common-modal" id="commonModal" style="display:none;">
    <div class="common-modal-content">
        <div class="common-modal-header">
            <h3 id="commonModalTitle">æ ‡é¢˜</h3>
            <div class="common-modal-close" onclick="closeModal()">&times;</div>
        </div>
        <div class="common-modal-body" id="commonModalBody">
        </div>
    </div>
</div>

<!-- å¯¼å…¥å¯¼å‡ºé¡µé¢ -->
<div class="import-export-page" id="importExportPage" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#f5f5f5;z-index:100;overflow-y:auto;">
    <div class="import-export-header" style="display:flex;align-items:center;padding:15px;background:#fff;border-bottom:1px solid #e0e0e0;position:sticky;top:0;z-index:10;">
        <div class="back-btn" id="closeImportExport" style="font-size:20px;margin-right:10px;cursor:pointer;">â†</div>
        <div class="title" style="font-size:18px;font-weight:600;flex:1;text-align:center;">å¯¼å‡ºWPSæ ¼å¼</div>
        <div style="width:30px;"></div>
    </div>
    
    <div class="import-export-content" style="padding:15px;">
        <!-- å¦‚ä½•å¯¼å…¥æ•°æ®è¯´æ˜ -->
        <div class="import-guide" style="background:#e3f2fd;border:1px solid #2196f3;border-radius:8px;padding:15px;margin-bottom:15px;">
            <div style="font-weight:600;color:#1976d2;margin-bottom:10px;">ğŸ“‹ å¦‚ä½•å¯¼å…¥æ•°æ®ï¼Ÿ</div>
            <div style="font-size:13px;color:#333;line-height:1.8;">
                1. ä»å…¶ä»–æ‰‹æœºå¤åˆ¶"å•†å“æ€»é‡æ˜ç»†"æ•°æ®<br>
                2. ç‚¹å‡»ä¸‹æ–¹"å¯¼å…¥æ•°æ®"æŒ‰é’®<br>
                3. ç¡®è®¤å¯¼å…¥çš„å•†å“åˆ—è¡¨<br>
                4. ç‚¹å‡»"ç¡®è®¤å¯¼å…¥"å®Œæˆ
            </div>
        </div>
        
        <!-- å¯¼å‡ºæŒ‰é’®ç½‘æ ¼ -->
        <div class="export-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px;">
            <!-- ç¬¬ä¸€è¡Œï¼šå•†å“æ€»é‡æ˜ç»†å¯¼å‡ºå’Œå¤åˆ¶ -->
            <div class="export-btn" id="exportGoodsDetail" style="background:#e8f5e9;border:2px solid #4caf50;border-radius:8px;padding:15px;text-align:center;cursor:pointer;">
                <div style="font-size:24px;margin-bottom:5px;">ğŸ“¥</div>
                <div style="font-size:13px;color:#2e7d32;font-weight:600;">å¯¼å‡ºå•†å“æ€»é‡æ˜ç»†</div>
            </div>
            <div class="export-btn" id="copyGoodsDetail" style="background:#e8f5e9;border:2px solid #4caf50;border-radius:8px;padding:15px;text-align:center;cursor:pointer;">
                <div style="font-size:24px;margin-bottom:5px;">ğŸ“‹</div>
                <div style="font-size:13px;color:#2e7d32;font-weight:600;">å¤åˆ¶å•†å“æ€»é‡æ˜ç»†</div>
            </div>
            <!-- ç¬¬äºŒè¡Œï¼šä½åº“å­˜é¢„è­¦å¯¼å‡ºå’Œå¤åˆ¶ -->
            <div class="export-btn" id="exportLowStock" style="background:#ffebee;border:2px solid #f44336;border-radius:8px;padding:15px;text-align:center;cursor:pointer;">
                <div style="font-size:24px;margin-bottom:5px;">âš ï¸</div>
                <div style="font-size:13px;color:#c62828;font-weight:600;">å¯¼å‡ºä½åº“å­˜é¢„è­¦æ˜ç»†</div>
            </div>
            <div class="export-btn" id="copyLowStock" style="background:#ffebee;border:2px solid #f44336;border-radius:8px;padding:15px;text-align:center;cursor:pointer;">
                <div style="font-size:24px;margin-bottom:5px;">ğŸ“‹</div>
                <div style="font-size:13px;color:#c62828;font-weight:600;">å¤åˆ¶ä½åº“å­˜é¢„è­¦æ˜ç»†</div>
            </div>
            <!-- ç¬¬ä¸‰è¡Œï¼šå…¥åº“æ—¶é—´é¢„è­¦å¯¼å‡ºå’Œå¤åˆ¶ -->
            <div class="export-btn" id="exportStockInWarn" style="background:#fff3e0;border:2px solid #ff9800;border-radius:8px;padding:15px;text-align:center;cursor:pointer;">
                <div style="font-size:24px;margin-bottom:5px;">â°</div>
                <div style="font-size:13px;color:#ef6c00;font-weight:600;">å¯¼å‡ºå…¥åº“æ—¶é—´é¢„è­¦æ˜ç»†</div>
            </div>
            <div class="export-btn" id="copyStockInWarn" style="background:#fff3e0;border:2px solid #ff9800;border-radius:8px;padding:15px;text-align:center;cursor:pointer;">
                <div style="font-size:24px;margin-bottom:5px;">ğŸ“‹</div>
                <div style="font-size:13px;color:#ef6c00;font-weight:600;">å¤åˆ¶å…¥åº“æ—¶é—´é¢„è­¦æ˜ç»†</div>
            </div>
            <!-- ç¬¬å››è¡Œï¼šå…¶ä»–å¯¼å‡ºåŠŸèƒ½ -->
            <div class="export-btn" id="copyAllGoods" style="background:#f3e5f5;border:2px solid #9c27b0;border-radius:8px;padding:15px;text-align:center;cursor:pointer;">
                <div style="font-size:24px;margin-bottom:5px;">ğŸ“‹</div>
                <div style="font-size:13px;color:#6a1b9a;font-weight:600;">å¤åˆ¶å•†å“æ‰€æœ‰æ€»é‡æ˜ç»†</div>
            </div>
            <div class="export-btn" id="exportSubTypes" style="background:#e0f2f1;border:2px solid #009688;border-radius:8px;padding:15px;text-align:center;cursor:pointer;">
                <div style="font-size:24px;margin-bottom:5px;">ğŸŒ²</div>
                <div style="font-size:13px;color:#00695c;font-weight:600;">å­ç±»å‹å¯¼å‡º</div>
            </div>
            <!-- ç¬¬äº”è¡Œï¼šç±»å‹å¯¼å‡ºå¯¼å…¥ -->
            <div class="export-btn" id="exportTypes" style="background:#e8eaf6;border:2px solid #3f51b5;border-radius:8px;padding:15px;text-align:center;cursor:pointer;">
                <div style="font-size:24px;margin-bottom:5px;">ğŸ“</div>
                <div style="font-size:13px;color:#283593;font-weight:600;">ç±»å‹å¯¼å‡º</div>
            </div>
            <div class="export-btn" id="importTypes" style="background:#fce4ec;border:2px solid #e91e63;border-radius:8px;padding:15px;text-align:center;cursor:pointer;">
                <div style="font-size:24px;margin-bottom:5px;">ğŸ“¤</div>
                <div style="font-size:13px;color:#ad1457;font-weight:600;">ç±»å‹å¯¼å…¥</div>
            </div>
        </div>
        
        <!-- å¯¼å‡ºæ ¼å¼è®¾ç½® -->
        <div class="export-format-setting" style="background:#f5f5f5;border:2px solid #666;border-radius:8px;padding:15px;margin-bottom:15px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <span style="font-weight:600;">å¯¼å‡ºæ ¼å¼</span>
                <span style="color:#4CAF50;font-weight:600;" id="currentExportFormatDisplay">Excelè¡¨æ ¼ (.xls)</span>
            </div>
            <div class="set-export-format-btn" id="setExportFormatBtn" style="background:#e8eaf6;border:2px solid #3f51b5;border-radius:6px;padding:10px;text-align:center;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:5px;" onclick="showExportFormatDialog()">
                <span>âš™ï¸</span>
                <span style="color:#283593;font-weight:600;">è®¾ç½®å¯¼å‡ºæ ¼å¼</span>
            </div>
        </div>
        
        <!-- å¯¼å…¥æ•°æ®æŒ‰é’® -->
        <div class="import-btn" id="importDataBtn" style="background:#1976d2;color:#fff;border-radius:8px;padding:15px;text-align:center;cursor:pointer;margin-bottom:15px;font-weight:600;">
            ğŸ“¥ å¯¼å…¥æ•°æ®
        </div>
        <input type="file" id="importDataFile" accept=".json" style="display:none;">
        <input type="file" id="importTypeFile" accept=".json" style="display:none;">
        
        <!-- å‘é€åˆ°å…¶ä»–æ‰‹æœºè¯´æ˜ -->
        <div class="send-guide" style="background:#fff3e0;border:1px solid #ff9800;border-radius:8px;padding:15px;margin-bottom:15px;">
            <div style="font-weight:600;color:#e65100;margin-bottom:10px;">ğŸ“± å¦‚ä½•å‘é€åˆ°å…¶ä»–æ‰‹æœºï¼Ÿ</div>
            <div style="font-size:13px;color:#333;line-height:1.8;">
                ç‚¹å‡»"å¤åˆ¶"æŒ‰é’®åï¼Œæ‰“å¼€å¾®ä¿¡ã€QQç­‰èŠå¤©è½¯ä»¶ï¼Œé•¿æŒ‰è¾“å…¥æ¡†ç²˜è´´ï¼Œå³å¯å‘é€ç»™å…¶ä»–æ‰‹æœºæŸ¥çœ‹ã€‚
            </div>
        </div>
        
        <!-- é¢„è­¦æ—¥æœŸé˜ˆå€¼ -->
        <div class="warn-days-setting" style="background:#fff;border:2px solid #000;border-radius:8px;padding:15px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <span style="font-weight:600;">é¢„è­¦æ—¥æœŸé˜ˆå€¼</span>
                <span style="color:#f57c00;font-weight:600;" id="warnDaysDisplay">90å¤©</span>
            </div>
            <div class="set-warn-btn" id="setWarnDaysBtn" style="background:#fff3e0;border:2px solid #ff9800;border-radius:6px;padding:10px;text-align:center;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:5px;">
                <span>âš™ï¸</span>
                <span style="color:#e65100;font-weight:600;">è®¾ç½®é¢„è­¦æ—¥æœŸ</span>
            </div>
        </div>
    </div>
</div>
<script>
const $ = id => document.getElementById(id) || { style: {}, value: '' };
let currentMainType = '';

// ä¸»ç±»å‹æ’åºé¡ºåº
const mainTypeOrder = ['åŸææ–™', 'åŠæˆå“', 'æˆå“', 'åŒ…è£…ææ–™', 'è¾…æ–™', 'å…¶ä»–'];

// é€šç”¨æ¨¡æ€æ¡†å‡½æ•°
function showModal(title, content) {
    const modal = $('commonModal');
    const modalTitle = $('commonModalTitle');
    const modalBody = $('commonModalBody');
    
    if (modalTitle) modalTitle.textContent = title;
    if (modalBody) modalBody.innerHTML = content;
    if (modal) {
        modal.style.display = 'flex';
        // ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€æ¡†
        modal.onclick = (e) => {
            if (e.target === modal) {
                closeModal();
            }
        };
    }
}

function closeModal() {
    const modal = $('commonModal');
    if (modal) modal.style.display = 'none';
}

// é€šç”¨æ’åºå‡½æ•°ï¼šæŒ‰ä¸»ç±»å‹ -> å­ç±»å‹ -> å•†å“åç§° æ’åº
function sortGoodsList(list) {
  return list.sort((a, b) => {
    // 1. å…ˆæŒ‰ä¸»ç±»å‹æ’åº
    const aMainIndex = mainTypeOrder.indexOf(a.mainType);
    const bMainIndex = mainTypeOrder.indexOf(b.mainType);
    const aMainOrder = aMainIndex === -1 ? 999 : aMainIndex;
    const bMainOrder = bMainIndex === -1 ? 999 : bMainIndex;
    if (aMainOrder !== bMainOrder) {
      return aMainOrder - bMainOrder;
    }
    // 2. å†æŒ‰å­ç±»å‹æ’åº
    const subTypeCompare = (a.subType || '').localeCompare(b.subType || '', 'zh-CN');
    if (subTypeCompare !== 0) {
      return subTypeCompare;
    }
    // 3. æœ€åæŒ‰å•†å“åç§°æ’åº
    return (a.name || '').localeCompare(b.name || '', 'zh-CN');
  });
}

// ==================== äº‘åŒæ­¥é…ç½® ====================
// åç«¯APIåœ°å€ï¼Œéƒ¨ç½²åéœ€è¦ä¿®æ”¹ä¸ºå®é™…çš„Vercelåœ°å€
// æœ¬åœ°æµ‹è¯•æ—¶å¯ä»¥ä½¿ç”¨: http://localhost:3000/api
const API_BASE = 'https://warehouse-hixd27gpo-dongs-projects-7faae8a3.vercel.app/api';

// æ˜¯å¦å¯ç”¨äº‘ç«¯åŒæ­¥ï¼ˆ false æ—¶ä½¿ç”¨æœ¬åœ°æ¨¡å¼ ï¼‰
const ENABLE_CLOUD_SYNC = true;

// æ˜¯å¦ä½¿ç”¨å…¬å…±æ•°æ®æ¨¡å¼ï¼ˆ true = æ— éœ€ç™»å½•ï¼Œæ‰€æœ‰ç”¨æˆ·å…±äº«æ•°æ® ï¼‰
const PUBLIC_DATA_MODE = true;

// ç™»å½•çŠ¶æ€
let authToken = localStorage.getItem('warehouse_token');
let currentUser = localStorage.getItem('warehouse_user');
let isSyncing = false;
let isLocalMode = !ENABLE_CLOUD_SYNC;

// æ˜¾ç¤ºç™»å½•é¡µé¢
function showLoginPage() {
    $('loginPage').style.display = 'block';
    $('registerPage').style.display = 'none';
    $('homePage').style.display = 'none';
}

// æ˜¾ç¤ºæ³¨å†Œé¡µé¢
function showRegisterPage() {
    $('loginPage').style.display = 'none';
    $('registerPage').style.display = 'block';
}

// éšè—ç™»å½•/æ³¨å†Œé¡µé¢ï¼Œæ˜¾ç¤ºä¸»é¡µé¢
function hideAuthPages() {
    $('loginPage').style.display = 'none';
    $('registerPage').style.display = 'none';
    $('homePage').style.display = 'block';
}

// æ˜¾ç¤ºåŒæ­¥çŠ¶æ€
function showSyncStatus(message, isError = false) {
    const status = $('syncStatus');
    status.textContent = message;
    status.style.background = isError ? '#e53935' : '#4caf50';
    status.style.display = 'block';
    setTimeout(() => {
        status.style.display = 'none';
    }, 2000);
}

// ç™»å½•
async function doLogin() {
    const username = $('loginUsername').value.trim();
    const password = $('loginPassword').value;
    
    if (!username || !password) {
        $('loginError').textContent = 'è¯·è¾“å…¥è´¦å·å’Œå¯†ç ';
        $('loginError').style.display = 'block';
        return;
    }
    
    // æœ¬åœ°æ¨¡å¼ï¼šç›´æ¥ç™»å½•
    if (isLocalMode) {
        currentUser = username;
        localStorage.setItem('warehouse_user', currentUser);
        
        // é‡æ–°åŠ è½½å½“å‰ç”¨æˆ·çš„æ•°æ®
        loadData();
        
        $('loginError').style.display = 'none';
        hideAuthPages();
        init();
        showSyncStatus('æœ¬åœ°ç™»å½•æˆåŠŸ');
        return;
    }
    
    try {
        const res = await fetch(`${API_BASE}/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        
        const result = await res.json();
        
        if (res.ok && result.success) {
            authToken = result.token;
            currentUser = username;
            localStorage.setItem('warehouse_token', authToken);
            localStorage.setItem('warehouse_user', currentUser);
            
            // åŠ è½½äº‘ç«¯æ•°æ®
            if (result.data) {
                if (result.data.typeData) typeData = result.data.typeData;
                if (result.data.goodsList) goodsList = result.data.goodsList;
                saveData();
            }
            
            $('loginError').style.display = 'none';
            hideAuthPages();
            init();
            showSyncStatus('ç™»å½•æˆåŠŸ');
        } else {
            $('loginError').textContent = result.error || 'ç™»å½•å¤±è´¥';
            $('loginError').style.display = 'block';
        }
    } catch (error) {
        $('loginError').textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
        $('loginError').style.display = 'block';
        console.error('Login error:', error);
    }
}

// æ³¨å†Œ
async function doRegister() {
    const username = $('regUsername').value.trim();
    const password = $('regPassword').value;
    const password2 = $('regPassword2').value;

    if (!username || !password) {
        $('regError').textContent = 'è¯·è¾“å…¥è´¦å·å’Œå¯†ç ';
        $('regError').style.display = 'block';
        return;
    }

    if (password !== password2) {
        $('regError').textContent = 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´';
        $('regError').style.display = 'block';
        return;
    }

    // æœ¬åœ°æ¨¡å¼ï¼šç›´æ¥æ³¨å†Œ
    if (isLocalMode) {
        currentUser = username;
        localStorage.setItem('warehouse_user', currentUser);
        
        // é‡æ–°åŠ è½½å½“å‰ç”¨æˆ·çš„æ•°æ®ï¼ˆæ–°ç”¨æˆ·ä¼šåˆ›å»ºç©ºæ•°æ®ï¼‰
        loadData();
        
        $('regError').style.display = 'none';
        hideAuthPages();
        init();
        showSyncStatus('æœ¬åœ°æ³¨å†ŒæˆåŠŸ');
        return;
    }

    try {
        const res = await fetch(`${API_BASE}/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });

        const result = await res.json();

        if (res.ok && result.success) {
            authToken = result.token;
            currentUser = username;
            localStorage.setItem('warehouse_token', authToken);
            localStorage.setItem('warehouse_user', currentUser);

            $('regError').style.display = 'none';
            hideAuthPages();
            init();
            showSyncStatus('æ³¨å†ŒæˆåŠŸ');
        } else {
            $('regError').textContent = result.error || 'æ³¨å†Œå¤±è´¥';
            $('regError').style.display = 'block';
        }
    } catch (error) {
        $('regError').textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
        $('regError').style.display = 'block';
        console.error('Register error:', error);
    }
}

// åŒæ­¥æ•°æ®åˆ°äº‘ç«¯
async function syncToCloud() {
    if (isLocalMode && !PUBLIC_DATA_MODE) return; // æœ¬åœ°æ¨¡å¼ä¸”éå…¬å…±æ¨¡å¼æ—¶ä¸åŒæ­¥
    if (!PUBLIC_DATA_MODE && !authToken) return; // éå…¬å…±æ¨¡å¼éœ€è¦ç™»å½•
    if (isSyncing) return;

    isSyncing = true;
    try {
        const data = {
            typeData,
            goodsList
        };

        // å…¬å…±æ•°æ®æ¨¡å¼ä¸éœ€è¦è®¤è¯å¤´
        const headers = {
            'Content-Type': 'application/json'
        };
        if (!PUBLIC_DATA_MODE) {
            headers['Authorization'] = `Bearer ${authToken}`;
        }

        const res = await fetch(`${API_BASE}/sync`, {
            method: 'POST',
            headers,
            body: JSON.stringify({ data })
        });

        if (res.ok) {
            console.log('Sync to cloud success');
        } else {
            console.error('Sync to cloud failed');
        }
    } catch (error) {
        console.error('Sync error:', error);
    } finally {
        isSyncing = false;
    }
}

// æœ¬åœ°æ¨¡å¼ï¼šå¼ºåˆ¶åˆ·æ–°æ•°æ®ï¼ˆä»localStorageé‡æ–°åŠ è½½ï¼‰
function refreshDataFromStorage() {
    if (!isLocalMode) return;
    
    const typeDataKey = getStorageKey('typeData');
    const goodsListKey = getStorageKey('goodsList');
    
    const newTypeData = JSON.parse(localStorage.getItem(typeDataKey));
    const newGoodsList = JSON.parse(localStorage.getItem(goodsListKey));
    
    // æ£€æŸ¥æ•°æ®æ˜¯å¦æœ‰å˜åŒ–
    let hasChanged = false;
    
    if (newTypeData && JSON.stringify(newTypeData) !== JSON.stringify(typeData)) {
        typeData = newTypeData;
        hasChanged = true;
    }
    
    if (newGoodsList && JSON.stringify(newGoodsList) !== JSON.stringify(goodsList)) {
        goodsList = newGoodsList;
        hasChanged = true;
    }
    
    // å¦‚æœæœ‰å˜åŒ–ï¼Œåˆ·æ–°é¡µé¢æ˜¾ç¤º
    if (hasChanged) {
        renderHomeTabs();
        renderGoodsList();
        updateImportExportStats();
        console.log('æ•°æ®å·²åŒæ­¥æ›´æ–°');
    }
}

// ä»äº‘ç«¯è·å–æ•°æ®
async function syncFromCloud() {
    if (isLocalMode && !PUBLIC_DATA_MODE) return; // æœ¬åœ°æ¨¡å¼ä¸”éå…¬å…±æ¨¡å¼æ—¶ä¸åŒæ­¥

    try {
        // å…¬å…±æ•°æ®æ¨¡å¼ä¸éœ€è¦è®¤è¯
        const headers = PUBLIC_DATA_MODE ? {} : { 'Authorization': `Bearer ${authToken}` };
        
        const res = await fetch(`${API_BASE}/data`, {
            headers
        });

        if (res.ok) {
            const result = await res.json();
            if (result.data) {
                if (result.data.typeData) typeData = result.data.typeData;
                if (result.data.goodsList) goodsList = result.data.goodsList;
                saveData();
                renderGoodsList();
                renderHomeTabs();
                showSyncStatus('æ•°æ®å·²åŒæ­¥');
            }
        }
    } catch (error) {
        console.error('Sync from cloud error:', error);
    }
}

// é€€å‡ºç™»å½•
function logout() {
    if (PUBLIC_DATA_MODE) {
        // å…¬å…±æ•°æ®æ¨¡å¼ï¼šåˆ·æ–°é¡µé¢é‡æ–°åŠ è½½æ•°æ®
        window.location.reload();
        return;
    }
    authToken = null;
    currentUser = null;
    localStorage.removeItem('warehouse_token');
    localStorage.removeItem('warehouse_user');
    showLoginPage();
    // åˆ·æ–°é¡µé¢ç¡®ä¿çŠ¶æ€å®Œå…¨é‡ç½®
    window.location.reload();
}

// ==================== åŸæœ‰ä»£ç  ====================

// åŠ è½½æ•°æ®çš„å‡½æ•°
function loadData() {
  const typeDataKey = getStorageKey('typeData');
  const goodsListKey = getStorageKey('goodsList');
  
  typeData = JSON.parse(localStorage.getItem(typeDataKey)) || {
    mainTypes: ['åŸææ–™','åŠæˆå“','æˆå“','åŒ…è£…ææ–™','è¾…æ–™','å…¶ä»–'],
    subTypes: {åŸææ–™:[],åŠæˆå“:[],æˆå“:[],åŒ…è£…ææ–™:[],è¾…æ–™:[],å…¶ä»–:[]}
  };
  
  goodsList = JSON.parse(localStorage.getItem(goodsListKey)) || [];
}

// åˆå§‹åŒ–æ—¶åŠ è½½æ•°æ®
loadData();

// è§£æå•ä½æ–‡æœ¬ï¼Œå–å‡ºå¤§ã€å°å•ä½
function parseBigSmallUnit(unitText) {
  if (!unitText || unitText === 'ç‚¹å‡»âš™ï¸è®¾ç½®') return { big: '', small: '' };
  const match = unitText.match(/^(.+)\(\d+(.+)\)$/);
  if (match) {
    return { big: match[1], small: match[2] };
  }
  return { big: '', small: '' };
}

// è§£æå•ä½æ¢ç®—ï¼Œè¿”å›å¤§å•ä½ã€å°å•ä½å’Œæ¢ç®—æ¯”ä¾‹
function parseBigSmallUnitWithRate(unitText) {
  if (!unitText || unitText === 'ç‚¹å‡»âš™ï¸è®¾ç½®') return { big: '', small: '', rate: 1 };
  const match = unitText.match(/^(.+)\((\d+)(.+)\)$/);
  if (match) {
    return { big: match[1], small: match[3], rate: parseInt(match[2]) || 1 };
  }
  return { big: '', small: '', rate: 1 };
}

// æœç´¢é€‰æ‹©æ¡†é€šç”¨é€»è¾‘
function initSearchSelect(inputId, dropdownId, onSelect) {
  const input = $(inputId);
  const dropdown = $(dropdownId);
  if (!input || !dropdown) return;

  input.oninput = function() {
    const keyword = (this.value || '').trim().toLowerCase();
    if (!keyword) {
      dropdown.style.display = 'none';
      return;
    }
    const matches = goodsList.filter(g => 
      g.name && g.name.toLowerCase().includes(keyword)
    );
    dropdown.innerHTML = '';
    if (matches.length === 0) {
      dropdown.style.display = 'none';
      return;
    }
    matches.forEach(g => {
      const div = document.createElement('div');
      div.className = 'search-select-item';
      div.textContent = g.name;
      div.onmousedown = (e) => {
        e.preventDefault();
        input.value = g.name;
        dropdown.style.display = 'none';
        onSelect(g);
      };
      dropdown.appendChild(div);
    });
    dropdown.style.display = 'block';
  };

  input.onblur = () => {
    setTimeout(() => { dropdown.style.display = 'none'; }, 200);
  };
  input.onfocus = () => {
    if ((input.value || '').trim()) input.oninput();
  };
}

// å…¥åº“é€‰æ‹©å•†å“
initSearchSelect('stockInSearchGoods', 'stockInGoodsDropdown', (item) => {
  console.log('å…¥åº“é€‰æ‹©å•†å“:', item);
  console.log('unitText:', item.unitText);
  const hasConvert = item.unitText && item.unitText.trim() !== '' && item.unitText.trim() !== 'ç‚¹å‡»âš™ï¸è®¾ç½®' && item.unitText.includes('(');
  console.log('hasConvert:', hasConvert);

  // è‡ªåŠ¨å¡«å†™ç±»å‹å’Œå­ç±»å‹
  $('stockInGoodsType').value = item.mainType || '';
  // æ›´æ–°å­ç±»å‹ä¸‹æ‹‰æ¡†
  const subTypeSelect = $('stockInGoodsSubType');
  subTypeSelect.innerHTML = '';
  const subList = typeData.subTypes[item.mainType] || [];
  subList.forEach(sub => {
    const opt = document.createElement('option');
    opt.value = sub;
    opt.textContent = sub;
    if (sub === item.subType) opt.selected = true;
    subTypeSelect.appendChild(opt);
  });

  // è‡ªåŠ¨å¡«å†™å•†å“è§„æ ¼
  $('stockInSpec').value = item.spec || '';

  if (hasConvert) {
    $('stockInSingleRow').style.display = 'none';
    $('stockInMultiRow').style.display = 'flex';
    const { big, small } = parseBigSmallUnit(item.unitText);
    console.log('big:', big, 'small:', small);
    $('stockInUnit').value = `${big}/${small}`;
    $('stockInBigUnit').textContent = big;
    $('stockInSmallUnit').textContent = small;
  } else {
    $('stockInSingleRow').style.display = 'block';
    $('stockInMultiRow').style.display = 'none';
    $('stockInUnit').value = item.singleUnit || '';
  }

  $('stockInPrice').value = item.price || '';
  calcIn();
});

// å‡ºåº“é€‰æ‹©å•†å“
initSearchSelect('stockOutSearchGoods', 'stockOutGoodsDropdown', (item) => {
  const hasConvert = item.unitText && item.unitText.trim() !== '' && item.unitText.trim() !== 'ç‚¹å‡»âš™ï¸è®¾ç½®' && item.unitText.includes('(');

  // è‡ªåŠ¨å¡«å†™ç±»å‹å’Œå­ç±»å‹
  $('stockOutGoodsType').value = item.mainType || '';
  // æ›´æ–°å­ç±»å‹ä¸‹æ‹‰æ¡†
  const subTypeSelect = $('stockOutGoodsSubType');
  subTypeSelect.innerHTML = '';
  const subList = typeData.subTypes[item.mainType] || [];
  subList.forEach(sub => {
    const opt = document.createElement('option');
    opt.value = sub;
    opt.textContent = sub;
    if (sub === item.subType) opt.selected = true;
    subTypeSelect.appendChild(opt);
  });

  // è‡ªåŠ¨å¡«å†™å•†å“è§„æ ¼
  $('stockOutSpec').value = item.spec || '';

  if (hasConvert) {
    $('stockOutSingleRow').style.display = 'none';
    $('stockOutMultiRow').style.display = 'flex';
    const { big, small } = parseBigSmallUnit(item.unitText);
    $('stockOutUnit').value = `${big}/${small}`;
    $('stockOutBigUnit').textContent = big;
    $('stockOutSmallUnit').textContent = small;
  } else {
    $('stockOutSingleRow').style.display = 'block';
    $('stockOutMultiRow').style.display = 'none';
    $('stockOutUnit').value = item.singleUnit || '';
  }

  $('stockOutPrice').value = item.price || '';
  calcOut();
});

// ç›˜ç‚¹è®¡ç®—å·®å¼‚
function calcCheckDiff() {
  const name = ($('stockCheckSearchGoods').value || '').trim();
  const item = goodsList.find(g => g.name === name);
  if (!item) return;

  const hasConvert = item.unitText && item.unitText.trim() !== '' && item.unitText.trim() !== 'ç‚¹å‡»âš™ï¸è®¾ç½®' && item.unitText.includes('(');
  const rate = item.unitRate || 1;

  let bookQty, realQty;
  if (hasConvert) {
    bookQty = (+$('checkBook1').value || 0) * rate + (+$('checkBook2').value || 0);
    realQty = (+$('checkReal1').value || 0) * rate + (+$('checkReal2').value || 0);
  } else {
    bookQty = +$('checkBookSingle').value || 0;
    realQty = +$('checkRealSingle').value || 0;
  }

  const diff = realQty - bookQty;
  $('checkDiff').value = diff > 0 ? `+${diff}` : diff;
}

// ç¡®è®¤ç›˜ç‚¹æ•°é‡ï¼ˆåŒæ­¥åˆ°å®ç›˜æ•°é‡è¾“å…¥æ¡†ï¼‰- ä¿ç•™å‡½æ•°ä½†ä½¿ç”¨ç´¯åŠ è¡¨æ ¼
function confirmCheckQty() {
  // è°ƒç”¨æ–°çš„ç´¯åŠ è¡¨æ ¼ç¡®è®¤å‡½æ•°
  confirmAccumulateToReal();
}

// ç´¯åŠ è¡¨æ ¼å½“å‰æ˜¯å¦ä¸ºå•ä½æ¢ç®—æ¨¡å¼
let accumulateTableHasConvert = false;
let accumulateTableRate = 1;
let accumulateBigUnit = 'å¤§';
let accumulateSmallUnit = 'å°';

// åˆå§‹åŒ–ç´¯åŠ è¡¨æ ¼
function initAccumulateTable(hasConvert) {
  accumulateTableHasConvert = hasConvert;
  const container = $('accumulateRows');
  if (!container) return;

  // æ¸…ç©ºç°æœ‰å†…å®¹
  container.innerHTML = '';

  // è·å–å•ä½ä¿¡æ¯
  accumulateBigUnit = 'å¤§';
  accumulateSmallUnit = 'å°';
  if (hasConvert) {
    const name = ($('stockCheckSearchGoods').value || '').trim();
    const item = goodsList.find(g => g.name === name);
    if (item) {
      const parsed = parseBigSmallUnitWithRate(item.unitText);
      accumulateBigUnit = parsed.big || 'å¤§';
      accumulateSmallUnit = parsed.small || 'å°';
      accumulateTableRate = parsed.rate || 1;
    }
  }

  // åˆå§‹ç”Ÿæˆ3è¡Œ
  for (let i = 0; i < 3; i++) {
    addAccumulateRow(i);
  }

  // æ¸…ç©ºåˆè®¡
  $('accumulateTotalBig').value = '';
  $('accumulateTotalSmall').value = '';
}

// æ·»åŠ ç´¯åŠ è¡¨æ ¼è¡Œ
function addAccumulateRow(rowIndex) {
  const container = $('accumulateRows');
  if (!container) return;

  const row = document.createElement('div');
  row.className = 'accumulate-row';
  row.style.cssText = 'display:flex;gap:8px;margin-bottom:8px;';
  row.dataset.rowIndex = rowIndex;

  if (accumulateTableHasConvert) {
    // å•ä½æ¢ç®—æ¨¡å¼ï¼šå¤§æ•°é‡ + å°æ•°é‡
    row.innerHTML = `
      <div style="flex:1;">
        <input type="number" class="accumulate-big" data-row="${rowIndex}" placeholder="${accumulateBigUnit}" 
          style="width:100%;padding:10px;font-size:15px;text-align:center;border:2px solid #ccc;border-radius:6px;height:42px;box-sizing:border-box;"
          oninput="onAccumulateInput(this, ${rowIndex}, 'big')"
          onkeydown="onAccumulateKeydown(event, ${rowIndex}, 'big')">
      </div>
      <div style="flex:1;">
        <input type="number" class="accumulate-small" data-row="${rowIndex}" placeholder="${accumulateSmallUnit}" 
          style="width:100%;padding:10px;font-size:15px;text-align:center;border:2px solid #ccc;border-radius:6px;height:42px;box-sizing:border-box;"
          oninput="onAccumulateInput(this, ${rowIndex}, 'small')"
          onkeydown="onAccumulateKeydown(event, ${rowIndex}, 'small')">
      </div>
    `;
  } else {
    // å•ä¸ªå•ä½æ¨¡å¼ï¼šåªæœ‰æ•°é‡åˆ—
    row.innerHTML = `
      <div style="flex:1;">
        <input type="number" class="accumulate-qty" data-row="${rowIndex}" placeholder="æ•°é‡" 
          style="width:100%;padding:10px;font-size:15px;text-align:center;border:2px solid #ccc;border-radius:6px;height:42px;box-sizing:border-box;"
          oninput="onAccumulateInput(this, ${rowIndex}, 'qty')"
          onkeydown="onAccumulateKeydown(event, ${rowIndex}, 'qty')">
      </div>
      <div style="flex:1;">
        <input type="text" disabled placeholder="-" 
          style="width:100%;padding:10px;font-size:15px;text-align:center;border:2px solid #ddd;border-radius:6px;background:#eee;height:42px;box-sizing:border-box;" readonly>
      </div>
    `;
  }
  container.appendChild(row);
}

// ç´¯åŠ è¡¨æ ¼è¾“å…¥å¤„ç†
function onAccumulateInput(input, rowIndex, type) {
  // ç«‹å³è®¡ç®—åˆè®¡
  calcAccumulateTotal();

  // æ£€æŸ¥æ˜¯å¦æ˜¯æœ€åä¸€è¡Œï¼Œä¸”æœ‰å€¼è¾“å…¥ï¼Œåˆ™ç«‹å³è‡ªåŠ¨æ·»åŠ æ–°è¡Œ
  const container = $('accumulateRows');
  const allRows = container.querySelectorAll('.accumulate-row');
  const isLastRow = rowIndex === allRows.length - 1;

  // æœ€åä¸€è¡Œæœ‰è¾“å…¥æ—¶ç«‹å³æ·»åŠ æ–°è¡Œï¼ˆæ— å»¶è¿Ÿï¼‰
  if (isLastRow && input.value !== '') {
    addAccumulateRow(rowIndex + 1);
  }
}

// ç´¯åŠ è¡¨æ ¼é”®ç›˜å¤„ç†
function onAccumulateKeydown(event, rowIndex, type) {
  // æŒ‰Enteré”®è·³åˆ°ä¸‹ä¸€è¡Œ
  if (event.key === 'Enter') {
    event.preventDefault();
    const container = $('accumulateRows');
    const allRows = container.querySelectorAll('.accumulate-row');

    if (accumulateTableHasConvert) {
      // å•ä½æ¢ç®—æ¨¡å¼
      if (type === 'big') {
        // åœ¨å¤§æ•°é‡æ¡†æŒ‰Enterï¼Œè·³åˆ°å°æ•°é‡æ¡†
        const smallInput = allRows[rowIndex].querySelector('.accumulate-small');
        if (smallInput) smallInput.focus();
      } else {
        // åœ¨å°æ•°é‡æ¡†æŒ‰Enterï¼Œè·³åˆ°ä¸‹ä¸€è¡Œçš„å¤§æ•°é‡æ¡†
        if (rowIndex + 1 < allRows.length) {
          const nextBigInput = allRows[rowIndex + 1].querySelector('.accumulate-big');
          if (nextBigInput) nextBigInput.focus();
        }
      }
    } else {
      // å•ä¸ªå•ä½æ¨¡å¼ï¼Œè·³åˆ°ä¸‹ä¸€è¡Œ
      if (rowIndex + 1 < allRows.length) {
        const nextQtyInput = allRows[rowIndex + 1].querySelector('.accumulate-qty');
        if (nextQtyInput) nextQtyInput.focus();
      }
    }
  }
}

// è®¡ç®—ç´¯åŠ è¡¨æ ¼åˆè®¡ - ä¼˜åŒ–ç‰ˆæœ¬ï¼Œç¼“å­˜DOMå¼•ç”¨
let cachedAccumulateRows = null;
let cachedTotalBigInput = null;
let cachedTotalSmallInput = null;

function calcAccumulateTotal() {
  // ç¼“å­˜DOMå¼•ç”¨ï¼ˆé¦–æ¬¡è°ƒç”¨æ—¶ï¼‰
  if (!cachedTotalBigInput) cachedTotalBigInput = $('accumulateTotalBig');
  if (!cachedTotalSmallInput) cachedTotalSmallInput = $('accumulateTotalSmall');

  let totalBig = 0;
  let totalSmall = 0;
  let totalRawSmall = 0;

  if (accumulateTableHasConvert) {
    // å•ä½æ¢ç®—æ¨¡å¼ - ä½¿ç”¨ç¼“å­˜çš„è¡Œå¼•ç”¨
    const container = $('accumulateRows');
    const rows = container.getElementsByClassName('accumulate-row');

    for (let i = 0; i < rows.length; i++) {
      const row = rows[i];
      const bigInput = row.getElementsByClassName('accumulate-big')[0];
      const smallInput = row.getElementsByClassName('accumulate-small')[0];

      // ä½¿ç”¨ä½è¿ç®—å¿«é€Ÿè½¬æ¢ä¸ºæ•°å­—ï¼ˆæ¯”parseFloatå¿«ï¼‰
      const bigVal = (+bigInput?.value) || 0;
      const smallVal = (+smallInput?.value) || 0;

      totalBig += bigVal;
      totalRawSmall += smallVal;
    }

    // è®¡ç®—å°å•ä½è¿›ä½
    const smallCarry = (totalRawSmall / accumulateTableRate) | 0; // ä½è¿ç®—å–æ•´ï¼Œæ¯”Math.floorå¿«
    const remainingSmall = totalRawSmall % accumulateTableRate;

    totalBig += smallCarry;
    totalSmall = remainingSmall;

    // ç›´æ¥è®¾ç½®å€¼ï¼Œé¿å…å‡½æ•°è°ƒç”¨å¼€é”€
    cachedTotalBigInput.value = totalBig > 0 ? totalBig : '';
    cachedTotalSmallInput.value = totalSmall > 0 ? totalSmall : '';
  } else {
    // å•ä¸ªå•ä½æ¨¡å¼
    const qtyInputs = document.getElementsByClassName('accumulate-qty');
    let total = 0;
    for (let i = 0; i < qtyInputs.length; i++) {
      total += (+qtyInputs[i].value) || 0;
    }
    cachedTotalBigInput.value = total > 0 ? total : '';
    cachedTotalSmallInput.value = '';
  }
}

// æ¸…ç©ºç´¯åŠ è¡¨æ ¼
function clearAccumulateTable() {
  const container = $('accumulateRows');
  if (container) {
    container.innerHTML = '';
    // é‡æ–°ç”Ÿæˆ3è¡Œ
    for (let i = 0; i < 3; i++) {
      addAccumulateRow(i);
    }
  }
  $('accumulateTotalBig').value = '';
  $('accumulateTotalSmall').value = '';
  showSyncStatus('ç´¯åŠ è¡¨æ ¼å·²æ¸…ç©º');
}

// ç¡®è®¤å¡«å…¥ç´¯åŠ ç»“æœåˆ°å®ç›˜æ•°é‡
function confirmAccumulateToReal() {
  const name = ($('stockCheckSearchGoods').value || '').trim();
  const item = goodsList.find(g => g.name === name);
  if (!item) {
    alert('è¯·å…ˆé€‰æ‹©å•†å“');
    return;
  }

  const hasConvert = item.unitText && item.unitText.trim() !== '' && item.unitText.trim() !== 'ç‚¹å‡»âš™ï¸è®¾ç½®' && item.unitText.includes('(');

  if (hasConvert) {
    const bigQty = parseFloat($('accumulateTotalBig').value) || 0;
    const smallQty = parseFloat($('accumulateTotalSmall').value) || 0;

    if (bigQty === 0 && smallQty === 0) {
      showSyncStatus('åˆè®¡æ•°é‡ä¸º0ï¼Œæ— æ³•å¡«å…¥');
      return;
    }

    $('checkReal1').value = bigQty;
    $('checkReal2').value = smallQty;
    showSyncStatus(`å·²å¡«å…¥: ${bigQty}å¤§ ${smallQty}å°`);
  } else {
    const totalQty = parseFloat($('accumulateTotalBig').value) || 0;

    if (totalQty === 0) {
      showSyncStatus('åˆè®¡æ•°é‡ä¸º0ï¼Œæ— æ³•å¡«å…¥');
      return;
    }

    $('checkRealSingle').value = totalQty;
    showSyncStatus(`å·²å¡«å…¥: ${totalQty}`);
  }

  // è§¦å‘å·®å¼‚è®¡ç®—
  calcCheckDiff();
}

// ========== å¯æ‹–åŠ¨ç´¯åŠ è¡¨å¼¹çª—åŠŸèƒ½ ==========
let accumulateModalRowCount = 0;
let isAccumulateModalDragging = false;
let accumulateModalDragOffset = { x: 0, y: 0 };

// æ˜¾ç¤ºç´¯åŠ è¡¨å¼¹çª—
function showAccumulateModal() {
  const name = ($('stockCheckSearchGoods').value || '').trim();
  const item = goodsList.find(g => g.name === name);
  if (!item) {
    alert('è¯·å…ˆé€‰æ‹©å•†å“');
    return;
  }

  const modal = $('accumulateModal');
  const overlay = $('accumulateModalOverlay');
  if (!modal || !overlay) return;

  // æ˜¾ç¤ºå¼¹çª—å’Œé®ç½©
  modal.style.display = 'block';
  overlay.style.display = 'block';

  // é‡ç½®ä½ç½®
  modal.style.top = '100px';
  modal.style.left = '50%';
  modal.style.transform = 'translateX(-50%)';

  // åˆå§‹åŒ–å¼¹çª—å†…çš„ç´¯åŠ è¡¨
  initAccumulateModal(item);
}

// å…³é—­ç´¯åŠ è¡¨å¼¹çª—
function closeAccumulateModal() {
  const modal = $('accumulateModal');
  const overlay = $('accumulateModalOverlay');
  if (modal) modal.style.display = 'none';
  if (overlay) overlay.style.display = 'none';
}

// åˆå§‹åŒ–å¼¹çª—å†…çš„ç´¯åŠ è¡¨
function initAccumulateModal(item) {
  accumulateTableHasConvert = item.unitText && item.unitText.trim() !== '' && item.unitText.trim() !== 'ç‚¹å‡»âš™ï¸è®¾ç½®' && item.unitText.includes('(');
  accumulateModalRowCount = 0;

  // é‡ç½®ç¼“å­˜
  cachedAccumulateModalTotalBig = null;
  cachedAccumulateModalTotalSmall = null;

  const container = $('accumulateRowsModal');
  if (!container) return;

  // æ¸…ç©ºç°æœ‰å†…å®¹
  container.innerHTML = '';

  // è·å–å•ä½ä¿¡æ¯
  accumulateBigUnit = 'å¤§';
  accumulateSmallUnit = 'å°';
  if (accumulateTableHasConvert) {
    const parsed = parseBigSmallUnitWithRate(item.unitText);
    accumulateBigUnit = parsed.big || 'å¤§';
    accumulateSmallUnit = parsed.small || 'å°';
    accumulateTableRate = parsed.rate || 1;
  }

  // æ›´æ–°å•ä½æ˜¾ç¤º
  const unitDisplay = $('accumulateUnitDisplay');
  if (unitDisplay) {
    unitDisplay.textContent = accumulateTableHasConvert ? `å•ä½ï¼š${accumulateBigUnit} / ${accumulateSmallUnit} (æ¢ç®—ç‡: 1${accumulateBigUnit}=${accumulateTableRate}${accumulateSmallUnit})` : `å•ä½ï¼š${item.singleUnit || 'ä¸ª'}`;
  }

  // æ›´æ–°è¡¨å¤´
  const headerBig = $('accumulateHeaderBig');
  const headerSmall = $('accumulateHeaderSmall');
  if (headerBig) headerBig.textContent = accumulateTableHasConvert ? accumulateBigUnit : 'æ•°é‡';
  if (headerSmall) headerSmall.textContent = accumulateTableHasConvert ? accumulateSmallUnit : '-';
  if (headerSmall) headerSmall.style.visibility = accumulateTableHasConvert ? 'visible' : 'hidden';

  // åˆå§‹ç”Ÿæˆ3è¡Œç©ºæ ¼ï¼ˆå ä½ï¼‰
  for (let i = 0; i < 3; i++) {
    addAccumulateModalRow(i);
  }

  // æ¸…ç©ºåˆè®¡
  const totalBig = $('accumulateTotalBigModal');
  const totalSmall = $('accumulateTotalSmallModal');
  if (totalBig) totalBig.value = '';
  if (totalSmall) totalSmall.value = '';
}

// æ·»åŠ å¼¹çª—ç´¯åŠ è¡¨è¡Œ
function addAccumulateModalRow(rowIndex) {
  const container = $('accumulateRowsModal');
  if (!container) return;

  const row = document.createElement('div');
  row.className = 'accumulate-modal-row';
  row.style.cssText = 'display:flex;gap:8px;margin-bottom:8px;';
  row.dataset.rowIndex = rowIndex;

  if (accumulateTableHasConvert) {
    row.innerHTML = `
      <div style="flex:1;">
        <input type="number" class="accumulate-modal-big" data-row="${rowIndex}" placeholder="${accumulateBigUnit}"
          style="width:100%;padding:10px;font-size:15px;text-align:center;border:2px solid #ccc;border-radius:6px;height:42px;box-sizing:border-box;"
          oninput="onAccumulateModalInput(this, ${rowIndex}, 'big')"
          onkeydown="onAccumulateModalKeydown(event, ${rowIndex}, 'big')">
      </div>
      <div style="flex:1;">
        <input type="number" class="accumulate-modal-small" data-row="${rowIndex}" placeholder="${accumulateSmallUnit}"
          style="width:100%;padding:10px;font-size:15px;text-align:center;border:2px solid #ccc;border-radius:6px;height:42px;box-sizing:border-box;"
          oninput="onAccumulateModalInput(this, ${rowIndex}, 'small')"
          onkeydown="onAccumulateModalKeydown(event, ${rowIndex}, 'small')">
      </div>
    `;
  } else {
    row.innerHTML = `
      <div style="flex:1;">
        <input type="number" class="accumulate-modal-qty" data-row="${rowIndex}" placeholder="æ•°é‡"
          style="width:100%;padding:10px;font-size:15px;text-align:center;border:2px solid #ccc;border-radius:6px;height:42px;box-sizing:border-box;"
          oninput="onAccumulateModalInput(this, ${rowIndex}, 'qty')"
          onkeydown="onAccumulateModalKeydown(event, ${rowIndex}, 'qty')">
      </div>
      <div style="flex:1;">
        <input type="text" disabled placeholder="-"
          style="width:100%;padding:10px;font-size:15px;text-align:center;border:2px solid #ddd;border-radius:6px;background:#eee;height:42px;box-sizing:border-box;" readonly>
      </div>
    `;
  }
  container.appendChild(row);
  accumulateModalRowCount++;
}

// å¼¹çª—ç´¯åŠ è¡¨è¾“å…¥å¤„ç† - ä¼˜åŒ–ç‰ˆæœ¬
function onAccumulateModalInput(input, rowIndex, type) {
  // ä½¿ç”¨ requestAnimationFrame ä¼˜åŒ–è®¡ç®—
  requestAnimationFrame(() => {
    calcAccumulateModalTotal();
  });

  // æ£€æŸ¥æ˜¯å¦æ˜¯æœ€åä¸€è¡Œä¸”æœ‰å€¼
  const parentRow = input.closest('.accumulate-modal-row');
  const container = $('accumulateRowsModal');
  if (parentRow && parentRow === container.lastElementChild && input.value !== '') {
    addAccumulateModalRow(rowIndex + 1);
  }
}

// å¼¹çª—ç´¯åŠ è¡¨é”®ç›˜å¤„ç†
function onAccumulateModalKeydown(event, rowIndex, type) {
  if (event.key === 'Enter') {
    event.preventDefault();
    const container = $('accumulateRowsModal');
    const allRows = container.querySelectorAll('.accumulate-modal-row');

    if (accumulateTableHasConvert) {
      if (type === 'big') {
        const smallInput = allRows[rowIndex].querySelector('.accumulate-modal-small');
        if (smallInput) smallInput.focus();
      } else {
        if (rowIndex + 1 < allRows.length) {
          const nextBigInput = allRows[rowIndex + 1].querySelector('.accumulate-modal-big');
          if (nextBigInput) nextBigInput.focus();
        }
      }
    } else {
      if (rowIndex + 1 < allRows.length) {
        const nextQtyInput = allRows[rowIndex + 1].querySelector('.accumulate-modal-qty');
        if (nextQtyInput) nextQtyInput.focus();
      }
    }
  }
}

// è®¡ç®—å¼¹çª—ç´¯åŠ è¡¨åˆè®¡ - ä¼˜åŒ–ç‰ˆæœ¬ï¼Œä½¿ç”¨ç¼“å­˜
let cachedAccumulateModalTotalBig = null;
let cachedAccumulateModalTotalSmall = null;

function calcAccumulateModalTotal() {
  // ç¼“å­˜DOMå¼•ç”¨
  if (!cachedAccumulateModalTotalBig) cachedAccumulateModalTotalBig = $('accumulateTotalBigModal');
  if (!cachedAccumulateModalTotalSmall) cachedAccumulateModalTotalSmall = $('accumulateTotalSmallModal');
  if (!cachedAccumulateModalTotalBig || !cachedAccumulateModalTotalSmall) return;

  let totalBig = 0;
  let totalSmall = 0;
  let totalRawSmall = 0;

  if (accumulateTableHasConvert) {
    // ä½¿ç”¨ querySelectorAll ä¸€æ¬¡æ€§è·å–æ‰€æœ‰è¾“å…¥æ¡†ï¼Œå‡å°‘DOMéå†
    const bigInputs = document.querySelectorAll('.accumulate-modal-big');
    const smallInputs = document.querySelectorAll('.accumulate-modal-small');

    for (let i = 0; i < bigInputs.length; i++) {
      totalBig += (+bigInputs[i].value) || 0;
    }
    for (let i = 0; i < smallInputs.length; i++) {
      totalRawSmall += (+smallInputs[i].value) || 0;
    }

    const smallCarry = (totalRawSmall / accumulateTableRate) | 0;
    const remainingSmall = totalRawSmall % accumulateTableRate;

    totalBig += smallCarry;
    totalSmall = remainingSmall;

    cachedAccumulateModalTotalBig.value = totalBig > 0 ? totalBig : '';
    cachedAccumulateModalTotalSmall.value = totalSmall > 0 ? totalSmall : '';
  } else {
    const qtyInputs = document.getElementsByClassName('accumulate-modal-qty');
    let total = 0;
    for (let i = 0; i < qtyInputs.length; i++) {
      total += (+qtyInputs[i].value) || 0;
    }
    cachedAccumulateModalTotalBig.value = total > 0 ? total : '';
    cachedAccumulateModalTotalSmall.value = '';
  }
}

// æ¸…ç©ºå¼¹çª—ç´¯åŠ è¡¨
function clearAccumulateModal() {
  const container = $('accumulateRowsModal');
  if (container) {
    container.innerHTML = '';
    // é‡æ–°ç”Ÿæˆ3è¡Œç©ºæ ¼
    for (let i = 0; i < 3; i++) {
      addAccumulateModalRow(i);
    }
  }
  // é‡ç½®ç¼“å­˜
  cachedAccumulateModalTotalBig = null;
  cachedAccumulateModalTotalSmall = null;

  const totalBig = $('accumulateTotalBigModal');
  const totalSmall = $('accumulateTotalSmallModal');
  if (totalBig) totalBig.value = '';
  if (totalSmall) totalSmall.value = '';
}

// ç¡®è®¤å¡«å…¥å¼¹çª—ç´¯åŠ ç»“æœ
function confirmAccumulateModal() {
  const name = ($('stockCheckSearchGoods').value || '').trim();
  const item = goodsList.find(g => g.name === name);
  if (!item) {
    alert('è¯·å…ˆé€‰æ‹©å•†å“');
    return;
  }

  const hasConvert = item.unitText && item.unitText.trim() !== '' && item.unitText.trim() !== 'ç‚¹å‡»âš™ï¸è®¾ç½®' && item.unitText.includes('(');

  if (hasConvert) {
    const bigQty = parseFloat($('accumulateTotalBigModal').value) || 0;
    const smallQty = parseFloat($('accumulateTotalSmallModal').value) || 0;

    if (bigQty === 0 && smallQty === 0) {
      showSyncStatus('åˆè®¡æ•°é‡ä¸º0ï¼Œæ— æ³•å¡«å…¥');
      return;
    }

    $('checkReal1').value = bigQty;
    $('checkReal2').value = smallQty;
    showSyncStatus(`å·²å¡«å…¥: ${bigQty}å¤§ ${smallQty}å°`);
  } else {
    const totalQty = parseFloat($('accumulateTotalBigModal').value) || 0;

    if (totalQty === 0) {
      showSyncStatus('åˆè®¡æ•°é‡ä¸º0ï¼Œæ— æ³•å¡«å…¥');
      return;
    }

    $('checkRealSingle').value = totalQty;
    showSyncStatus(`å·²å¡«å…¥: ${totalQty}`);
  }

  calcCheckDiff();
  closeAccumulateModal();
}

// æ‹–åŠ¨åŠŸèƒ½ - æ”¯æŒé¼ æ ‡å’Œè§¦æ‘¸
(function initDragFunction() {
  let dragModal = null;
  let dragOffsetX = 0;
  let dragOffsetY = 0;
  let isDragging = false;
  let startX = 0;
  let startY = 0;

  // è·å–äº‹ä»¶åæ ‡ï¼ˆå…¼å®¹é¼ æ ‡å’Œè§¦æ‘¸ï¼‰
  function getEventPos(e) {
    if (e.touches && e.touches.length > 0) {
      return { x: e.touches[0].clientX, y: e.touches[0].clientY };
    }
    return { x: e.clientX, y: e.clientY };
  }

  // å¼€å§‹æ‹–åŠ¨
  function startDrag(e) {
    const header = e.target.closest('#accumulateModalHeader');
    if (!header) return;

    const modal = $('accumulateModal');
    if (!modal || modal.style.display === 'none') return;

    // é˜²æ­¢é»˜è®¤è¡Œä¸ºï¼ˆç‰¹åˆ«æ˜¯è§¦æ‘¸æ—¶ï¼‰
    if (e.type === 'touchstart') {
      // ä¸é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œå…è®¸é¡µé¢æ»šåŠ¨ï¼Œä½†è®°å½•ä½ç½®
    }

    isDragging = true;
    const pos = getEventPos(e);
    startX = pos.x;
    startY = pos.y;

    const rect = modal.getBoundingClientRect();
    dragOffsetX = pos.x - rect.left;
    dragOffsetY = pos.y - rect.top;

    dragModal = modal;
    modal.style.transform = 'none';
  }

  // ç§»åŠ¨å¤„ç†
  function onMove(e) {
    if (!isDragging || !dragModal) return;

    const pos = getEventPos(e);

    // è®¡ç®—ç§»åŠ¨è·ç¦»ï¼Œåªæœ‰ç§»åŠ¨è¶…è¿‡5pxæ‰è®¤ä¸ºæ˜¯æ‹–åŠ¨
    const moveX = Math.abs(pos.x - startX);
    const moveY = Math.abs(pos.y - startY);

    if (moveX > 5 || moveY > 5) {
      if (e.type === 'touchmove') {
        e.preventDefault(); // é˜»æ­¢é¡µé¢æ»šåŠ¨
      }

      let x = pos.x - dragOffsetX;
      let y = pos.y - dragOffsetY;

      // é™åˆ¶åœ¨è§†çª—å†…
      const maxX = window.innerWidth - dragModal.offsetWidth;
      const maxY = window.innerHeight - dragModal.offsetHeight;
      x = Math.max(0, Math.min(x, maxX));
      y = Math.max(0, Math.min(y, maxY));

      dragModal.style.left = x + 'px';
      dragModal.style.top = y + 'px';
    }
  }

  // ç»“æŸæ‹–åŠ¨
  function onEnd() {
    isDragging = false;
    dragModal = null;
  }

  // é¼ æ ‡äº‹ä»¶
  document.addEventListener('mousedown', startDrag);
  document.addEventListener('mousemove', onMove);
  document.addEventListener('mouseup', onEnd);

  // è§¦æ‘¸äº‹ä»¶
  document.addEventListener('touchstart', startDrag, { passive: true });
  document.addEventListener('touchmove', onMove, { passive: false });
  document.addEventListener('touchend', onEnd);
})();

// ç›˜ç‚¹é€‰æ‹©å•†å“
initSearchSelect('stockCheckSearchGoods', 'stockCheckGoodsDropdown', (item) => {
  const hasConvert = item.unitText && item.unitText.trim() !== '' && item.unitText.trim() !== 'ç‚¹å‡»âš™ï¸è®¾ç½®' && item.unitText.includes('(');

  // è‡ªåŠ¨å¡«å†™ç±»å‹å’Œå­ç±»å‹
  $('stockCheckGoodsType').value = item.mainType || '';
  // æ›´æ–°å­ç±»å‹ä¸‹æ‹‰æ¡†
  const subTypeSelect = $('stockCheckGoodsSubType');
  subTypeSelect.innerHTML = '';
  const subList = typeData.subTypes[item.mainType] || [];
  subList.forEach(sub => {
    const opt = document.createElement('option');
    opt.value = sub;
    opt.textContent = sub;
    if (sub === item.subType) opt.selected = true;
    subTypeSelect.appendChild(opt);
  });

  // è‡ªåŠ¨å¡«å†™å•†å“è§„æ ¼
  $('stockCheckSpec').value = item.spec || '';

  if (hasConvert) {
    $('checkSingleRow').style.display = 'none';
    $('checkMultiRow').style.display = 'flex';
    $('realSingleRow').style.display = 'none';
    $('realMultiRow').style.display = 'flex';
    const { big, small, rate } = parseBigSmallUnitWithRate(item.unitText);
    $('stockCheckUnit').value = `${big}/${small}`;
    
    // æ›´æ–°å•ä½æ ‡ç­¾
    $('checkBookBigUnit').textContent = big;
    $('checkBookSmallUnit').textContent = small;
    $('checkRealBigUnit').textContent = big;
    $('checkRealSmallUnit').textContent = small;
    
    // è®¡ç®—è´¦é¢æ•°é‡çš„å¤§å•ä½å’Œå°å•ä½
    const totalQty = item.qty || 0;
    const bigQty = Math.floor(totalQty / rate);
    const smallQty = totalQty % rate;
    $('checkBook1').value = bigQty;
    $('checkBook2').value = smallQty;
    
    // ç»‘å®šå®ç›˜æ•°é‡è¾“å…¥äº‹ä»¶
    $('checkReal1').oninput = calcCheckDiff;
    $('checkReal2').oninput = calcCheckDiff;
  } else {
    $('checkSingleRow').style.display = 'block';
    $('checkMultiRow').style.display = 'none';
    $('realSingleRow').style.display = 'block';
    $('realMultiRow').style.display = 'none';
    $('stockCheckUnit').value = item.singleUnit || '';
    $('checkBookSingle').value = item.qty || 0;
    
    // ç»‘å®šå®ç›˜æ•°é‡è¾“å…¥äº‹ä»¶
    $('checkRealSingle').oninput = calcCheckDiff;
  }
  
  // åˆå§‹åŒ–å·®å¼‚ä¸º0
  $('checkDiff').value = '0';

  // åˆå§‹åŒ–ç´¯åŠ è¡¨æ ¼
  initAccumulateTable(hasConvert);
});

// åŒå•ä½æ˜¾ç¤º
function refreshAddUnitView() {
  const val = ($('unitDisplay').value || '').trim();
  const isDefault = !val || val === 'ç‚¹å‡»âš™ï¸è®¾ç½®';
  // åˆ¤æ–­æ˜¯å¦ä¸ºå•ä½æ¢ç®—æ ¼å¼ï¼šåŒ…å«æ‹¬å·ï¼Œå¦‚ kg(1000g)
  const isUnitConvert = val && val.includes('(') && val.includes(')');
  
  if (isDefault) {
    // é»˜è®¤çŠ¶æ€ï¼šåªæ˜¾ç¤ºå•ä¸ªæ•°é‡
    $('singleQtyRow').style.display = 'block';
    $('multiUnitRow').style.display = 'none';
  } else if (isUnitConvert) {
    // å•ä½æ¢ç®—æ¨¡å¼ï¼šæ˜¾ç¤ºå¤§å•ä½+å°å•ä½
    $('singleQtyRow').style.display = 'none';
    $('multiUnitRow').style.display = 'flex';
  } else {
    // å•ä¸ªå•ä½æ¨¡å¼ï¼šåªæ˜¾ç¤ºå•ä¸ªæ•°é‡
    $('singleQtyRow').style.display = 'block';
    $('multiUnitRow').style.display = 'none';
  }
}

// è¿”å›ä¸»é¡µ
$('backToHomeFromAdd').onclick = $('cancelAddGoods').onclick = () => {
  $('addGoodsPage').style.display = 'none';
  $('homePage').style.display = 'block';
}
$('backToHomeFromStockIn').onclick = $('cancelStockIn').onclick = () => {
  $('stockInPage').style.display = 'none';
  $('homePage').style.display = 'block';
}
$('backToHomeFromStockOut').onclick = $('cancelStockOut').onclick = () => {
  $('stockOutPage').style.display = 'none';
  $('homePage').style.display = 'block';
}
$('backToHomeFromStockCheck').onclick = $('cancelStockCheck').onclick = () => {
  $('stockCheckPage').style.display = 'none';
  $('homePage').style.display = 'block';
}

// ç±»å‹è”åŠ¨
function syncSubTypes(selectMain, selectSub) {
  if (!selectMain || !selectSub) return;
  const val = selectMain.value;
  const list = typeData.subTypes[val] || [];
  selectSub.innerHTML = '';
  list.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = s;
    selectSub.appendChild(opt);
  });
}

function syncAllSelect() {
  const mains = [$('goodsType'), $('stockInGoodsType'), $('stockOutGoodsType'), $('stockCheckGoodsType')];
  mains.forEach(sel => {
    if (!sel) return;
    sel.innerHTML = '';
    typeData.mainTypes.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t;
      opt.textContent = t;
      sel.appendChild(opt);
    });
  });
  syncSubTypes($('goodsType'), $('goodsSubType'));
  syncSubTypes($('stockInGoodsType'), $('stockInGoodsSubType'));
  syncSubTypes($('stockOutGoodsType'), $('stockOutGoodsSubType'));
  syncSubTypes($('stockCheckGoodsType'), $('stockCheckGoodsSubType'));
}

$('goodsType').onchange = () => syncSubTypes($('goodsType'), $('goodsSubType'));
$('stockInGoodsType').onchange = () => syncSubTypes($('stockInGoodsType'), $('stockInGoodsSubType'));
$('stockOutGoodsType').onchange = () => syncSubTypes($('stockOutGoodsType'), $('stockOutGoodsSubType'));
$('stockCheckGoodsType').onchange = () => syncSubTypes($('stockCheckGoodsType'), $('stockCheckGoodsSubType'));

// å•ä½ç±»å‹åˆ‡æ¢
let currentUnitType = 'single';
function switchUnitType(type) {
  currentUnitType = type;
  const singleBtn = $('singleUnitBtn');
  const multiBtn = $('multiUnitBtn');
  const singleSection = $('singleUnitSection');
  const multiSection = $('multiUnitSection');
  
  if (type === 'single') {
    if (singleBtn) singleBtn.classList.add('active');
    if (multiBtn) multiBtn.classList.remove('active');
    if (singleSection) singleSection.style.display = 'block';
    if (multiSection) multiSection.style.display = 'none';
  } else {
    if (singleBtn) singleBtn.classList.remove('active');
    if (multiBtn) multiBtn.classList.add('active');
    if (singleSection) singleSection.style.display = 'none';
    if (multiSection) multiSection.style.display = 'block';
  }
}

// å•ä½æ¢ç®—å¼¹çª—
$('toggleUnit').onclick = () => { 
  $('unitModal').style.display = 'flex'; 
  // é‡ç½®ä¸ºå•ä½ç±»å‹
  switchUnitType('single');
}
$('cancelUnit').onclick = () => { $('unitModal').style.display = 'none'; }
$('saveUnit').onclick = () => {
  if (currentUnitType === 'single') {
    const unit = ($('singleUnitInput').value || '').trim();
    if (!unit) { alert('è¯·è¾“å…¥å•ä½'); return; }
    $('unitDisplay').value = unit;
  } else {
    const b = ($('bigUnit').value || '').trim();
    const s = ($('smallUnit').value || '').trim();
    const r = +$('unitRate').value || 1;
    if (!b || !s) { alert('è¯·å¡«å†™å®Œæ•´'); return; }
    $('unitDisplay').value = `${b}(${r}${s})`;
  }
  $('unitModal').style.display = 'none';
  refreshAddUnitView();
};

// è®¡ç®—é‡‘é¢
function calcAmount() {
  const enabled = ($('unitDisplay').value || '').trim() !== 'ç‚¹å‡»âš™ï¸è®¾ç½®';
  const rate = +$('unitRate').value || 1;
  const qty = enabled
    ? (+$('num1').value || 0) * rate + (+$('num2').value || 0)
    : +$('singleQty').value || 0;
  $('goodsAmount').value = (qty * (+$('goodsPrice').value || 0)).toFixed(2);
}
$('singleQty').oninput = $('num1').oninput = $('num2').oninput = $('goodsPrice').oninput = calcAmount;

// å…¥åº“è®¡ç®—
function calcIn() {
  const name = ($('stockInSearchGoods').value || '').trim();
  const item = goodsList.find(g => g.name === name);
  if (!item) return;
  const hasConvert = item.unitText && item.unitText.trim() !== '' && item.unitText.trim() !== 'ç‚¹å‡»âš™ï¸è®¾ç½®' && item.unitText.includes('(');
  const rate = item.unitRate || 1;
  const totalQty = hasConvert
    ? (+$('stockInNum1').value || 0) * rate + (+$('stockInNum2').value || 0)
    : +$('stockInSingleQty').value || 0;
  const price = +$('stockInPrice').value || 0;
  $('stockInAmount').value = (totalQty * price).toFixed(2);
}
$('stockInSingleQty').oninput = $('stockInNum1').oninput = $('stockInNum2').oninput = $('stockInPrice').oninput = calcIn;

// å‡ºåº“è®¡ç®—
function calcOut() {
  const name = ($('stockOutSearchGoods').value || '').trim();
  const item = goodsList.find(g => g.name === name);
  if (!item) return;
  const hasConvert = item.unitText && item.unitText.trim() !== '' && item.unitText.trim() !== 'ç‚¹å‡»âš™ï¸è®¾ç½®' && item.unitText.includes('(');
  const rate = item.unitRate || 1;
  const totalQty = hasConvert
    ? (+$('stockOutNum1').value || 0) * rate + (+$('stockOutNum2').value || 0)
    : +$('stockOutSingleQty').value || 0;
  const price = +$('stockOutPrice').value || 0;
  $('stockOutAmount').value = (totalQty * price).toFixed(2);
}
$('stockOutSingleQty').oninput = $('stockOutNum1').oninput = $('stockOutNum2').oninput = $('stockOutPrice').oninput = calcOut;

// æ¸²æŸ“å•†å“åˆ—è¡¨
function renderGoodsList(keyword = '') {
  const container = $('goodsListContainer');
  const emptyTip = $('emptyTip');
  if (!container) return;

  // æ›´æ–°å•†å“ç§ç±»ç»Ÿè®¡
  const goodsCategoryCard = $('goodsCategoryCard');
  if (goodsCategoryCard) {
    const uniqueTypes = new Set(goodsList.map(g => g.mainType)).size;
    goodsCategoryCard.querySelector('div:last-child').textContent = uniqueTypes;
  }
  
  // æ›´æ–°ä½åº“å­˜é¢„è­¦ç»Ÿè®¡ï¼ˆä»¥å¤§å•ä½ä¸ºæ ‡å‡†ï¼Œä½¿ç”¨å•†å“è‡ªå·±çš„é¢„è­¦é˜ˆå€¼ï¼‰
  const lowStockCard = $('lowStockCard');
  if (lowStockCard) {
    const lowStockCount = goodsList.filter(g => {
      // ä½¿ç”¨å•†å“è‡ªå·±çš„é¢„è­¦é˜ˆå€¼ï¼Œé»˜è®¤ä¸º1
      const goodsWarnThreshold = g.warnThreshold || 1;
      const hasUnitConvert = g.unitText && g.unitText.includes('(') && g.unitRate > 1;
      if (hasUnitConvert) {
        const match = g.unitText.match(/^(.+)\((\d+)(.+)\)$/);
        if (match) {
          const rate = parseInt(match[2]) || 1;
          const bigQty = Math.floor((g.qty || 0) / rate);
          return bigQty < goodsWarnThreshold;
        }
      }
      return (g.qty || 0) < goodsWarnThreshold;
    }).length;
    lowStockCard.querySelector('div:last-child').textContent = lowStockCount;
  }
  
  // æ›´æ–°å…¥åº“æ—¶é—´é¢„è­¦ç»Ÿè®¡
  const stockInWarnCard = $('stockInWarnCard');
  if (stockInWarnCard) {
    const today = new Date();
    const stockInWarnCount = goodsList.filter(g => {
      if (!g.stockTime) return false;
      // å¦‚æœè®¾ç½®äº†é¢„è­¦æ—¥æœŸï¼ŒæŒ‰é¢„è­¦æ—¥æœŸåˆ¤æ–­
      if (g.warnDate) {
        const warnDate = new Date(g.warnDate);
        return today > warnDate;
      }
      // å¦åˆ™æŒ‰å…¥åº“æ—¶é—´+é¢„è­¦å¤©æ•°åˆ¤æ–­
      const stockDate = new Date(g.stockTime);
      const diffDays = Math.floor((today - stockDate) / (1000 * 60 * 60 * 24));
      const globalWarnDays = parseInt(localStorage.getItem('stockWarnDays') || '90');
      const goodsWarnDays = g.stockInWarnDays || globalWarnDays;
      return diffDays > goodsWarnDays;
    }).length;
    stockInWarnCard.querySelector('div:last-child').textContent = stockInWarnCount;
  }

  // ç­›é€‰å•†å“å¹¶æŒ‰ä¸»ç±»å‹->å­ç±»å‹->å•†å“åç§°æ’åº
  let filteredList = goodsList;
  if (keyword) {
    const lowerKeyword = keyword.toLowerCase();
    filteredList = goodsList.filter(item =>
      (item.name || '').toLowerCase().includes(lowerKeyword) ||
      (item.mainType || '').toLowerCase().includes(lowerKeyword) ||
      (item.subType || '').toLowerCase().includes(lowerKeyword)
    );
  }
  // æŒ‰ä¸»ç±»å‹->å­ç±»å‹->å•†å“åç§°æ’åº
  filteredList = sortGoodsList(filteredList);

  if (filteredList.length === 0) {
    container.innerHTML = keyword ? '<div style="text-align:center;padding:20px;color:#999;">æœªæ‰¾åˆ°åŒ¹é…çš„å•†å“</div>' : '';
    if (emptyTip && !keyword) emptyTip.style.display = 'block';
    return;
  }

  if (emptyTip) emptyTip.style.display = 'none';

  container.innerHTML = filteredList.map((item, index) => {
    const mainType = item.mainType || 'åŸææ–™';
    const subType = item.subType || '';
    const typeText = subType ? `${mainType} > ${subType}` : mainType;
    const stockTime = item.stockTime || new Date().toISOString().split('T')[0];
    const qty = item.qty || 0;

    // åˆ¤æ–­æ˜¯å¦æœ‰å•ä½æ¢ç®—
    const hasUnitConvert = item.unitText && item.unitText.includes('(');
    let qtyDisplay = '';
    let unitDisplay = '';

    if (hasUnitConvert && item.unitRate > 1) {
      // è§£æå¤§å•ä½å’Œå°å•ä½
      const match = item.unitText.match(/^(.+)\((\d+)(.+)\)$/);
      if (match) {
        const bigUnit = match[1];
        const rate = parseInt(match[2]) || 1;
        const smallUnit = match[3];

        // è®¡ç®—å¤§å•ä½æ•°é‡å’Œå°å•ä½æ•°é‡
        const bigQty = Math.floor(qty / rate);
        const smallQty = qty % rate;

        if (bigQty > 0 && smallQty > 0) {
          qtyDisplay = `${bigQty}${bigUnit}/${smallQty}`;
          unitDisplay = smallUnit;
        } else if (bigQty > 0) {
          qtyDisplay = `${bigQty}`;
          unitDisplay = bigUnit;
        } else {
          qtyDisplay = `${smallQty}`;
          unitDisplay = smallUnit;
        }
      } else {
        qtyDisplay = qty;
        unitDisplay = item.singleUnit || 'ä¸ª';
      }
    } else {
      qtyDisplay = qty;
      unitDisplay = item.singleUnit || 'ä¸ª';
    }

    // æ‰¾åˆ°åŸå§‹ç´¢å¼•
    const originalIndex = goodsList.findIndex(g => g.name === item.name && g.stockTime === item.stockTime);

    // æ„å»ºå•†å“åç§°æ˜¾ç¤ºï¼ˆåŒ…å«è§„æ ¼ï¼‰
    const specText = item.spec ? `<span style="color:#666;font-size:13px;font-weight:normal;margin-left:8px;">(${item.spec})</span>` : '';
    const nameDisplay = `${item.name}${specText}`;

    return `
      <div class="goods-card" data-index="${originalIndex}">
        <div class="goods-card-header">
          <div class="goods-card-name">${nameDisplay}</div>
          <div class="goods-card-edit" onclick="editGoods(${originalIndex})">âœï¸</div>
        </div>
        <div class="goods-card-type">${typeText}</div>
        <div class="goods-card-time">å…¥åº“æ—¶é—´ï¼š${stockTime}</div>
        <div class="goods-card-stock">
          <span class="goods-card-qty">${qtyDisplay}</span>
          <span class="goods-card-unit">${unitDisplay}</span>
        </div>
      </div>
    `;
  }).join('');
}

// å½“å‰ç¼–è¾‘çš„å•†å“ç´¢å¼•
let currentEditIndex = -1;

// ç¼–è¾‘å•†å“
function editGoods(index) {
  const item = goodsList[index];
  if (!item) return;

  currentEditIndex = index;

  // å¡«å……ç¼–è¾‘è¡¨å•
  $('editGoodsName').value = item.name || '';
  $('editGoodsSpec').value = item.spec || '';
  $('editGoodsPrice').value = item.price || 0;
  $('editGoodsAmount').value = ((item.qty || 0) * (item.price || 0)).toFixed(2);
  // æ‰“å¼€é¡µé¢æ—¶è‡ªåŠ¨è®¾ç½®ä¸ºå½“æ—¥
  $('editGoodsTime').value = new Date().toISOString().split('T')[0];

  // åˆ¤æ–­æ˜¯å¦æœ‰å•ä½æ¢ç®—
  const hasUnitConvert = item.unitText && item.unitText.includes('(') && item.unitRate > 1;

  if (hasUnitConvert) {
    // æœ‰å•ä½æ¢ç®— - æ˜¾ç¤ºå¤§å•ä½/å°å•ä½è¾“å…¥æ¡†
    const match = item.unitText.match(/^(.+)\((\d+)(.+)\)$/);
    if (match) {
      const bigUnit = match[1];
      const rate = parseInt(match[2]) || 1;
      const smallUnit = match[3];

      // è®¡ç®—å¤§å•ä½æ•°é‡å’Œå°å•ä½æ•°é‡
      const totalQty = item.qty || 0;
      const bigQty = Math.floor(totalQty / rate);
      const smallQty = totalQty % rate;

      // æ˜¾ç¤ºå•ä½æ¢ç®—è¾“å…¥æ¡†
      $('editSingleUnitRow').style.display = 'none';
      $('editSingleQtyRow').style.display = 'none';
      $('editMultiUnitRow').style.display = 'flex';

      // è®¾ç½®æ ‡ç­¾
      $('editMultiUnitRow').querySelectorAll('.form-group')[0].querySelector('label').textContent = bigUnit;
      $('editMultiUnitRow').querySelectorAll('.form-group')[1].querySelector('label').textContent = smallUnit;

      // å¡«å……æ•°å€¼ï¼ˆç¡®ä¿ä¸ä¸ºç©ºï¼‰
      $('editGoodsBigQty').value = bigQty || 0;
      $('editGoodsSmallQty').value = smallQty || 0;
      // æ¸…ç©ºå•ä¸ªæ•°é‡è¾“å…¥æ¡†
      $('editGoodsQty').value = 0;
    }
  } else {
    // æ— å•ä½æ¢ç®— - æ˜¾ç¤ºå•ä¸ªå•ä½
    $('editSingleUnitRow').style.display = 'block';
    $('editSingleQtyRow').style.display = 'block';
    $('editMultiUnitRow').style.display = 'none';

    $('editGoodsUnit').value = item.singleUnit || 'ä¸ª';
    // ç¡®ä¿æ•°é‡ä¸ä¸ºç©º
    $('editGoodsQty').value = item.qty === undefined || item.qty === null ? 0 : item.qty;
    // æ¸…ç©ºå•ä½æ¢ç®—è¾“å…¥æ¡†
    $('editGoodsBigQty').value = 0;
    $('editGoodsSmallQty').value = 0;
  }

  // å¡«å……ç±»å‹é€‰æ‹©æ¡†
  const editGoodsType = $('editGoodsType');
  const editGoodsSubType = $('editGoodsSubType');

  editGoodsType.innerHTML = '';
  typeData.mainTypes.forEach(t => {
    const opt = document.createElement('option');
    opt.value = t;
    opt.textContent = t;
    if (t === item.mainType) opt.selected = true;
    editGoodsType.appendChild(opt);
  });

  // å¡«å……å­ç±»å‹
  editGoodsSubType.innerHTML = '';
  const subList = typeData.subTypes[item.mainType] || [];
  subList.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = s;
    if (s === item.subType) opt.selected = true;
    editGoodsSubType.appendChild(opt);
  });

  // æ˜¾ç¤ºç¼–è¾‘é¡µé¢
  $('editGoodsPage').style.display = 'block';
  $('homePage').style.display = 'none';
}

// è¿”å›ä¸»é¡µ
$('backToHomeFromEdit').onclick = () => {
  $('editGoodsPage').style.display = 'none';
  $('homePage').style.display = 'block';
  currentEditIndex = -1;
};

$('cancelEditGoods').onclick = () => {
  $('editGoodsPage').style.display = 'none';
  $('homePage').style.display = 'block';
  currentEditIndex = -1;
};

// è®¡ç®—ç¼–è¾‘é¡µé¢é‡‘é¢ï¼ˆå•ä¸ªå•ä½æ¨¡å¼ï¼‰
function calcEditAmount() {
  const qty = +$('editGoodsQty').value || 0;
  const price = +$('editGoodsPrice').value || 0;
  $('editGoodsAmount').value = (qty * price).toFixed(2);
}
$('editGoodsQty').oninput = $('editGoodsPrice').oninput = calcEditAmount;

// è®¡ç®—ç¼–è¾‘é¡µé¢é‡‘é¢ï¼ˆå•ä½æ¢ç®—æ¨¡å¼ï¼‰
function calcEditAmountMulti() {
  const item = goodsList[currentEditIndex];
  if (!item) return;

  const rate = item.unitRate || 1;
  const bigQty = +$('editGoodsBigQty').value || 0;
  const smallQty = +$('editGoodsSmallQty').value || 0;
  const totalQty = bigQty * rate + smallQty;
  const price = +$('editGoodsPrice').value || 0;

  $('editGoodsAmount').value = (totalQty * price).toFixed(2);
}
$('editGoodsBigQty').oninput = $('editGoodsSmallQty').oninput = $('editGoodsPrice').oninput = calcEditAmountMulti;

// ä¿å­˜ç¼–è¾‘
$('saveEditGoods').onclick = () => {
  if (currentEditIndex === -1) return;

  const item = goodsList[currentEditIndex];
  const hasUnitConvert = item.unitText && item.unitText.includes('(') && item.unitRate > 1;

  let qty = 0;
  if (hasUnitConvert) {
    // å•ä½æ¢ç®—æ¨¡å¼
    const rate = item.unitRate || 1;
    const bigQty = +$('editGoodsBigQty').value || 0;
    const smallQty = +$('editGoodsSmallQty').value || 0;
    qty = bigQty * rate + smallQty;
  } else {
    // å•ä¸ªå•ä½æ¨¡å¼
    qty = +$('editGoodsQty').value || 0;
  }

  const price = +$('editGoodsPrice').value || 0;
  const spec = ($('editGoodsSpec').value || '').trim();

  // æ›´æ–°å•†å“æ•°æ®
  goodsList[currentEditIndex].qty = qty;
  goodsList[currentEditIndex].price = price;
  goodsList[currentEditIndex].spec = spec;
  goodsList[currentEditIndex].stockTime = $('editGoodsTime').value || new Date().toISOString().split('T')[0];

  // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
  saveData();

  // åˆ·æ–°åˆ—è¡¨
  renderGoodsList();

  alert('ä¿å­˜æˆåŠŸ');
  $('editGoodsPage').style.display = 'none';
  $('homePage').style.display = 'block';
  currentEditIndex = -1;
};

// åˆ é™¤å•†å“
$('deleteGoods').onclick = () => {
  if (currentEditIndex === -1) return;
  
  if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå•†å“å—ï¼Ÿ')) return;
  
  // åˆ é™¤å•†å“
  goodsList.splice(currentEditIndex, 1);
  
  // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
  saveData();
  
  // åˆ·æ–°åˆ—è¡¨
  renderGoodsList();
  
  alert('åˆ é™¤æˆåŠŸ');
  $('editGoodsPage').style.display = 'none';
  $('homePage').style.display = 'block';
  currentEditIndex = -1;
};

// ä¿å­˜å•†å“
$('saveGoods').onclick = () => {
  const name = ($('goodsName').value || '').trim();
  if (!name) { alert('è¯·è¾“å…¥å•†å“åç§°'); return; }
  
  const mainType = $('goodsType').value || 'åŸææ–™';
  const subType = $('goodsSubType').value || '';
  
  // æ£€æŸ¥åŒç±»å‹ä¸‹æ˜¯å¦æœ‰ç›¸åŒåç§°çš„å•†å“
  const existingGoods = goodsList.find(g => 
    g.name === name && g.mainType === mainType && g.subType === subType
  );
  if (existingGoods) {
    alert(`ã€${mainType} > ${subType || 'æ— å­ç±»å‹'}ã€‘åˆ†ç±»ä¸‹å·²å­˜åœ¨å•†å“"${name}"ï¼Œè¯·å‹¿é‡å¤å½•å…¥ï¼`);
    return;
  }
  
  const unitText = ($('unitDisplay').value || '').trim();
  const hasUnitConvert = unitText && unitText !== 'ç‚¹å‡»âš™ï¸è®¾ç½®' && unitText.includes('(');
  
  const qty = hasUnitConvert
    ? (+$('num1').value || 0) * (+$('unitRate').value || 1) + (+$('num2').value || 0)
    : +$('singleQty').value || 0;
  
  // æå–å•ä½ï¼ˆå•ä¸ªå•ä½æˆ–æ¢ç®—ä¸­çš„å°å•ä½ï¼‰
  let singleUnit = unitText;
  if (hasUnitConvert) {
    const match = unitText.match(/\d+(.+)\)$/);
    singleUnit = match ? match[1] : unitText;
  }
  
  // è®¡ç®—é¢„è­¦æ—¥æœŸï¼šå¦‚æœè®¾ç½®äº†é¢„è­¦æ—¥æœŸåˆ™ä½¿ç”¨ï¼Œå¦åˆ™æ ¹æ®å…¥åº“æ—¶é—´+90å¤©è®¡ç®—
  const stockTime = $('goodsTime').value || new Date().toISOString().split('T')[0];
  const warnDate = $('goodsWarnDate').value || '';
  
  const item = {
    name,
    spec: ($('goodsSpec').value || '').trim(),  // å•†å“è§„æ ¼
    singleUnit: singleUnit,
    unitText: unitText === 'ç‚¹å‡»âš™ï¸è®¾ç½®' ? '' : unitText,
    unitRate: +$('unitRate').value || 1,
    price: +$('goodsPrice').value || 0,
    mainType: mainType,
    subType: subType,
    stockTime: stockTime,
    qty: qty,
    warnThreshold: +$('goodsWarn').value || 0,
    warnDate: warnDate,  // é¢„è­¦æ—¥æœŸ
    stockInWarnDays: warnDate ? null : 90  // å¦‚æœè®¾ç½®äº†é¢„è­¦æ—¥æœŸï¼Œåˆ™ä¸ä½¿ç”¨å¤©æ•°
  };
  goodsList.push(item);
  saveData();
  alert('ä¿å­˜æˆåŠŸ');
  renderGoodsList();
  // é‡ç½®è¡¨å•ï¼Œç•™åœ¨å½“å‰é¡µæ–¹ä¾¿ç»§ç»­æ·»åŠ 
  $('goodsName').value = '';
  $('goodsSpec').value = '';
  $('singleQty').value = '';
  $('num1').value = '';
  $('num2').value = '';
  $('goodsPrice').value = '';
  $('goodsAmount').value = '';
  $('goodsWarn').value = '1';
  $('goodsWarnDate').value = '';
  $('unitDisplay').value = 'ç‚¹å‡»âš™ï¸è®¾ç½®';
  $('singleUnitRow').style.display = 'block';
  $('multiUnitRow').style.display = 'none';
  refreshAddUnitView();
  // è®¾ç½®å…¥åº“æ—¶é—´ä¸ºå½“æ—¥
  $('goodsTime').value = new Date().toISOString().split('T')[0];
  // èšç„¦åˆ°å•†å“åç§°è¾“å…¥æ¡†ï¼Œæ–¹ä¾¿ç»§ç»­è¾“å…¥
  $('goodsName').focus();
};

// åˆ‡æ¢å•ä¸ªå½•å…¥å’Œæ‰¹é‡å½•å…¥
$('singleInput').onclick = () => {
  $('singleInput').classList.add('active');
  $('batchInput').classList.remove('active');
  $('singleInputForm').style.display = 'block';
  $('batchInputForm').style.display = 'none';
};

$('batchInput').onclick = () => {
  $('batchInput').classList.add('active');
  $('singleInput').classList.remove('active');
  $('batchInputForm').style.display = 'block';
  $('singleInputForm').style.display = 'none';
};

// è§£ææ‰¹é‡å½•å…¥æ•°æ®
$('parseBatchData').onclick = () => {
  const content = $('batchInputContent').value.trim();
  if (!content) {
    alert('è¯·è¾“å…¥æ‰¹é‡å½•å…¥æ•°æ®');
    return;
  }
  
  const lines = content.split('\n').filter(line => line.trim());
  let parsedCount = 0;
  
  lines.forEach(line => {
    const parts = line.split(',').map(p => p.trim());
    if (parts.length >= 2 && parts[0]) {
      parsedCount++;
    }
  });
  
  alert(`è§£ææˆåŠŸï¼Œå…± ${parsedCount} æ¡æ•°æ®`);
};

// è§£æåˆ†æ•°æ ¼å¼çš„æ•°é‡ï¼Œå¦‚ "1/10" -> 1*rate + 10
function parseFractionQty(qtyStr, rate) {
  if (!qtyStr || typeof qtyStr !== 'string') return parseFloat(qtyStr) || 0;
  const match = qtyStr.match(/^(\d+)\/(\d+)$/);
  if (match) {
    const bigQty = parseInt(match[1]) || 0;
    const smallQty = parseInt(match[2]) || 0;
    return bigQty * rate + smallQty;
  }
  return parseFloat(qtyStr) || 0;
}

// è§£æå•ä½æ ¼å¼ï¼Œå¦‚ "kg/g" -> big=kg, small=g, å°è¯•ä»ç°æœ‰å•†å“æŸ¥æ‰¾æ¢ç®—æ¯”ä¾‹
function parseUnitFormat(unitStr) {
  if (!unitStr || typeof unitStr !== 'string') return { big: '', small: unitStr || 'ä¸ª', rate: 1 };
  const match = unitStr.match(/^(.+)\/(.+)$/);
  if (match) {
    const big = match[1];
    const small = match[2];
    // å°è¯•ä»ç°æœ‰å•†å“ä¸­æŸ¥æ‰¾æ¢ç®—æ¯”ä¾‹
    const existingGoods = goodsList.find(g => {
      const gMatch = g.unitText && g.unitText.match(/^(.+)\((\d+)(.+)\)$/);
      if (gMatch) {
        return gMatch[1] === big && gMatch[3] === small;
      }
      return false;
    });
    if (existingGoods) {
      const gMatch = existingGoods.unitText.match(/^(.+)\((\d+)(.+)\)$/);
      return { big, small, rate: parseInt(gMatch[2]) || 1 };
    }
    // é»˜è®¤æ¯”ä¾‹ 1
    return { big, small, rate: 1 };
  }
  return { big: '', small: unitStr, rate: 1 };
}

// æ‰¹é‡ä¿å­˜å•†å“
$('saveBatchGoods').onclick = () => {
  const content = $('batchInputContent').value.trim();
  if (!content) {
    alert('è¯·è¾“å…¥æ‰¹é‡å½•å…¥æ•°æ®');
    return;
  }
  
  const lines = content.split('\n').filter(line => line.trim());
  let successCount = 0;
  let failCount = 0;
  let duplicateErrors = [];
  
  lines.forEach((line, index) => {
    const parts = line.split(',').map(p => p.trim());
    if (parts.length >= 2 && parts[0]) {
      const name = parts[0];
      const unitStr = parts[2] || 'ä¸ª';
      const mainType = parts[3] || 'åŸææ–™';
      const subType = parts[4] || '';
      const price = parseFloat(parts[5]) || 0;
      const warnThreshold = parseFloat(parts[6]) || 0;
      const stockTime = parts[7] || new Date().toISOString().split('T')[0];
      const stockInWarnDays = parseInt(parts[8]) || 7;
      
      // è§£æå•ä½å’Œæ•°é‡
      const { big, small, rate } = parseUnitFormat(unitStr);
      const qty = parseFractionQty(parts[1], rate);
      
      // æ„å»ºå•ä½æ–‡æœ¬
      let unitText = unitStr;
      let singleUnit = unitStr;
      if (big && small) {
        unitText = `${big}(${rate}${small})`;
        singleUnit = small;
      }
      
      // æ£€æŸ¥åŒç±»å‹ä¸‹æ˜¯å¦æœ‰ç›¸åŒåç§°çš„å•†å“
      const existingGoods = goodsList.find(g => 
        g.name === name && g.mainType === mainType && g.subType === subType
      );
      if (existingGoods) {
        duplicateErrors.push(`ç¬¬${index + 1}è¡Œï¼šã€${mainType} > ${subType || 'æ— å­ç±»å‹'}ã€‘åˆ†ç±»ä¸‹å·²å­˜åœ¨å•†å“"${name}"`);
        failCount++;
        return;
      }
      
      const item = {
        name,
        singleUnit: singleUnit,
        unitText: unitText,
        unitRate: rate,
        price,
        mainType,
        subType,
        stockTime,
        qty,
        warnThreshold,
        stockInWarnDays
      };
      
      goodsList.push(item);
      successCount++;
    } else {
      failCount++;
    }
  });
  
  saveData();
  let msg = `æ‰¹é‡ä¿å­˜æˆåŠŸï¼š${successCount} æ¡ï¼Œå¤±è´¥ï¼š${failCount} æ¡`;
  if (duplicateErrors.length > 0) {
    msg += '\n\né‡å¤å•†å“ï¼š\n' + duplicateErrors.join('\n');
  }
  alert(msg);
  renderGoodsList();
  $('batchInputContent').value = '';
  $('addGoodsPage').style.display = 'none';
  $('homePage').style.display = 'block';
};

// å–æ¶ˆæ‰¹é‡å½•å…¥
$('cancelBatchInput').onclick = () => {
  $('batchInputContent').value = '';
  $('singleInput').classList.add('active');
  $('batchInput').classList.remove('active');
  $('singleInputForm').style.display = 'block';
  $('batchInputForm').style.display = 'none';
};

// æ‰“å¼€é¡µé¢
$('openAddGoods').onclick = () => {
  syncAllSelect();
  // é‡ç½®è¡¨å•å­—æ®µ
  $('goodsName').value = '';
  $('goodsSpec').value = '';
  $('singleQty').value = '';
  $('num1').value = '';
  $('num2').value = '';
  $('goodsPrice').value = '';
  $('goodsAmount').value = '';
  $('goodsWarn').value = '1';
  $('goodsWarnDate').value = '';
  $('unitDisplay').value = 'ç‚¹å‡»âš™ï¸è®¾ç½®';
  $('singleUnitRow').style.display = 'block';
  $('multiUnitRow').style.display = 'none';
  refreshAddUnitView();
  // è®¾ç½®å…¥åº“æ—¶é—´ä¸ºå½“æ—¥
  $('goodsTime').value = new Date().toISOString().split('T')[0];
  // æ›´æ–°é¢„è­¦æ—¥æœŸæç¤ºæ–‡å­—
  const warnDays = localStorage.getItem('stockWarnDays') || '90';
  const warnDateHint = document.querySelector('#goodsWarnDate + div');
  if (warnDateHint) {
    warnDateHint.textContent = `ç•™ç©ºåˆ™ä½¿ç”¨å…¨å±€é¢„è­¦å¤©æ•°ï¼ˆ${warnDays}å¤©ï¼‰`;
  }
  // é‡ç½®ä¸ºå•ä¸ªå½•å…¥æ¨¡å¼
  $('singleInput').classList.add('active');
  $('batchInput').classList.remove('active');
  $('singleInputForm').style.display = 'block';
  $('batchInputForm').style.display = 'none';
  $('batchInputContent').value = '';
  $('homePage').style.display = 'none';
  $('addGoodsPage').style.display = 'block';
};

$('openStockIn').onclick = () => {
  syncAllSelect();
  $('stockInSearchGoods').value = '';
  $('stockInSpec').value = '';
  $('stockInSingleQty').value = '';
  $('stockInNum1').value = '';
  $('stockInNum2').value = '';
  $('stockInUnit').value = '';
  $('stockInPrice').value = '';
  $('stockInAmount').value = '';
  // è®¾ç½®å…¥åº“æ—¶é—´ä¸ºå½“æ—¥
  $('stockInTime').value = new Date().toISOString().split('T')[0];
  $('stockInRemark').value = '';
  $('stockInSingleRow').style.display = 'block';
  $('stockInMultiRow').style.display = 'none';
  $('homePage').style.display = 'none';
  $('stockInPage').style.display = 'block';
};

$('openStockOut').onclick = () => {
  syncAllSelect();
  $('stockOutSearchGoods').value = '';
  $('stockOutSpec').value = '';
  $('stockOutSingleQty').value = '';
  $('stockOutNum1').value = '';
  $('stockOutNum2').value = '';
  $('stockOutUnit').value = '';
  $('stockOutPrice').value = '';
  $('stockOutAmount').value = '';
  $('stockOutSingleRow').style.display = 'block';
  $('stockOutMultiRow').style.display = 'none';
  $('homePage').style.display = 'none';
  $('stockOutPage').style.display = 'block';
};

$('openStockCheck').onclick = () => {
  syncAllSelect();
  $('stockCheckSearchGoods').value = '';
  $('checkBookSingle').value = '';
  $('checkBook1').value = '';
  $('checkBook2').value = '';
  $('stockCheckUnit').value = '';
  $('checkRealSingle').value = '';
  $('checkReal1').value = '';
  $('checkReal2').value = '';
  $('checkDiff').value = '';
  $('stockCheckReason').selectedIndex = 0;
  $('stockCheckRemark').value = '';
  $('checkSingleRow').style.display = 'block';
  $('checkMultiRow').style.display = 'none';
  $('realSingleRow').style.display = 'block';
  $('realMultiRow').style.display = 'none';
  $('homePage').style.display = 'none';
  $('stockCheckPage').style.display = 'block';
};

// ç±»å‹ç®¡ç†
// è·å–å½“å‰ç”¨æˆ·çš„å­˜å‚¨é”®
function getStorageKey(key) {
  if (isLocalMode && currentUser) {
    return `${key}_${currentUser}`;
  }
  return key;
}

// ä¿å­˜å•†å“æ•°æ®
function saveData() {
  localStorage.setItem(getStorageKey('goodsList'), JSON.stringify(goodsList));
  syncToCloud(); // åŒæ­¥åˆ°äº‘ç«¯
}

function saveTypeData() {
  localStorage.setItem(getStorageKey('typeData'), JSON.stringify(typeData));
  renderTypeList();
  syncAllSelect();
  renderHomeTabs();
  syncToCloud(); // åŒæ­¥åˆ°äº‘ç«¯
}
function showToast(t) {
  $('deleteToast').innerText = t;
  $('deleteToast').style.display = 'block';
  setTimeout(() => $('deleteToast').style.display = 'none', 1500);
}
function renderTypeList() {
  const c = $('typeList');
  if (!c) return;
  c.innerHTML = '';
  typeData.mainTypes.forEach(m => {
    const div = document.createElement('div');
    div.className = 'main-type-item';
    div.dataset.type = m;
    div.innerHTML = `
      <div class="main-type-header">
        <div class="main-type-name">${m}</div>
        <input class="main-type-input" value="${m}" readonly>
        <div class="main-type-actions">
          <div class="action-btn btn-edit">âœï¸</div>
          <div class="action-btn btn-save">ğŸ’¾</div>
          <div class="action-btn btn-cancel">Ã—</div>
          <div class="action-btn btn-add-sub">ğŸ“‚</div>
          <div class="action-btn btn-delete-main">ğŸ—‘ï¸</div>
        </div>
      </div>
      <div class="sub-type-list" id="subList-${m}"></div>
    `;
    c.appendChild(div);
  });
  bindTypeEvents();
  renderAllSubTypes();
}
function bindTypeEvents() {
  document.querySelectorAll('.main-type-item').forEach(it => {
    const m = it.dataset.type;
    const name = it.querySelector('.main-type-name');
    const input = it.querySelector('.main-type-input');
    const edit = it.querySelector('.btn-edit');
    const save = it.querySelector('.btn-save');
    const cancel = it.querySelector('.btn-cancel');
    const del = it.querySelector('.btn-delete-main');
    const sub = it.querySelector('.btn-add-sub');
    if (!name || !input || !edit || !save || !cancel || !del || !sub) return;

    edit.onclick = () => {
      name.style.display = 'none';
      input.style.display = 'block';
      edit.style.display = 'none';
      save.style.display = 'flex';
      cancel.style.display = 'flex';
    };
    cancel.onclick = () => {
      input.value = m;
      name.style.display = 'block';
      input.style.display = 'none';
      edit.style.display = 'flex';
      save.style.display = 'none';
      cancel.style.display = 'none';
    };
    save.onclick = () => {
      const nn = (input.value || '').trim();
      if (!nn || typeData.mainTypes.includes(nn)) return showToast('åç§°é‡å¤æˆ–ä¸ºç©º');
      typeData.subTypes[nn] = typeData.subTypes[m];
      delete typeData.subTypes[m];
      typeData.mainTypes = typeData.mainTypes.map(t => t === m ? nn : t);
      saveTypeData();
      showToast('ä¿®æ”¹æˆåŠŸ');
    };
    del.onclick = () => {
      if (typeData.mainTypes.length <= 1) return showToast('è‡³å°‘ä¿ç•™ä¸€ä¸ª');
      if (!confirm(`ç¡®å®šè¦åˆ é™¤å¤§ç±»å‹"${m}"å—ï¼Ÿè¯¥ç±»å‹ä¸‹çš„æ‰€æœ‰å­ç±»å‹ä¹Ÿå°†è¢«åˆ é™¤ã€‚`)) return;
      typeData.mainTypes = typeData.mainTypes.filter(t => t !== m);
      delete typeData.subTypes[m];
      saveTypeData();
      showToast('åˆ é™¤æˆåŠŸ');
    };
    sub.onclick = () => {
      currentMainType = m;
      $('subModalTitle').innerText = `ã€${m}ã€‘æ·»åŠ å­ç±»å‹`;
      $('subTypeModal').style.display = 'flex';
    };
  });
}
function renderAllSubTypes() {
  typeData.mainTypes.forEach(m => {
    const c = $(`subList-${m}`);
    if (!c) return;
    c.innerHTML = '';
    (typeData.subTypes[m] || []).forEach(s => {
      const d = document.createElement('div');
      d.className = 'sub-type-item';
      d.innerHTML = `
        <div class="sub-type-name">${s}</div>
        <div style="display:flex;gap:5px;">
          <div class="action-btn btn-del-sub">ğŸ—‘ï¸</div>
        </div>
      `;
      c.appendChild(d);
      const del = d.querySelector('.btn-del-sub');
      if (del) {
        del.onclick = () => {
          if (!confirm(`ç¡®å®šè¦åˆ é™¤å­ç±»å‹"${s}"å—ï¼Ÿ`)) return;
          typeData.subTypes[m] = typeData.subTypes[m].filter(x => x !== s);
          saveTypeData();
          showToast('å­ç±»å‹å·²åˆ é™¤');
        };
      }
    });
  });
}

$('addMainType').onclick = () => {
  const n = ($('newTypeName').value || '').trim();
  if (!n || typeData.mainTypes.includes(n)) return showToast('åç§°é‡å¤æˆ–ä¸ºç©º');
  typeData.mainTypes.push(n);
  typeData.subTypes[n] = [];
  $('newTypeName').value = '';
  saveTypeData();
  showToast('æ·»åŠ æˆåŠŸ');
};
$('addSubTypeBtn').onclick = () => {
  const n = ($('newSubTypeName').value || '').trim();
  if (!n || (typeData.subTypes[currentMainType] || []).includes(n)) return showToast('å­ç±»å‹é‡å¤æˆ–ä¸ºç©º');
  typeData.subTypes[currentMainType].push(n);
  $('newSubTypeName').value = '';
  saveTypeData();
  showToast('å­ç±»å‹æ·»åŠ æˆåŠŸ');
};

$('openTypeModal').onclick = () => {
  $('typeModal').style.display = 'flex';
  renderTypeList();
};
$('closeMainModal').onclick = () => { $('typeModal').style.display = 'none'; }
$('closeSubModal').onclick = () => { $('subTypeModal').style.display = 'none'; }

// å…¥åº“ä¿å­˜
$('saveStockIn').onclick = () => {
  const goodsName = ($('stockInSearchGoods').value || '').trim();
  if (!goodsName) {
    alert('è¯·é€‰æ‹©å•†å“');
    return;
  }
  
  // æ‰¾åˆ°å•†å“
  const goodsIndex = goodsList.findIndex(g => g.name === goodsName);
  if (goodsIndex === -1) {
    alert('å•†å“ä¸å­˜åœ¨');
    return;
  }
  
  // è®¡ç®—å…¥åº“æ•°é‡å’Œé‡‘é¢
  const item = goodsList[goodsIndex];
  const hasConvert = item.unitText && item.unitText.includes('(');
  let stockInQty = 0;
  
  if (hasConvert) {
    const rate = item.unitRate || 1;
    stockInQty = (+$('stockInNum1').value || 0) * rate + (+$('stockInNum2').value || 0);
  } else {
    stockInQty = +$('stockInSingleQty').value || 0;
  }
  
  if (stockInQty <= 0) {
    alert('è¯·è¾“å…¥å…¥åº“æ•°é‡');
    return;
  }
  
  // è®¡ç®—å…¥åº“å•ä»·å’Œé‡‘é¢
  const stockInPrice = +$('stockInPrice').value || 0;
  const stockInAmount = stockInQty * stockInPrice;
  
  // åŠ æƒå¹³å‡è®¡ç®—æ–°å•ä»·
  const currentQty = goodsList[goodsIndex].qty || 0;
  const currentPrice = goodsList[goodsIndex].price || 0;
  const currentAmount = currentQty * currentPrice;
  
  const newTotalQty = currentQty + stockInQty;
  const newTotalAmount = currentAmount + stockInAmount;
  const newAvgPrice = newTotalQty > 0 ? newTotalAmount / newTotalQty : 0;
  
  // æ›´æ–°å•†å“åº“å­˜å’ŒåŠ æƒå¹³å‡å•ä»·
  goodsList[goodsIndex].qty = newTotalQty;
  goodsList[goodsIndex].price = newAvgPrice;
  goodsList[goodsIndex].stockTime = $('stockInTime').value || new Date().toISOString().split('T')[0];
  
  // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
  saveData();

  // åˆ·æ–°å•†å“åˆ—è¡¨æ˜¾ç¤º
  renderGoodsList();

  alert('å…¥åº“ä¿å­˜æˆåŠŸ');

  // æ¸…ç©ºå…¥åº“å•æ‰€æœ‰æ•°æ®
  $('stockInSearchGoods').value = '';
  $('stockInSpec').value = '';
  $('stockInSingleQty').value = '';
  $('stockInNum1').value = '';
  $('stockInNum2').value = '';
  $('stockInUnit').value = '';
  $('stockInPrice').value = '';
  $('stockInAmount').value = '';
  $('stockInTime').value = new Date().toISOString().split('T')[0];
  $('stockInRemark').value = '';
  $('stockInSingleRow').style.display = 'block';
  $('stockInMultiRow').style.display = 'none';
  // é‡ç½®å•ä½æ ‡ç­¾
  $('stockInBigUnit').textContent = 'å¤§';
  $('stockInSmallUnit').textContent = 'å°';
};

// å‡ºåº“ä¿å­˜
$('saveStockOut').onclick = () => {
  const goodsName = ($('stockOutSearchGoods').value || '').trim();
  if (!goodsName) {
    alert('è¯·é€‰æ‹©å•†å“');
    return;
  }
  
  // æ‰¾åˆ°å•†å“
  const goodsIndex = goodsList.findIndex(g => g.name === goodsName);
  if (goodsIndex === -1) {
    alert('å•†å“ä¸å­˜åœ¨');
    return;
  }
  
  // è®¡ç®—å‡ºåº“æ•°é‡
  const item = goodsList[goodsIndex];
  const hasConvert = item.unitText && item.unitText.includes('(');
  let stockOutQty = 0;
  
  if (hasConvert) {
    const rate = item.unitRate || 1;
    stockOutQty = (+$('stockOutNum1').value || 0) * rate + (+$('stockOutNum2').value || 0);
  } else {
    stockOutQty = +$('stockOutSingleQty').value || 0;
  }
  
  if (stockOutQty <= 0) {
    alert('è¯·è¾“å…¥å‡ºåº“æ•°é‡');
    return;
  }
  
  // æ£€æŸ¥åº“å­˜æ˜¯å¦è¶³å¤Ÿ
  const currentQty = goodsList[goodsIndex].qty || 0;
  if (stockOutQty > currentQty) {
    alert('åº“å­˜ä¸è¶³ï¼Œå½“å‰åº“å­˜ï¼š' + currentQty);
    return;
  }
  
  // æŒ‰åŠ æƒå¹³å‡æˆæœ¬è®¡ç®—å‡ºåº“é‡‘é¢ï¼ˆå•ä»·ä¸å˜ï¼‰
  const currentPrice = goodsList[goodsIndex].price || 0;
  const stockOutAmount = stockOutQty * currentPrice;
  
  // æ›´æ–°å•†å“åº“å­˜
  goodsList[goodsIndex].qty = currentQty - stockOutQty;
  
  // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
  saveData();

  // åˆ·æ–°å•†å“åˆ—è¡¨æ˜¾ç¤º
  renderGoodsList();

  alert('å‡ºåº“ä¿å­˜æˆåŠŸ');

  // æ¸…ç©ºå‡ºåº“å•æ‰€æœ‰æ•°æ®
  $('stockOutSearchGoods').value = '';
  $('stockOutSpec').value = '';
  $('stockOutSingleQty').value = '';
  $('stockOutNum1').value = '';
  $('stockOutNum2').value = '';
  $('stockOutUnit').value = '';
  $('stockOutPrice').value = '';
  $('stockOutAmount').value = '';
  $('stockOutTime').value = new Date().toISOString().split('T')[0];
  $('stockOutRemark').value = '';
  $('stockOutSingleRow').style.display = 'block';
  $('stockOutMultiRow').style.display = 'none';
  // é‡ç½®å•ä½æ ‡ç­¾
  $('stockOutBigUnit').textContent = 'å¤§';
  $('stockOutSmallUnit').textContent = 'å°';
};

// ç›˜ç‚¹ä¿å­˜åæ¸…ç©º
$('saveStockCheck').onclick = () => {
  const name = ($('stockCheckSearchGoods').value || '').trim();
  if (!name) { alert('è¯·é€‰æ‹©å•†å“'); return; }
  
  const item = goodsList.find(g => g.name === name);
  if (!item) { alert('å•†å“ä¸å­˜åœ¨'); return; }
  
  const hasConvert = item.unitText && item.unitText.trim() !== '' && item.unitText.trim() !== 'ç‚¹å‡»âš™ï¸è®¾ç½®' && item.unitText.includes('(');
  const rate = item.unitRate || 1;
  
  // è®¡ç®—å®ç›˜æ€»æ•°é‡
  let realQty;
  if (hasConvert) {
    realQty = (+$('checkReal1').value || 0) * rate + (+$('checkReal2').value || 0);
  } else {
    realQty = +$('checkRealSingle').value || 0;
  }
  
  // æ›´æ–°å•†å“åº“å­˜
  item.qty = realQty;
  saveData();
  
  // æ·»åŠ ç›˜ç‚¹è®°å½•
  const record = {
    type: 'check',
    goodsName: name,
    goodsType: item.mainType,
    goodsSubType: item.subType,
    bookQty: hasConvert ? (+$('checkBook1').value || 0) * rate + (+$('checkBook2').value || 0) : (+$('checkBookSingle').value || 0),
    realQty: realQty,
    diff: realQty - (hasConvert ? (+$('checkBook1').value || 0) * rate + (+$('checkBook2').value || 0) : (+$('checkBookSingle').value || 0)),
    reason: $('stockCheckReason').value,
    remark: $('stockCheckRemark').value,
    time: new Date().toISOString().split('T')[0]
  };
  
  if (!window.stockRecords) window.stockRecords = [];
  window.stockRecords.push(record);
  localStorage.setItem('stockRecords', JSON.stringify(window.stockRecords));
  
  alert('ç›˜ç‚¹ä¿å­˜æˆåŠŸ');

  // åˆ·æ–°å•†å“åˆ—è¡¨æ˜¾ç¤º
  renderGoodsList();

  // æ¸…ç©ºç›˜ç‚¹å•æ‰€æœ‰æ•°æ®
  $('stockCheckSearchGoods').value = '';
  $('stockCheckSpec').value = '';
  $('stockCheckGoodsType').selectedIndex = 0;
  $('stockCheckGoodsSubType').innerHTML = '';
  $('checkBookSingle').value = '';
  $('checkBook1').value = '';
  $('checkBook2').value = '';
  $('stockCheckUnit').value = '';
  $('checkRealSingle').value = '';
  $('checkReal1').value = '';
  $('checkReal2').value = '';
  $('checkDiff').value = '';
  $('stockCheckReason').selectedIndex = 0;
  $('stockCheckRemark').value = '';
  $('checkSingleRow').style.display = 'block';
  $('checkMultiRow').style.display = 'none';
  $('realSingleRow').style.display = 'block';
  $('realMultiRow').style.display = 'none';
  // é‡ç½®å•ä½æ ‡ç­¾
  $('checkBookBigUnit').textContent = 'å¤§';
  $('checkBookSmallUnit').textContent = 'å°';
  $('checkRealBigUnit').textContent = 'å¤§';
  $('checkRealSmallUnit').textContent = 'å°';
};

// æ¸²æŸ“ä¸»é¡µç±»å‹æ ‡ç­¾é¡µ
function renderHomeTabs() {
  const container = $('homeTabs');
  if (!container) return;
  
  const types = typeData.mainTypes || [];
  let html = '<div class="tab active" data-type="">å…¨éƒ¨</div>';
  
  types.forEach(type => {
    html += `<div class="tab" data-type="${type}">${type}</div>`;
  });
  
  container.innerHTML = html;
  
  // ç»‘å®šç‚¹å‡»äº‹ä»¶
  container.querySelectorAll('.tab').forEach(tab => {
    tab.onclick = () => {
      container.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      
      const type = tab.dataset.type;
      filterGoodsByType(type);
    };
  });
}

// æ ¹æ®ç±»å‹ç­›é€‰å•†å“
function filterGoodsByType(type) {
  const container = $('goodsListContainer');
  const emptyTip = $('emptyTip');
  if (!container) return;
  
  // æ›´æ–°å•†å“ç§ç±»ç»Ÿè®¡
  const goodsCategoryCard = $('goodsCategoryCard');
  if (goodsCategoryCard) {
    const uniqueTypes = new Set(goodsList.map(g => g.mainType)).size;
    goodsCategoryCard.querySelector('div:last-child').textContent = uniqueTypes;
  }
  
  // ç­›é€‰å•†å“
  let filteredList = goodsList;
  if (type) {
    filteredList = goodsList.filter(item => item.mainType === type);
  }
  
  // æŒ‰ä¸»ç±»å‹->å­ç±»å‹->å•†å“åç§°æ’åº
  filteredList = sortGoodsList(filteredList);
  
  if (filteredList.length === 0) {
    container.innerHTML = type ? '<div style="text-align:center;padding:20px;color:#999;">è¯¥ç±»å‹æš‚æ— å•†å“</div>' : '';
    if (emptyTip && !type) emptyTip.style.display = 'block';
    return;
  }
  
  if (emptyTip) emptyTip.style.display = 'none';
  
  container.innerHTML = filteredList.map((item, index) => {
    const mainType = item.mainType || 'åŸææ–™';
    const subType = item.subType || '';
    const typeText = subType ? `${mainType} > ${subType}` : mainType;
    const stockTime = item.stockTime || new Date().toISOString().split('T')[0];
    const qty = item.qty || 0;

    // åˆ¤æ–­æ˜¯å¦æœ‰å•ä½æ¢ç®—
    const hasUnitConvert = item.unitText && item.unitText.includes('(');
    let qtyDisplay = '';
    let unitDisplay = '';

    if (hasUnitConvert && item.unitRate > 1) {
      // è§£æå¤§å•ä½å’Œå°å•ä½
      const match = item.unitText.match(/^(.+)\((\d+)(.+)\)$/);
      if (match) {
        const bigUnit = match[1];
        const rate = parseInt(match[2]) || 1;
        const smallUnit = match[3];

        // è®¡ç®—å¤§å•ä½æ•°é‡å’Œå°å•ä½æ•°é‡
        const bigQty = Math.floor(qty / rate);
        const smallQty = qty % rate;

        if (bigQty > 0 && smallQty > 0) {
          qtyDisplay = `${bigQty}${bigUnit}/${smallQty}`;
          unitDisplay = smallUnit;
        } else if (bigQty > 0) {
          qtyDisplay = `${bigQty}`;
          unitDisplay = bigUnit;
        } else {
          qtyDisplay = `${smallQty}`;
          unitDisplay = smallUnit;
        }
      } else {
        qtyDisplay = qty;
        unitDisplay = item.singleUnit || 'ä¸ª';
      }
    } else {
      qtyDisplay = qty;
      unitDisplay = item.singleUnit || 'ä¸ª';
    }

    // ä½¿ç”¨æ›´ç²¾ç¡®çš„æ–¹å¼æŸ¥æ‰¾åŸå§‹ç´¢å¼•
    const originalIndex = goodsList.findIndex(g => 
      g.name === item.name && 
      g.mainType === item.mainType && 
      g.subType === item.subType &&
      g.stockTime === item.stockTime
    );

    // æ„å»ºå•†å“åç§°æ˜¾ç¤ºï¼ˆåŒ…å«è§„æ ¼ï¼‰
    const specText = item.spec ? `<span style="color:#666;font-size:13px;font-weight:normal;margin-left:8px;">(${item.spec})</span>` : '';
    const nameDisplay = `${item.name}${specText}`;

    return `
      <div class="goods-card" data-index="${originalIndex}">
        <div class="goods-card-header">
          <div class="goods-card-name">${nameDisplay}</div>
          <div class="goods-card-edit" onclick="editGoods(${originalIndex})">âœï¸</div>
        </div>
        <div class="goods-card-type">${typeText}</div>
        <div class="goods-card-time">å…¥åº“æ—¶é—´ï¼š${stockTime}</div>
        <div class="goods-card-stock">
          <span class="goods-card-qty">${qtyDisplay}</span>
          <span class="goods-card-unit">${unitDisplay}</span>
        </div>
      </div>
    `;
  }).join('');
}

// åˆå§‹åŒ–å‡½æ•°
function init() {
  syncAllSelect();
  refreshAddUnitView();
  renderHomeTabs();
  renderGoodsList();
  updateImportExportStats();
}

// åªæœ‰åœ¨å·²ç™»å½•çŠ¶æ€ä¸‹æ‰åˆå§‹åŒ–
if ((isLocalMode && currentUser) || (authToken && !isLocalMode)) {
  init();
}

// ç‚¹å‡»åº“å­˜æ˜ç»†å¡ç‰‡è·³è½¬åˆ°åº“å­˜æ˜ç»†é¡µé¢
$('stockDetailCard').onclick = () => {
  renderStockDetailList();
  $('homePage').style.display = 'none';
  $('goodsListPage').style.display = 'block';
};

// ç‚¹å‡»ä½åº“å­˜é¢„è­¦å¡ç‰‡è·³è½¬åˆ°ä½åº“å­˜é¢„è­¦é¡µé¢
$('lowStockCard').onclick = () => {
  renderLowStockList();
  $('homePage').style.display = 'none';
  $('lowStockPage').style.display = 'block';
};

// è¿”å›ä¸»é¡µï¼ˆä»ä½åº“å­˜é¢„è­¦ï¼‰
$('backToHomeFromLowStock').onclick = () => {
  $('lowStockPage').style.display = 'none';
  $('homePage').style.display = 'block';
};

// å…³é—­ä½åº“å­˜é¢„è­¦é¡µé¢
$('closeLowStockPage').onclick = () => {
  $('lowStockPage').style.display = 'none';
  $('homePage').style.display = 'block';
};

// ç‚¹å‡»å…¥åº“é¢„è­¦å¡ç‰‡è·³è½¬åˆ°å…¥åº“é¢„è­¦é¡µé¢
$('stockInWarnCard').onclick = () => {
  renderStockInWarnList();
  $('homePage').style.display = 'none';
  $('stockInWarnPage').style.display = 'block';
};

// è¿”å›ä¸»é¡µï¼ˆä»å…¥åº“é¢„è­¦ï¼‰
$('backToHomeFromStockInWarn').onclick = () => {
  $('stockInWarnPage').style.display = 'none';
  $('homePage').style.display = 'block';
};

// å…³é—­å…¥åº“é¢„è­¦é¡µé¢
$('closeStockInWarnPage').onclick = () => {
  $('stockInWarnPage').style.display = 'none';
  $('homePage').style.display = 'block';
};

// æ¸²æŸ“ä½åº“å­˜é¢„è­¦åˆ—è¡¨
function renderLowStockList() {
  const container = $('lowStockListContainer');
  if (!container) return;
  
  const lowStockItems = goodsList.filter(g => {
    // ä½¿ç”¨å•†å“è‡ªå·±çš„é¢„è­¦é˜ˆå€¼ï¼Œé»˜è®¤ä¸º1
    const goodsWarnThreshold = g.warnThreshold || 1;
    const hasUnitConvert = g.unitText && g.unitText.includes('(') && g.unitRate > 1;
    
    if (hasUnitConvert) {
      // æœ‰å•ä½æ¢ç®—çš„ï¼Œä»¥å¤§å•ä½æ•°é‡åˆ¤æ–­
      const match = g.unitText.match(/^(.+)\((\d+)(.+)\)$/);
      if (match) {
        const rate = parseInt(match[2]) || 1;
        const totalQty = g.qty || 0;
        const bigQty = Math.floor(totalQty / rate);
        return bigQty < goodsWarnThreshold;
      }
    }
    // æ— å•ä½æ¢ç®—çš„ï¼ŒæŒ‰åŸæ•°é‡åˆ¤æ–­
    return (g.qty || 0) < goodsWarnThreshold;
  });
  
  if (lowStockItems.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">æš‚æ— ä½åº“å­˜é¢„è­¦å•†å“</div>';
    return;
  }
  
  container.innerHTML = lowStockItems.map((item, index) => {
    const originalIndex = goodsList.findIndex(g => g.name === item.name && g.stockTime === item.stockTime);
    const subType = item.subType || '-';
    
    // å¤„ç†åº“å­˜æ˜¾ç¤º - å¤§å•ä½/å°å•ä½æ ¼å¼
    let qtyDisplay = '';
    const hasUnitConvert = item.unitText && item.unitText.includes('(') && item.unitRate > 1;
    
    if (hasUnitConvert) {
      const match = item.unitText.match(/^(.+)\((\d+)(.+)\)$/);
      if (match) {
        const bigUnit = match[1];
        const rate = parseInt(match[2]) || 1;
        const smallUnit = match[3];
        const totalQty = item.qty || 0;
        const bigQty = Math.floor(totalQty / rate);
        const smallQty = totalQty % rate;
        qtyDisplay = `${bigQty}${bigUnit}/${smallQty}${smallUnit}`;
      } else {
        qtyDisplay = `${item.qty || 0}${item.singleUnit || 'ä¸ª'}`;
      }
    } else {
      qtyDisplay = `${item.qty || 0}${item.singleUnit || 'ä¸ª'}`;
    }
    
    // ä½¿ç”¨å•†å“è‡ªå·±çš„é¢„è­¦é˜ˆå€¼æ˜¾ç¤º
    const goodsWarnThreshold = item.warnThreshold || 1;
    
    return `
      <div class="low-stock-item" style="background:#ffebee;border:2px solid #e53935;border-radius:8px;padding:15px;margin-bottom:15px;cursor:pointer;" onclick="editGoods(${originalIndex}); $('lowStockPage').style.display = 'none'; $('homePage').style.display = 'block';">
        <div style="font-size:18px;font-weight:600;margin-bottom:8px;">${item.name}</div>
        <div style="color:#666;margin-bottom:10px;">${item.mainType} > ${subType}</div>
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-size:12px;color:#666;">å½“å‰åº“å­˜</div>
            <div style="font-size:24px;font-weight:700;margin-top:4px;color:#e53935;">${qtyDisplay}</div>
          </div>
          <div style="text-align:right;">
            <div style="font-size:12px;color:#666;">é¢„è­¦é˜ˆå€¼</div>
            <div style="font-size:20px;font-weight:700;margin-top:4px;color:#e53935;">${goodsWarnThreshold}</div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

// æ¸²æŸ“å…¥åº“æ—¶é—´é¢„è­¦åˆ—è¡¨
function renderStockInWarnList() {
  const container = $('stockInWarnListContainer');
  if (!container) return;
  
  const today = new Date();
  
  const warnItems = goodsList.filter(g => {
    if (!g.stockTime) return false;
    // å¦‚æœè®¾ç½®äº†é¢„è­¦æ—¥æœŸï¼ŒæŒ‰é¢„è­¦æ—¥æœŸåˆ¤æ–­
    if (g.warnDate) {
      const warnDate = new Date(g.warnDate);
      return today > warnDate;
    }
    // å¦åˆ™æŒ‰å…¥åº“æ—¶é—´+é¢„è­¦å¤©æ•°åˆ¤æ–­
    const stockDate = new Date(g.stockTime);
    const diffDays = Math.floor((today - stockDate) / (1000 * 60 * 60 * 24));
    const globalWarnDays = parseInt(localStorage.getItem('stockWarnDays') || '90');
    const goodsWarnDays = g.stockInWarnDays || globalWarnDays;
    return diffDays > goodsWarnDays;
  }).sort((a, b) => {
    const dateA = new Date(a.stockTime || 0);
    const dateB = new Date(b.stockTime || 0);
    return dateA - dateB;
  });
  
  if (warnItems.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">æš‚æ— å…¥åº“æ—¶é—´é¢„è­¦å•†å“</div>';
    return;
  }
  
  container.innerHTML = warnItems.map((item, index) => {
    const originalIndex = goodsList.findIndex(g => g.name === item.name && g.stockTime === item.stockTime);
    const subType = item.subType || '-';
    const stockDate = new Date(item.stockTime);
    const diffDays = Math.floor((today - stockDate) / (1000 * 60 * 60 * 24));
    // è®¡ç®—è¶…æœŸå¤©æ•°
    let overDays = 0;
    if (item.warnDate) {
      // å¦‚æœè®¾ç½®äº†é¢„è­¦æ—¥æœŸï¼Œè®¡ç®—è¶…è¿‡é¢„è­¦æ—¥æœŸçš„å¤©æ•°
      const warnDate = new Date(item.warnDate);
      overDays = Math.floor((today - warnDate) / (1000 * 60 * 60 * 24));
    } else {
      // å¦åˆ™æŒ‰å…¥åº“æ—¶é—´+é¢„è­¦å¤©æ•°è®¡ç®—
      const globalWarnDays = parseInt(localStorage.getItem('stockWarnDays') || '90');
      const goodsWarnDays = item.stockInWarnDays || globalWarnDays;
      overDays = diffDays - goodsWarnDays;
    }
    
    // å¤„ç†åº“å­˜æ˜¾ç¤º - å¤§å•ä½/å°å•ä½æ ¼å¼
    let qtyDisplay = '';
    const hasUnitConvert = item.unitText && item.unitText.includes('(') && item.unitRate > 1;
    
    if (hasUnitConvert) {
      const match = item.unitText.match(/^(.+)\((\d+)(.+)\)$/);
      if (match) {
        const bigUnit = match[1];
        const rate = parseInt(match[2]) || 1;
        const smallUnit = match[3];
        const totalQty = item.qty || 0;
        const bigQty = Math.floor(totalQty / rate);
        const smallQty = totalQty % rate;
        qtyDisplay = `${bigQty}${bigUnit}/${smallQty}${smallUnit}`;
      } else {
        qtyDisplay = `${item.qty || 0}${item.singleUnit || 'ä¸ª'}`;
      }
    } else {
      qtyDisplay = `${item.qty || 0}${item.singleUnit || 'ä¸ª'}`;
    }
    
    return `
      <div class="stock-in-warn-item" style="background:#fff3e0;border:2px solid #ff9800;border-radius:8px;padding:15px;margin-bottom:15px;cursor:pointer;" onclick="editGoods(${originalIndex}); $('stockInWarnPage').style.display = 'none'; $('homePage').style.display = 'block';">
        <div style="font-size:18px;font-weight:600;margin-bottom:8px;">${item.name}</div>
        <div style="color:#666;margin-bottom:10px;">${item.mainType} > ${subType}</div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <div>
            <div style="font-size:12px;color:#666;">å½“å‰åº“å­˜</div>
            <div style="font-size:24px;font-weight:700;margin-top:4px;">${qtyDisplay}</div>
          </div>
          <div style="text-align:right;">
            <div style="font-size:12px;color:#666;">å…¥åº“å¤©æ•°</div>
            <div style="font-size:24px;font-weight:700;margin-top:4px;color:#e53935;">${diffDays}å¤©</div>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:5px;color:#ff6f00;font-size:13px;">
          <span>âš ï¸</span>
          <span>æ—¥æœŸè¶…è¿‡${overDays}å¤©</span>
        </div>
      </div>
    `;
  }).join('');
}

// è¿”å›ä¸»é¡µ
$('backToHomeFromList').onclick = () => {
  $('goodsListPage').style.display = 'none';
  $('homePage').style.display = 'block';
};

// æ¸²æŸ“åº“å­˜æ˜ç»†åˆ—è¡¨ï¼ˆæŒ‰çˆ¶ç±»å‹åˆ†ç±»å±•ç¤ºï¼‰
function renderStockDetailList() {
  const container = $('stockDetailListContainer');
  if (!container) return;

  if (goodsList.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">æš‚æ— å•†å“æ•°æ®</div>';
    return;
  }

  // æŒ‰çˆ¶ç±»å‹åˆ†ç»„
  const groupedByType = {};
  goodsList.forEach((item, index) => {
    const mainType = item.mainType || 'æœªåˆ†ç±»';
    if (!groupedByType[mainType]) {
      groupedByType[mainType] = [];
    }
    groupedByType[mainType].push({ ...item, originalIndex: index });
  });

  // æ¸²æŸ“åˆ†ç»„æ•°æ®
  let html = '';
  Object.keys(groupedByType).sort().forEach(mainType => {
    const items = groupedByType[mainType];
    
    // çˆ¶ç±»å‹æ ‡é¢˜
    html += `
      <div class="type-section" style="margin-bottom:20px;min-width:600px;">
        <div class="type-header" style="background:#f5f5f5;padding:12px 15px;font-size:16px;font-weight:600;color:#333;border-left:4px solid #2196f3;margin-bottom:10px;white-space:nowrap;">
          ${mainType}
        </div>
        <div class="table-header" style="display:flex;padding:10px 0;border-bottom:1px solid #e0e0e0;font-weight:600;font-size:14px;">
          <div style="flex:2;padding:0 10px;">å•†å“åç§°</div>
          <div style="flex:1;padding:0 10px;text-align:center;">è§„æ ¼</div>
          <div style="flex:1;padding:0 10px;text-align:center;">å­ç±»å‹</div>
          <div style="flex:1;padding:0 10px;text-align:center;">æ•°é‡</div>
          <div style="flex:1;padding:0 10px;text-align:center;">å•ä½</div>
          <div style="flex:1;padding:0 10px;text-align:center;">å•ä»·</div>
          <div style="flex:1;padding:0 10px;text-align:center;">é‡‘é¢</div>
        </div>
    `;
    
    // è¯¥ç±»å‹ä¸‹çš„å•†å“
    html += items.map(item => {
      const subType = item.subType || '-';
      const price = item.price || 0;
      
      // åˆ¤æ–­æ˜¯å¦æœ‰å•ä½æ¢ç®—
      const hasUnitConvert = item.unitText && item.unitText.includes('(') && item.unitRate > 1;
      let qtyDisplay = '';
      let unitDisplay = '';
      let amount = 0;
      
      if (hasUnitConvert) {
        // è§£æå¤§å•ä½å’Œå°å•ä½
        const match = item.unitText.match(/^(.+)\((\d+)(.+)\)$/);
        if (match) {
          const bigUnit = match[1];
          const rate = parseInt(match[2]) || 1;
          const smallUnit = match[3];
          const qty = item.qty || 0;
          
          // è®¡ç®—å¤§å•ä½æ•°é‡å’Œå°å•ä½æ•°é‡
          const bigQty = Math.floor(qty / rate);
          const smallQty = qty % rate;
          
          if (bigQty > 0 && smallQty > 0) {
            qtyDisplay = `${bigQty}/${smallQty}`;
            unitDisplay = `${bigUnit}/${smallUnit}`;
          } else if (bigQty > 0) {
            qtyDisplay = `${bigQty}`;
            unitDisplay = bigUnit;
          } else {
            qtyDisplay = `${smallQty}`;
            unitDisplay = smallUnit;
          }
          amount = (qty * price).toFixed(2);
        } else {
          qtyDisplay = item.qty || 0;
          unitDisplay = item.singleUnit || 'ä¸ª';
          amount = ((item.qty || 0) * price).toFixed(2);
        }
      } else {
        qtyDisplay = item.qty || 0;
        unitDisplay = item.singleUnit || 'ä¸ª';
        amount = ((item.qty || 0) * price).toFixed(2);
      }

      const spec = item.spec || '-';
      return `
        <div class="goods-item" data-index="${item.originalIndex}" style="display:flex;padding:10px 0;border-bottom:1px solid #f0f0f0;align-items:center;font-size:14px;">
          <div style="flex:2;padding:0 10px;">${item.name}</div>
          <div style="flex:1;padding:0 10px;text-align:center;">${spec}</div>
          <div style="flex:1;padding:0 10px;text-align:center;">${subType}</div>
          <div style="flex:1;padding:0 10px;text-align:right;">${qtyDisplay}</div>
          <div style="flex:1;padding:0 10px;text-align:center;">${unitDisplay}</div>
          <div style="flex:1;padding:0 10px;text-align:right;">${price.toFixed(3)}</div>
          <div style="flex:1;padding:0 10px;text-align:right;">${amount}</div>
        </div>
      `;
    }).join('');
    
    html += '</div>';
  });

  container.innerHTML = html;
}

// æœç´¢åŠŸèƒ½
$('searchGoods').oninput = () => {
  const keyword = ($('searchGoods').value || '').trim().toLowerCase();
  const container = $('stockDetailListContainer');
  if (!container) return;

  if (!keyword) {
    renderStockDetailList();
    return;
  }

  const filtered = goodsList.filter(item =>
    (item.name || '').toLowerCase().includes(keyword) ||
    (item.subType || '').toLowerCase().includes(keyword) ||
    (item.mainType || '').toLowerCase().includes(keyword)
  );

  if (filtered.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">æœªæ‰¾åˆ°åŒ¹é…çš„å•†å“</div>';
    return;
  }

  // æŒ‰çˆ¶ç±»å‹åˆ†ç»„å±•ç¤ºæœç´¢ç»“æœ
  const groupedByType = {};
  filtered.forEach((item, index) => {
    const mainType = item.mainType || 'æœªåˆ†ç±»';
    if (!groupedByType[mainType]) {
      groupedByType[mainType] = [];
    }
    // æ‰¾åˆ°åŸå§‹ç´¢å¼•
    const originalIndex = goodsList.findIndex(g => g.name === item.name && g.mainType === item.mainType && g.subType === item.subType);
    groupedByType[mainType].push({ ...item, originalIndex });
  });

  let html = '';
  Object.keys(groupedByType).sort().forEach(mainType => {
    const items = groupedByType[mainType];

    html += `
      <div class="type-section" style="margin-bottom:20px;min-width:600px;">
        <div class="type-header" style="background:#f5f5f5;padding:12px 15px;font-size:16px;font-weight:600;color:#333;border-left:4px solid #2196f3;margin-bottom:10px;white-space:nowrap;">
          ${mainType}
        </div>
        <div class="table-header" style="display:flex;padding:10px 0;border-bottom:1px solid #e0e0e0;font-weight:600;font-size:14px;">
          <div style="flex:2;padding:0 10px;">å•†å“åç§°</div>
          <div style="flex:1;padding:0 10px;text-align:center;">è§„æ ¼</div>
          <div style="flex:1;padding:0 10px;text-align:center;">å­ç±»å‹</div>
          <div style="flex:1;padding:0 10px;text-align:center;">æ•°é‡</div>
          <div style="flex:1;padding:0 10px;text-align:center;">å•ä½</div>
          <div style="flex:1;padding:0 10px;text-align:center;">å•ä»·</div>
          <div style="flex:1;padding:0 10px;text-align:center;">é‡‘é¢</div>
        </div>
    `;

    html += items.map(item => {
      const subType = item.subType || '-';
      const price = item.price || 0;
      const spec = item.spec || '-';

      const hasUnitConvert = item.unitText && item.unitText.includes('(') && item.unitRate > 1;
      let qtyDisplay = '';
      let unitDisplay = '';
      let amount = 0;

      if (hasUnitConvert) {
        const match = item.unitText.match(/^(.+)\((\d+)(.+)\)$/);
        if (match) {
          const bigUnit = match[1];
          const rate = parseInt(match[2]) || 1;
          const smallUnit = match[3];
          const qty = item.qty || 0;

          const bigQty = Math.floor(qty / rate);
          const smallQty = qty % rate;

          if (bigQty > 0 && smallQty > 0) {
            qtyDisplay = `${bigQty}/${smallQty}`;
            unitDisplay = `${bigUnit}/${smallUnit}`;
          } else if (bigQty > 0) {
            qtyDisplay = `${bigQty}`;
            unitDisplay = bigUnit;
          } else {
            qtyDisplay = `${smallQty}`;
            unitDisplay = smallUnit;
          }
          amount = (qty * price).toFixed(2);
        } else {
          qtyDisplay = item.qty || 0;
          unitDisplay = item.singleUnit || 'ä¸ª';
          amount = ((item.qty || 0) * price).toFixed(2);
        }
      } else {
        qtyDisplay = item.qty || 0;
        unitDisplay = item.singleUnit || 'ä¸ª';
        amount = ((item.qty || 0) * price).toFixed(2);
      }

      return `
        <div class="goods-item" data-index="${item.originalIndex}" style="display:flex;padding:10px 0;border-bottom:1px solid #f0f0f0;align-items:center;font-size:14px;">
          <div style="flex:2;padding:0 10px;">${item.name}</div>
          <div style="flex:1;padding:0 10px;text-align:center;">${spec}</div>
          <div style="flex:1;padding:0 10px;text-align:center;">${subType}</div>
          <div style="flex:1;padding:0 10px;text-align:right;">${qtyDisplay}</div>
          <div style="flex:1;padding:0 10px;text-align:center;">${unitDisplay}</div>
          <div style="flex:1;padding:0 10px;text-align:right;">${price.toFixed(3)}</div>
          <div style="flex:1;padding:0 10px;text-align:right;">${amount}</div>
        </div>
      `;
    }).join('');

    html += '</div>';
  });

  container.innerHTML = html;
};

// ç‚¹å‡»å•†å“ç§ç±»å¡ç‰‡æ˜¾ç¤ºç±»å‹å¼¹çª—
$('goodsCategoryCard').onclick = () => {
  renderCategoryList();
  $('goodsCategoryModal').style.display = 'flex';
};

// å…³é—­ç±»å‹å¼¹çª—
$('closeCategoryModal').onclick = () => {
  $('goodsCategoryModal').style.display = 'none';
};

$('closeCategoryBtn').onclick = () => {
  $('goodsCategoryModal').style.display = 'none';
};

// æ¸²æŸ“ç±»å‹åˆ—è¡¨
function renderCategoryList() {
  const container = $('categoryListContainer');
  if (!container) return;

  let html = '';
  
  typeData.mainTypes.forEach(mainType => {
    // ç»Ÿè®¡è¯¥å¤§ç±»å‹çš„å•†å“æ•°é‡å’Œæ€»åº“å­˜
    const mainTypeGoods = goodsList.filter(g => g.mainType === mainType);
    const mainTypeCount = mainTypeGoods.length;
    const mainTypeTotalQty = mainTypeGoods.reduce((sum, g) => sum + (g.qty || 0), 0);
    
    // è·å–å­ç±»å‹åˆ—è¡¨
    const subTypes = typeData.subTypes[mainType] || [];
    
    html += `
      <div class="category-main-item">
        <div class="category-main-header">
          <div class="main-type-left">
            <div class="main-type-name">${mainType}</div>
            <div class="main-type-count">${mainTypeCount} ç§å•†å“</div>
          </div>
          <div class="main-type-total">${mainTypeTotalQty}</div>
        </div>
        <div class="category-sub-list">
    `;
    
    // æ¸²æŸ“å­ç±»å‹
    subTypes.forEach(subType => {
      const subTypeGoods = goodsList.filter(g => g.mainType === mainType && g.subType === subType);
      const subTypeCount = subTypeGoods.length;
      const subTypeTotalQty = subTypeGoods.reduce((sum, g) => sum + (g.qty || 0), 0);
      
      html += `
        <div class="category-sub-item">
          <div class="category-sub-name">${subType}</div>
          <div class="category-sub-info">
            <span class="category-sub-qty">${subTypeTotalQty}</span>
            <span class="category-sub-count">(${subTypeCount})</span>
          </div>
        </div>
      `;
    });
    
    html += `
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

// ä¸»é¡µæœç´¢å•†å“åŠŸèƒ½ - ä¸‹æ‹‰åˆ—è¡¨æ ·å¼
const homeSearchGoods = $('homeSearchGoods');
const homeSearchDropdown = $('homeSearchDropdown');

if (homeSearchGoods && homeSearchDropdown) {
  homeSearchGoods.oninput = () => {
    const keyword = (homeSearchGoods.value || '').trim().toLowerCase();
    
    if (!keyword) {
      homeSearchDropdown.style.display = 'none';
      homeSearchDropdown.innerHTML = '';
      return;
    }
    
    // ç­›é€‰å•†å“
    const filtered = goodsList.filter(item =>
      (item.name || '').toLowerCase().includes(keyword) ||
      (item.mainType || '').toLowerCase().includes(keyword) ||
      (item.subType || '').toLowerCase().includes(keyword)
    );
    
    if (filtered.length === 0) {
      homeSearchDropdown.innerHTML = '<div style="padding:12px;color:#999;text-align:center;">æœªæ‰¾åˆ°åŒ¹é…çš„å•†å“</div>';
      homeSearchDropdown.style.display = 'block';
      return;
    }
    
    // æ¸²æŸ“ä¸‹æ‹‰åˆ—è¡¨
    homeSearchDropdown.innerHTML = filtered.map((item, index) => {
      const originalIndex = goodsList.findIndex(g => g.name === item.name && g.stockTime === item.stockTime);
      const subType = item.subType || '-';
      const qty = item.qty || 0;
      const unit = item.singleUnit || 'ä¸ª';
      
      return `
        <div class="home-search-item" data-index="${originalIndex}" style="padding:12px;border-bottom:1px solid #f0f0f0;cursor:pointer;display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-weight:600;color:#333;">${item.name}</div>
            <div style="font-size:12px;color:#666;margin-top:2px;">${item.mainType} > ${subType}</div>
          </div>
          <div style="text-align:right;">
            <div style="font-weight:600;color:#000;">${qty} ${unit}</div>
          </div>
        </div>
      `;
    }).join('');
    
    homeSearchDropdown.style.display = 'block';
    
    // ç»‘å®šç‚¹å‡»äº‹ä»¶
    homeSearchDropdown.querySelectorAll('.home-search-item').forEach(item => {
      item.onclick = () => {
        const index = parseInt(item.dataset.index);
        homeSearchDropdown.style.display = 'none';
        homeSearchGoods.value = '';
        editGoods(index);
      };
    });
  };
  
  // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰åˆ—è¡¨
  document.addEventListener('click', (e) => {
    if (!homeSearchGoods.contains(e.target) && !homeSearchDropdown.contains(e.target)) {
      homeSearchDropdown.style.display = 'none';
    }
  });
  
  // è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹æ—¶å¦‚æœæœ‰å†…å®¹åˆ™æ˜¾ç¤ºä¸‹æ‹‰åˆ—è¡¨
  homeSearchGoods.onfocus = () => {
    if (homeSearchGoods.value.trim()) {
      homeSearchGoods.oninput();
    }
  };
}

// å¯¼å…¥å¯¼å‡ºé¡µé¢åŠŸèƒ½
$('openImportExport').onclick = () => {
  $('importExportPage').style.display = 'block';
  updateImportExportStats();
};

// å¯¼å‡ºå•†å“æ€»é‡æ˜ç»†æŒ‰é’®äº‹ä»¶
$('exportGoodsDetail').onclick = () => {
  showGoodsExportDialog();
};

$('closeImportExport').onclick = () => {
  $('importExportPage').style.display = 'none';
};

// æ›´æ–°å¯¼å…¥å¯¼å‡ºé¡µé¢ç»Ÿè®¡
function updateImportExportStats() {
  const now = new Date();
  $('exportDateTime').textContent = now.toLocaleString('zh-CN');
  
  // æ›´æ–°é¢„è­¦æ—¥æœŸé˜ˆå€¼æ˜¾ç¤º
  const warnDays = localStorage.getItem('stockWarnDays') || '90';
  $('warnDaysDisplay').textContent = warnDays + 'å¤©';
  
  // æ›´æ–°å¯¼å‡ºæ ¼å¼æ˜¾ç¤º
  const savedFormat = localStorage.getItem('exportFormat') || EXPORT_FORMATS.HTML;
  const formatDisplay = document.getElementById('currentExportFormatDisplay');
  if (formatDisplay) {
    formatDisplay.textContent = getFormatName(savedFormat) + ' (' + getFormatExtension(savedFormat) + ')';
  }
  
  // å•†å“ç§ç±»
  const uniqueTypes = new Set(goodsList.map(g => g.mainType)).size;
  $('statGoodsTypes').textContent = uniqueTypes;
  
  // åº“å­˜æ€»é‡
  const totalStock = goodsList.reduce((sum, g) => sum + (g.qty || 0), 0);
  $('statTotalStock').textContent = totalStock;
  
  // ä½åº“å­˜é¢„è­¦ï¼ˆä»¥å¤§å•ä½ä¸ºæ ‡å‡†ï¼Œä½¿ç”¨å•†å“è‡ªå·±çš„é¢„è­¦é˜ˆå€¼ï¼‰
  const lowStockCount = goodsList.filter(g => {
    // ä½¿ç”¨å•†å“è‡ªå·±çš„é¢„è­¦é˜ˆå€¼ï¼Œé»˜è®¤ä¸º1
    const goodsWarnThreshold = g.warnThreshold || 1;
    const hasUnitConvert = g.unitText && g.unitText.includes('(') && g.unitRate > 1;
    if (hasUnitConvert) {
      const match = g.unitText.match(/^(.+)\((\d+)(.+)\)$/);
      if (match) {
        const rate = parseInt(match[2]) || 1;
        const bigQty = Math.floor((g.qty || 0) / rate);
        return bigQty < goodsWarnThreshold;
      }
    }
    return (g.qty || 0) < goodsWarnThreshold;
  }).length;
  $('statLowStock').textContent = lowStockCount;
  
  // å…¥åº“æ—¶é—´é¢„è­¦ï¼ˆè¶…è¿‡é¢„è­¦æ—¥æœŸæˆ–å…¥åº“æ—¶é—´+é¢„è­¦å¤©æ•°ï¼‰
  const today = new Date();
  const stockInWarnCount = goodsList.filter(g => {
    if (!g.stockTime) return false;
    // å¦‚æœè®¾ç½®äº†é¢„è­¦æ—¥æœŸï¼ŒæŒ‰é¢„è­¦æ—¥æœŸåˆ¤æ–­
    if (g.warnDate) {
      const warnDate = new Date(g.warnDate);
      return today > warnDate;
    }
    // å¦åˆ™æŒ‰å…¥åº“æ—¶é—´+é¢„è­¦å¤©æ•°åˆ¤æ–­
    const stockDate = new Date(g.stockTime);
    const diffDays = Math.floor((today - stockDate) / (1000 * 60 * 60 * 24));
    const globalWarnDays = parseInt(localStorage.getItem('stockWarnDays') || '90');
    const goodsWarnDays = g.stockInWarnDays || globalWarnDays;
    return diffDays > goodsWarnDays;
  }).length;
  $('statStockInWarn').textContent = stockInWarnCount;
}

// å¯¼å‡ºå•†å“æ€»é‡æ˜ç»†
// å°†æ•°é‡è½¬æ¢ä¸ºå¤§å•ä½/å°å•ä½æ ¼å¼
function formatQtyWithUnit(g) {
  const hasConvert = g.unitText && g.unitText.includes('(') && g.unitRate > 1;
  if (!hasConvert) {
    return { æ•°é‡: g.qty || 0, å•ä½: g.singleUnit || 'ä¸ª' };
  }
  // è§£æå•ä½æ¢ç®—ï¼Œå¦‚ "ç®±(10ä¸ª)" -> big=ç®±, rate=10, small=ä¸ª
  const match = g.unitText.match(/^(.+)\((\d+)(.+)\)$/);
  if (!match) {
    return { æ•°é‡: g.qty || 0, å•ä½: g.singleUnit || 'ä¸ª' };
  }
  const big = match[1];
  const rate = parseInt(match[2]) || 1;
  const small = match[3];
  const totalQty = g.qty || 0;
  const bigQty = Math.floor(totalQty / rate);
  const smallQty = totalQty % rate;
  return {
    æ•°é‡: `${bigQty}/${smallQty}`,
    å•ä½: `${big}/${small}`
  };
}

// æ˜¾ç¤ºå•†å“å¯¼å‡ºé€‰æ‹©å¯¹è¯æ¡†
function showGoodsExportDialog() {
  if (goodsList.length === 0) {
    return alert('æš‚æ— å•†å“å¯å¯¼å‡º');
  }
  
  // è·å–æ‰€æœ‰ä¸»ç±»å‹åŠå…¶å•†å“æ•°é‡
  const mainTypeStats = {};
  goodsList.forEach(g => {
    if (!mainTypeStats[g.mainType]) {
      mainTypeStats[g.mainType] = 0;
    }
    mainTypeStats[g.mainType]++;
  });
  
  // æŒ‰é¢„è®¾é¡ºåºæ’åºä¸»ç±»å‹
  const sortedTypes = Object.keys(mainTypeStats).sort((a, b) => {
    const indexA = mainTypeOrder.indexOf(a);
    const indexB = mainTypeOrder.indexOf(b);
    if (indexA === -1 && indexB === -1) return a.localeCompare(b);
    if (indexA === -1) return 1;
    if (indexB === -1) return -1;
    return indexA - indexB;
  });
  
  let html = `
    <div style="padding: 20px; max-height: 70vh; overflow-y: auto;">
      <h3 style="margin-bottom: 20px; font-size: 18px; text-align: center;">é€‰æ‹©è¦å¯¼å‡ºçš„å•†å“</h3>
      
      <!-- å…¨é€‰é€‰é¡¹ -->
      <div style="margin-bottom: 15px; padding: 15px; background: #e8f5e9; border: 2px solid #4caf50; border-radius: 8px; cursor: pointer;" onclick="toggleAllGoodsExport(this)">
        <label style="display: flex; align-items: center; cursor: pointer;">
          <input type="checkbox" id="exportAllGoods" style="width: 20px; height: 20px; margin-right: 12px;" checked>
          <div>
            <div style="font-weight: bold; font-size: 16px; color: #2e7d32;">ğŸ“¦ å…¨éƒ¨å•†å“</div>
            <div style="font-size: 13px; color: #666; margin-top: 4px;">å…± ${goodsList.length} ç§å•†å“</div>
          </div>
        </label>
      </div>
      
      <div style="font-size: 14px; color: #666; margin: 15px 0 10px; font-weight: 600;">æŒ‰ä¸»ç±»å‹é€‰æ‹©ï¼š</div>
      
      <!-- å„ä¸»ç±»å‹é€‰é¡¹ -->
      <div style="display: flex; flex-direction: column; gap: 10px;">
  `;
  
  sortedTypes.forEach((type, index) => {
    const count = mainTypeStats[type];
    const colors = {
      'åŸææ–™': '#e3f2fd',
      'åŠæˆå“': '#fff3e0',
      'æˆå“': '#e8f5e9',
      'åŒ…è£…ææ–™': '#fce4ec',
      'è¾…æ–™': '#f3e5f5',
      'å…¶ä»–': '#f5f5f5'
    };
    const borderColors = {
      'åŸææ–™': '#2196f3',
      'åŠæˆå“': '#ff9800',
      'æˆå“': '#4caf50',
      'åŒ…è£…ææ–™': '#e91e63',
      'è¾…æ–™': '#9c27b0',
      'å…¶ä»–': '#9e9e9e'
    };
    const bgColor = colors[type] || '#f5f5f5';
    const borderColor = borderColors[type] || '#666';
    
    html += `
      <div class="export-type-item" style="padding: 12px; background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 8px; cursor: pointer;" onclick="toggleTypeExport(this, '${type}')">
        <label style="display: flex; align-items: center; cursor: pointer; width: 100%;">
          <input type="checkbox" class="export-type-checkbox" data-type="${type}" style="width: 18px; height: 18px; margin-right: 10px;" checked>
          <div style="flex: 1;">
            <div style="font-weight: bold; font-size: 15px; color: #333;">${type}</div>
            <div style="font-size: 12px; color: #666; margin-top: 2px;">${count} ç§å•†å“</div>
          </div>
        </label>
      </div>
    `;
  });
  
  html += `
      </div>
      
      <div style="margin-top: 20px; display: flex; gap: 10px;">
        <button onclick="closeModal()" style="flex: 1; padding: 12px; background: #f5f5f5; border: 2px solid #999; border-radius: 6px; cursor: pointer; font-size: 15px;">å–æ¶ˆ</button>
        <button onclick="confirmGoodsExport()" style="flex: 1; padding: 12px; background: #4caf50; color: white; border: 2px solid #4caf50; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: bold;">ç¡®è®¤å¯¼å‡º</button>
      </div>
    </div>
  `;
  
  showModal('å¯¼å‡ºå•†å“æ€»é‡æ˜ç»†', html);
}

// åˆ‡æ¢å…¨é€‰çŠ¶æ€
function toggleAllGoodsExport(container) {
  const checkbox = container.querySelector('input[type="checkbox"]');
  checkbox.checked = !checkbox.checked;
  
  // åŒæ­¥æ‰€æœ‰ç±»å‹å¤é€‰æ¡†
  document.querySelectorAll('.export-type-checkbox').forEach(cb => {
    cb.checked = checkbox.checked;
    updateTypeItemStyle(cb.closest('.export-type-item'), checkbox.checked);
  });
  
  updateAllGoodsStyle(container, checkbox.checked);
}

// åˆ‡æ¢ç±»å‹é€‰æ‹©çŠ¶æ€
function toggleTypeExport(container, type) {
  const checkbox = container.querySelector('input[type="checkbox"]');
  checkbox.checked = !checkbox.checked;
  updateTypeItemStyle(container, checkbox.checked);
  
  // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ç±»å‹éƒ½é€‰ä¸­/æœªé€‰ä¸­ï¼Œæ›´æ–°å…¨é€‰çŠ¶æ€
  const allTypeCheckboxes = document.querySelectorAll('.export-type-checkbox');
  const allChecked = Array.from(allTypeCheckboxes).every(cb => cb.checked);
  const noneChecked = Array.from(allTypeCheckboxes).every(cb => !cb.checked);
  
  const allGoodsCheckbox = document.getElementById('exportAllGoods');
  const allGoodsContainer = allGoodsCheckbox.closest('div');
  
  if (allChecked) {
    allGoodsCheckbox.checked = true;
    updateAllGoodsStyle(allGoodsContainer, true);
  } else if (noneChecked) {
    allGoodsCheckbox.checked = false;
    updateAllGoodsStyle(allGoodsContainer, false);
  }
}

// æ›´æ–°ç±»å‹é¡¹æ ·å¼
function updateTypeItemStyle(container, checked) {
  if (checked) {
    container.style.opacity = '1';
    container.style.transform = 'scale(1)';
  } else {
    container.style.opacity = '0.6';
    container.style.transform = 'scale(0.98)';
  }
}

// æ›´æ–°å…¨é€‰æ ·å¼
function updateAllGoodsStyle(container, checked) {
  if (checked) {
    container.style.opacity = '1';
    container.style.transform = 'scale(1)';
  } else {
    container.style.opacity = '0.6';
    container.style.transform = 'scale(0.98)';
  }
}

// ç¡®è®¤å¯¼å‡ºå•†å“
function confirmGoodsExport() {
  const allGoodsCheckbox = document.getElementById('exportAllGoods');
  const typeCheckboxes = document.querySelectorAll('.export-type-checkbox');
  
  let selectedTypes = [];
  
  if (allGoodsCheckbox.checked) {
    // å…¨é€‰æ‰€æœ‰å•†å“
    selectedTypes = null; // nullè¡¨ç¤ºæ‰€æœ‰ç±»å‹
  } else {
    // è·å–é€‰ä¸­çš„ç±»å‹
    typeCheckboxes.forEach(cb => {
      if (cb.checked) {
        selectedTypes.push(cb.dataset.type);
      }
    });
    
    if (selectedTypes.length === 0) {
      return alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå•†å“ç±»å‹');
    }
  }
  
  closeModal();
  
  // è¿‡æ»¤å•†å“æ•°æ®
  let filteredGoods = goodsList.slice();
  if (selectedTypes !== null) {
    filteredGoods = filteredGoods.filter(g => selectedTypes.includes(g.mainType));
  }
  
  if (filteredGoods.length === 0) {
    return alert('æ‰€é€‰ç±»å‹ä¸‹æ²¡æœ‰å•†å“');
  }
  
  // ç”Ÿæˆå¯¼å‡ºæ•°æ®
  const data = sortGoodsList(filteredGoods)
    .map(g => {
      const qtyUnit = formatQtyWithUnit(g);
      return {
        å•†å“åç§°: g.name,
        è§„æ ¼: g.spec || '-',
        å•†å“ç±»å‹: g.mainType,
        å•†å“å­ç±»å‹: g.subType || '-',
        æ•°é‡: qtyUnit.æ•°é‡,
        å•ä½: qtyUnit.å•ä½,
        å•ä»·: (g.price || 0).toFixed(3),
        é‡‘é¢: ((g.qty || 0) * (g.price || 0)).toFixed(2),
        å…¥åº“æ—¶é—´: g.stockTime || '-'
      };
    });
  
  // æ ¹æ®é€‰æ‹©ç”Ÿæˆæ–‡ä»¶å
  let filename = 'å•†å“æ€»é‡æ˜ç»†';
  if (selectedTypes !== null && selectedTypes.length === 1) {
    filename = selectedTypes[0] + 'æ˜ç»†';
  } else if (selectedTypes !== null) {
    filename = 'é€‰ä¸­ç±»å‹å•†å“æ˜ç»†';
  }
  
  exportToExcel(data, filename);
}

// å¤åˆ¶å•†å“æ€»é‡æ˜ç»†
$('copyGoodsDetail').onclick = () => {
  const text = sortGoodsList(goodsList.slice()) // å¤åˆ¶æ•°ç»„å¹¶æŒ‰ä¸»ç±»å‹->å­ç±»å‹->å•†å“åç§°æ’åº
    .map(g => {
      const qtyUnit = formatQtyWithUnit(g);
      return `${g.name}\t${g.spec || '-'}\t${g.mainType}\t${g.subType || '-'}\t${qtyUnit.æ•°é‡}\t${qtyUnit.å•ä½}\t${(g.price || 0).toFixed(3)}\t${((g.qty || 0) * (g.price || 0)).toFixed(2)}\t${g.stockTime || '-'}`;
    }).join('\n');
  copyToClipboard('å•†å“åç§°\tè§„æ ¼\tå•†å“ç±»å‹\tå•†å“å­ç±»å‹\tæ•°é‡\tå•ä½\tå•ä»·\té‡‘é¢\tå…¥åº“æ—¶é—´\n' + text);
};

// å¯¼å‡ºä½åº“å­˜é¢„è­¦æ˜ç»†
$('exportLowStock').onclick = () => {
  const data = sortGoodsList(goodsList.filter(g => (g.qty || 0) < 10)) // å…ˆè¿‡æ»¤å†æŒ‰ä¸»ç±»å‹->å­ç±»å‹->å•†å“åç§°æ’åº
    .map(g => {
      const qtyUnit = formatQtyWithUnit(g);
      return {
        å•†å“åç§°: g.name,
        è§„æ ¼: g.spec || '-',
        å•†å“ç±»å‹: g.mainType,
        å•†å“å­ç±»å‹: g.subType || '-',
        å½“å‰æ•°é‡: qtyUnit.æ•°é‡,
        å•ä½: qtyUnit.å•ä½,
        é¢„è­¦é˜ˆå€¼: 10
      };
    });
  if (data.length === 0) return alert('æš‚æ— ä½åº“å­˜å•†å“');
  exportToExcel(data, 'ä½åº“å­˜é¢„è­¦æ˜ç»†');
};

// å¤åˆ¶ä½åº“å­˜é¢„è­¦æ˜ç»†
$('copyLowStock').onclick = () => {
  const list = sortGoodsList(goodsList.filter(g => (g.qty || 0) < 10)); // å…ˆè¿‡æ»¤å†æŒ‰ä¸»ç±»å‹->å­ç±»å‹->å•†å“åç§°æ’åº
  if (list.length === 0) return alert('æš‚æ— ä½åº“å­˜å•†å“');
  const text = list.map(g => {
    const qtyUnit = formatQtyWithUnit(g);
    return `${g.name}\t${g.spec || '-'}\t${g.mainType}\t${g.subType || '-'}\t${qtyUnit.æ•°é‡}\t${qtyUnit.å•ä½}\t10`;
  }).join('\n');
  copyToClipboard('å•†å“åç§°\tè§„æ ¼\tå•†å“ç±»å‹\tå•†å“å­ç±»å‹\tå½“å‰æ•°é‡\tå•ä½\té¢„è­¦é˜ˆå€¼\n' + text);
};

// å¯¼å‡ºå…¥åº“æ—¶é—´é¢„è­¦æ˜ç»†
$('exportStockInWarn').onclick = () => {
  const warnDays = parseInt(localStorage.getItem('stockWarnDays') || '90');
  const warnDate = new Date();
  warnDate.setDate(warnDate.getDate() - warnDays);
  const data = sortGoodsList(goodsList.filter(g => {
    if (!g.stockTime) return false;
    const stockDate = new Date(g.stockTime);
    return stockDate < warnDate;
  })) // å…ˆè¿‡æ»¤å†æŒ‰ä¸»ç±»å‹->å­ç±»å‹->å•†å“åç§°æ’åº
    .map(g => {
      const qtyUnit = formatQtyWithUnit(g);
      return {
        å•†å“åç§°: g.name,
        è§„æ ¼: g.spec || '-',
        å•†å“ç±»å‹: g.mainType,
        å•†å“å­ç±»å‹: g.subType || '-',
        å…¥åº“æ—¶é—´: g.stockTime,
        å½“å‰æ•°é‡: qtyUnit.æ•°é‡,
        å•ä½: qtyUnit.å•ä½
      };
    });
  if (data.length === 0) return alert('æš‚æ— å…¥åº“æ—¶é—´é¢„è­¦å•†å“');
  exportToExcel(data, 'å…¥åº“æ—¶é—´é¢„è­¦æ˜ç»†');
};

// å¤åˆ¶å…¥åº“æ—¶é—´é¢„è­¦æ˜ç»†
$('copyStockInWarn').onclick = () => {
  const warnDays = parseInt(localStorage.getItem('stockWarnDays') || '90');
  const warnDate = new Date();
  warnDate.setDate(warnDate.getDate() - warnDays);
  const list = sortGoodsList(goodsList.filter(g => {
    if (!g.stockTime) return false;
    const stockDate = new Date(g.stockTime);
    return stockDate < warnDate;
  })); // å…ˆè¿‡æ»¤å†æŒ‰ä¸»ç±»å‹->å­ç±»å‹->å•†å“åç§°æ’åº
  if (list.length === 0) return alert('æš‚æ— å…¥åº“æ—¶é—´é¢„è­¦å•†å“');
  const text = list.map(g => {
    const qtyUnit = formatQtyWithUnit(g);
    return `${g.name}\t${g.spec || '-'}\t${g.mainType}\t${g.subType || '-'}\t${g.stockTime}\t${qtyUnit.æ•°é‡}\t${qtyUnit.å•ä½}`;
  }).join('\n');
  copyToClipboard('å•†å“åç§°\tè§„æ ¼\tå•†å“ç±»å‹\tå•†å“å­ç±»å‹\tå…¥åº“æ—¶é—´\tå½“å‰æ•°é‡\tå•ä½\n' + text);
};

// å¤åˆ¶å•†å“æ‰€æœ‰æ€»é‡æ˜ç»†
$('copyAllGoods').onclick = () => {
  const text = sortGoodsList(goodsList.slice()) // å¤åˆ¶æ•°ç»„å¹¶æŒ‰ä¸»ç±»å‹->å­ç±»å‹->å•†å“åç§°æ’åº
    .map(g => {
      const qtyUnit = formatQtyWithUnit(g);
      return `${g.name}\t${g.spec || '-'}\t${g.mainType}\t${g.subType || '-'}\t${qtyUnit.æ•°é‡}\t${qtyUnit.å•ä½}`;
    }).join('\n');
  copyToClipboard('å•†å“åç§°\tè§„æ ¼\tå•†å“ç±»å‹\tå•†å“å­ç±»å‹\tæ•°é‡\tå•ä½\n' + text);
};

// å­ç±»å‹å¯¼å‡º
$('exportSubTypes').onclick = () => {
  const data = [];
  typeData.mainTypes.forEach(mainType => {
    const subTypes = typeData.subTypes[mainType] || [];
    subTypes.forEach(subType => {
      const count = goodsList.filter(g => g.mainType === mainType && g.subType === subType).length;
      data.push({
        å¤§ç±»å‹: mainType,
        å­ç±»å‹: subType,
        å•†å“æ•°é‡: count
      });
    });
  });
  if (data.length === 0) return alert('æš‚æ— å­ç±»å‹æ•°æ®');
  exportToExcel(data, 'å­ç±»å‹ç»Ÿè®¡');
};

// ç±»å‹å¯¼å‡º
$('exportTypes').onclick = () => {
  const data = typeData.mainTypes.map(type => ({
    ç±»å‹åç§°: type,
    å•†å“æ•°é‡: goodsList.filter(g => g.mainType === type).length,
    å­ç±»å‹æ•°é‡: (typeData.subTypes[type] || []).length
  }));
  exportToExcel(data, 'ç±»å‹ç»Ÿè®¡');
};

// ç±»å‹å¯¼å…¥
$('importTypes').onclick = () => {
  $('importTypeFile').click();
};

$('importTypeFile').onchange = (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = (event) => {
    try {
      const data = JSON.parse(event.target.result);
      if (data.mainTypes && data.subTypes) {
        if (confirm(`ç¡®å®šè¦å¯¼å…¥ç±»å‹æ•°æ®å—ï¼Ÿè¿™å°†è¦†ç›–ç°æœ‰ç±»å‹æ•°æ®ã€‚\nåŒ…å« ${data.mainTypes.length} ä¸ªå¤§ç±»å‹`)) {
          typeData = data;
          saveTypeData();
          alert('ç±»å‹æ•°æ®å¯¼å…¥æˆåŠŸ');
        }
      } else {
        alert('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
      }
    } catch (err) {
      alert('æ–‡ä»¶è§£æå¤±è´¥ï¼š' + err.message);
    }
    $('importTypeFile').value = '';
  };
  reader.readAsText(file);
};

// å¯¼å…¥æ•°æ®
$('importDataBtn').onclick = () => {
  $('importDataFile').click();
};

$('importDataFile').onchange = (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = (event) => {
    try {
      const data = JSON.parse(event.target.result);
      if (Array.isArray(data)) {
        if (confirm(`ç¡®å®šè¦å¯¼å…¥å•†å“æ•°æ®å—ï¼Ÿ\nåŒ…å« ${data.length} æ¡å•†å“è®°å½•`)) {
          goodsList = data;
          saveData();
          renderGoodsList();
          updateImportExportStats();
          alert('å•†å“æ•°æ®å¯¼å…¥æˆåŠŸ');
        }
      } else {
        alert('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
      }
    } catch (err) {
      alert('æ–‡ä»¶è§£æå¤±è´¥ï¼š' + err.message);
    }
    $('importDataFile').value = '';
  };
  reader.readAsText(file);
};

// è®¾ç½®é¢„è­¦æ—¥æœŸ
$('setWarnDaysBtn').onclick = () => {
  const currentDays = localStorage.getItem('stockWarnDays') || '90';
  const days = prompt('è¯·è¾“å…¥é¢„è­¦æ—¥æœŸé˜ˆå€¼ï¼ˆå¤©ï¼‰ï¼š', currentDays);
  if (days && !isNaN(days) && days > 0) {
    localStorage.setItem('stockWarnDays', days);
    // ç«‹å³æ›´æ–°æ˜¾ç¤º
    $('warnDaysDisplay').textContent = days + 'å¤©';
    updateImportExportStats();
    // æ›´æ–°æ·»åŠ å•†å“é¡µé¢çš„æç¤ºæ–‡å­—
    const warnDateHint = document.querySelector('#goodsWarnDate + div');
    if (warnDateHint) {
      warnDateHint.textContent = `ç•™ç©ºåˆ™ä½¿ç”¨å…¨å±€é¢„è­¦å¤©æ•°ï¼ˆ${days}å¤©ï¼‰`;
    }
    alert('é¢„è­¦æ—¥æœŸè®¾ç½®æˆåŠŸï¼š' + days + 'å¤©');
  }
};

// å¯¼å‡ºæ ¼å¼ç±»å‹
const EXPORT_FORMATS = {
  HTML: 'html',
  CSV: 'csv',
  TSV: 'tsv',
  XLSX: 'xlsx'
};

// å½“å‰é€‰æ‹©çš„å¯¼å‡ºæ ¼å¼
let currentExportFormat = localStorage.getItem('exportFormat') || EXPORT_FORMATS.HTML;

// å¯¼å‡ºä¸ºExcelï¼ˆæ”¯æŒå¤šç§æ ¼å¼ï¼šHTMLè¡¨æ ¼ã€CSVã€TSVã€XLSXï¼‰
function exportToExcel(data, filename, format = currentExportFormat) {
  if (data.length === 0) return alert('æš‚æ— æ•°æ®å¯å¯¼å‡º');

  const headers = Object.keys(data[0]);
  const dateStr = new Date().toLocaleDateString();
  
  switch (format) {
    case EXPORT_FORMATS.CSV:
      exportToCSV(data, headers, filename, dateStr);
      break;
    case EXPORT_FORMATS.TSV:
      exportToTSV(data, headers, filename, dateStr);
      break;
    case EXPORT_FORMATS.XLSX:
      exportToXLSX(data, headers, filename, dateStr);
      break;
    case EXPORT_FORMATS.HTML:
    default:
      exportToHTML(data, headers, filename, dateStr);
      break;
  }
}

// å¯¼å‡ºä¸ºHTMLè¡¨æ ¼æ ¼å¼ï¼ˆå…¼å®¹Excel/WPSï¼‰
function exportToHTML(data, headers, filename, dateStr) {
  // å®šä¹‰æ•°å­—åˆ—ï¼ˆæ ‡é¢˜å±…ä¸­ï¼Œæ•°æ®å³å¯¹é½ï¼‰
  const numberCols = ['æ•°é‡', 'å½“å‰æ•°é‡', 'å•ä»·', 'é‡‘é¢', 'é¢„è­¦é˜ˆå€¼', 'å•†å“æ•°é‡', 'å­ç±»å‹æ•°é‡'];

  // ç”ŸæˆHTMLè¡¨æ ¼
  let html = `
    <html xmlns:o="urn:schemas-microsoft-com:office:office"
          xmlns:x="urn:schemas-microsoft-com:office:excel"
          xmlns="http://www.w3.org/TR/REC-html40">
    <head>
      <meta charset="UTF-8">
      <style>
        table { border-collapse: collapse; width: 100%; }
        th { background-color: #4472C4; color: white; font-weight: bold; border: 1px solid #2F5597; padding: 10px; text-align: center; font-size: 12pt; }
        td { border: 1px solid #B4C7E7; padding: 8px; text-align: center; font-size: 11pt; }
        .num { text-align: right; }
        tr:nth-child(even) { background-color: #D9E2F3; }
        tr:hover { background-color: #F4B084; }
      </style>
    </head>
    <body>
      <table>
        <thead>
          <tr>
            ${headers.map(h => `<th>${h}</th>`).join('')}
          </tr>
        </thead>
        <tbody>
          ${data.map(row => `
            <tr>
              ${headers.map(h => {
                const val = row[h] || '';
                const isNumberCol = numberCols.includes(h);
                return `<td${isNumberCol ? ' class="num"' : ''}>${val}</td>`;
              }).join('')}
            </tr>
          `).join('')}
        </tbody>
      </table>
    </body>
    </html>
  `;

  const blob = new Blob(['\ufeff' + html], { type: 'application/vnd.ms-excel;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `${filename}_${dateStr}.xls`;
  link.click();
}

// å¯¼å‡ºä¸ºCSVæ ¼å¼
function exportToCSV(data, headers, filename, dateStr) {
  const csv = [
    headers.join(','),
    ...data.map(row => headers.map(h => {
      const val = row[h] || '';
      if (typeof val === 'string' && (val.includes(',') || val.includes('\n') || val.includes('"'))) {
        return `"${val.replace(/"/g, '""')}"`;
      }
      return val;
    }).join(','))
  ].join('\n');
  
  const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `${filename}_${dateStr}.csv`;
  link.click();
}

// å¯¼å‡ºä¸ºTSVæ ¼å¼ï¼ˆåˆ¶è¡¨ç¬¦åˆ†éš”ï¼Œç²˜è´´åˆ°Excel/WPSæ—¶è‡ªåŠ¨åˆ†åˆ—ï¼‰
function exportToTSV(data, headers, filename, dateStr) {
  const tsv = [
    headers.join('\t'),
    ...data.map(row => headers.map(h => {
      const val = row[h] || '';
      if (typeof val === 'string' && (val.includes('\t') || val.includes('\n'))) {
        return `"${val.replace(/"/g, '""')}"`;
      }
      return val;
    }).join('\t'))
  ].join('\n');
  
  const blob = new Blob(['\ufeff' + tsv], { type: 'text/tab-separated-values;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `${filename}_${dateStr}.tsv`;
  link.click();
}

// å¯¼å‡ºä¸ºçœŸæ­£çš„XLSXæ ¼å¼ï¼ˆä½¿ç”¨SheetJSåº“ï¼‰
function exportToXLSX(data, headers, filename, dateStr) {
  // æ£€æŸ¥æ˜¯å¦å·²åŠ è½½SheetJSåº“
  if (typeof XLSX === 'undefined') {
    // åŠ¨æ€åŠ è½½SheetJSåº“
    loadSheetJS().then(() => {
      generateXLSX(data, headers, filename, dateStr);
    }).catch(() => {
      alert('åŠ è½½Excelå¯¼å‡ºåº“å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
    });
  } else {
    generateXLSX(data, headers, filename, dateStr);
  }
}

// åŠ¨æ€åŠ è½½SheetJSåº“
function loadSheetJS() {
  return new Promise((resolve, reject) => {
    if (typeof XLSX !== 'undefined') {
      resolve();
      return;
    }
    
    const script = document.createElement('script');
    script.src = 'https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js';
    script.onload = resolve;
    script.onerror = reject;
    document.head.appendChild(script);
  });
}

// ç”ŸæˆXLSXæ–‡ä»¶
function generateXLSX(data, headers, filename, dateStr) {
  // åˆ›å»ºå·¥ä½œç°¿
  const wb = XLSX.utils.book_new();
  
  // å‡†å¤‡æ•°æ®ï¼ˆåŒ…å«è¡¨å¤´ï¼‰
  const wsData = [headers, ...data.map(row => headers.map(h => row[h] || ''))];
  
  // åˆ›å»ºå·¥ä½œè¡¨
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  
  // è®¾ç½®åˆ—å®½
  const colWidths = headers.map(h => ({ wch: Math.max(h.length * 2 + 2, 12) }));
  ws['!cols'] = colWidths;
  
  // æ·»åŠ å·¥ä½œè¡¨åˆ°å·¥ä½œç°¿
  XLSX.utils.book_append_sheet(wb, ws, 'æ•°æ®');
  
  // ç”Ÿæˆæ–‡ä»¶å¹¶ä¸‹è½½
  XLSX.writeFile(wb, `${filename}_${dateStr}.xlsx`);
}

// æ˜¾ç¤ºå¯¼å‡ºæ ¼å¼é€‰æ‹©å¯¹è¯æ¡†
function showExportFormatDialog() {
  const formats = [
    { key: EXPORT_FORMATS.HTML, name: 'Excelè¡¨æ ¼ (.xls)', desc: 'å…¼å®¹æ€§æœ€å¥½ï¼Œæ”¯æŒæ ·å¼å’Œé¢œè‰²' },
    { key: EXPORT_FORMATS.CSV, name: 'CSVæ ¼å¼ (.csv)', desc: 'çº¯æ–‡æœ¬æ ¼å¼ï¼Œæ‰€æœ‰è½¯ä»¶éƒ½æ”¯æŒ' },
    { key: EXPORT_FORMATS.TSV, name: 'TSVæ ¼å¼ (.tsv)', desc: 'åˆ¶è¡¨ç¬¦åˆ†éš”ï¼Œç²˜è´´åˆ°Excelè‡ªåŠ¨åˆ†åˆ—' },
    { key: EXPORT_FORMATS.XLSX, name: 'Excel 2007+ (.xlsx)', desc: 'çœŸæ­£çš„Excelæ ¼å¼ï¼Œéœ€è¦ç½‘ç»œåŠ è½½åº“' }
  ];
  
  const current = localStorage.getItem('exportFormat') || EXPORT_FORMATS.HTML;
  
  let html = `
    <div style="padding: 20px;">
      <h3 style="margin-bottom: 20px; font-size: 18px;">é€‰æ‹©å¯¼å‡ºæ ¼å¼</h3>
      <div style="display: flex; flex-direction: column; gap: 12px;">
  `;
  
  formats.forEach(f => {
    const isSelected = f.key === current;
    html += `
      <label style="display: flex; align-items: flex-start; padding: 15px; border: 2px solid ${isSelected ? '#4CAF50' : '#e0e0e0'}; border-radius: 8px; cursor: pointer; background: ${isSelected ? '#E8F5E9' : '#fff'};" onclick="selectExportFormat('${f.key}')">
        <input type="radio" name="exportFormat" value="${f.key}" ${isSelected ? 'checked' : ''} style="margin-right: 12px; margin-top: 3px;">
        <div>
          <div style="font-weight: bold; font-size: 15px; margin-bottom: 4px;">${f.name}</div>
          <div style="font-size: 13px; color: #666;">${f.desc}</div>
        </div>
      </label>
    `;
  });
  
  html += `
      </div>
      <div style="margin-top: 20px; text-align: center; color: #999; font-size: 13px;">
        å½“å‰é€‰æ‹©å°†ä¿å­˜ä¸ºé»˜è®¤å¯¼å‡ºæ ¼å¼
      </div>
    </div>
  `;
  
  showModal('å¯¼å‡ºæ ¼å¼è®¾ç½®', html);
}

// é€‰æ‹©å¯¼å‡ºæ ¼å¼
function selectExportFormat(format) {
  currentExportFormat = format;
  localStorage.setItem('exportFormat', format);
  
  // æ›´æ–°é€‰ä¸­æ ·å¼
  document.querySelectorAll('input[name="exportFormat"]').forEach(radio => {
    const label = radio.closest('label');
    if (radio.value === format) {
      label.style.borderColor = '#4CAF50';
      label.style.background = '#E8F5E9';
      radio.checked = true;
    } else {
      label.style.borderColor = '#e0e0e0';
      label.style.background = '#fff';
      radio.checked = false;
    }
  });
  
  // å…³é—­å¯¹è¯æ¡†
  setTimeout(() => {
    closeModal();
    showSyncStatus('å¯¼å‡ºæ ¼å¼å·²è®¾ç½®ä¸º: ' + getFormatName(format));
  }, 300);
}

// è·å–æ ¼å¼åç§°
function getFormatName(format) {
  const names = {
    [EXPORT_FORMATS.HTML]: 'Excelè¡¨æ ¼',
    [EXPORT_FORMATS.CSV]: 'CSVæ ¼å¼',
    [EXPORT_FORMATS.TSV]: 'TSVæ ¼å¼',
    [EXPORT_FORMATS.XLSX]: 'Excel 2007+'
  };
  return names[format] || 'Excelè¡¨æ ¼';
}

// è·å–æ ¼å¼æ‰©å±•å
function getFormatExtension(format) {
  const extensions = {
    [EXPORT_FORMATS.HTML]: '.xls',
    [EXPORT_FORMATS.CSV]: '.csv',
    [EXPORT_FORMATS.TSV]: '.tsv',
    [EXPORT_FORMATS.XLSX]: '.xlsx'
  };
  return extensions[format] || '.xls';
}

// å¤åˆ¶åˆ°å‰ªè´´æ¿
function copyToClipboard(text) {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(text).then(() => {
      alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    }).catch(() => {
      fallbackCopy(text);
    });
  } else {
    fallbackCopy(text);
  }
}

function fallbackCopy(text) {
  const textarea = document.createElement('textarea');
  textarea.value = text;
  textarea.style.position = 'fixed';
  textarea.style.opacity = '0';
  document.body.appendChild(textarea);
  textarea.select();
  try {
    document.execCommand('copy');
    alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
  } catch (err) {
    alert('å¤åˆ¶å¤±è´¥');
  }
  document.body.removeChild(textarea);
}

// ==================== ç™»å½•å’ŒåŒæ­¥äº‹ä»¶ç»‘å®š ====================

// ç™»å½•é¡µé¢äº‹ä»¶
$('doLogin').onclick = doLogin;
$('goRegister').onclick = showRegisterPage;

// æ³¨å†Œé¡µé¢äº‹ä»¶
$('doRegister').onclick = doRegister;
$('backToLogin').onclick = showLoginPage;

// å›è½¦é”®ç™»å½•
$('loginPassword').onkeydown = (e) => {
  if (e.key === 'Enter') doLogin();
};

// å›è½¦é”®æ³¨å†Œ
$('regPassword2').onkeydown = (e) => {
  if (e.key === 'Enter') doRegister();
};

// åˆå§‹åŒ–ï¼šæ£€æŸ¥ç™»å½•çŠ¶æ€
if (PUBLIC_DATA_MODE) {
  // å…¬å…±æ•°æ®æ¨¡å¼ï¼šæ— éœ€ç™»å½•ï¼Œç›´æ¥æ˜¾ç¤ºä¸»é¡µé¢å¹¶åŒæ­¥æ•°æ®
  hideAuthPages();
  loadData();
  init();
  // ä»äº‘ç«¯åŠ è½½å…¬å…±æ•°æ®
  if (ENABLE_CLOUD_SYNC) {
    syncFromCloud().then(() => {
      init();
    });
  }
} else if (isLocalMode && currentUser) {
  // æœ¬åœ°æ¨¡å¼ä¸”å·²ç™»å½•ï¼Œç›´æ¥æ˜¾ç¤ºä¸»é¡µé¢
  hideAuthPages();
  init();
} else if (authToken && !isLocalMode) {
  // äº‘ç«¯æ¨¡å¼å·²ç™»å½•ï¼Œå…ˆåŒæ­¥æ•°æ®å†æ˜¾ç¤ºä¸»é¡µé¢
  hideAuthPages();
  syncFromCloud().then(() => {
    init();
  });
} else {
  // æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•é¡µé¢
  showLoginPage();
}

// è‡ªåŠ¨åŒæ­¥ï¼ˆæ¯30ç§’ä¸Šä¼ åˆ°äº‘ç«¯ï¼‰
setInterval(() => {
  if (PUBLIC_DATA_MODE || authToken) {
    syncToCloud();
  }
}, 30000);

// æœ¬åœ°æ¨¡å¼ï¼šæ¯3ç§’æ£€æŸ¥ä¸€æ¬¡æ•°æ®å˜åŒ–
setInterval(() => {
  if (isLocalMode && (PUBLIC_DATA_MODE || currentUser)) {
    refreshDataFromStorage();
  }
}, 3000);

// é¡µé¢é‡æ–°å¯è§æ—¶åŒæ­¥æ•°æ®
document.addEventListener('visibilitychange', () => {
  if (!document.hidden && (PUBLIC_DATA_MODE || currentUser)) {
    if (isLocalMode) {
      refreshDataFromStorage();
    } else {
      syncFromCloud();
    }
  }
});

// é¡µé¢å…³é—­å‰åŒæ­¥
window.onbeforeunload = () => {
  if (PUBLIC_DATA_MODE || authToken) {
    syncToCloud();
  }
};

// é€€å‡ºç™»å½•æŒ‰é’®äº‹ä»¶
$('logoutBtn').onclick = logout;

// åŒæ­¥æŒ‰é’®äº‹ä»¶
$('syncBtn').onclick = () => {
  if (PUBLIC_DATA_MODE && ENABLE_CLOUD_SYNC) {
    // å…¬å…±æ•°æ®æ¨¡å¼ä¸”å¯ç”¨äº‘ç«¯ï¼šä¸Šä¼ æ•°æ®åˆ°äº‘ç«¯ï¼Œç„¶åé‡æ–°åŠ è½½
    syncToCloud().then(() => {
      setTimeout(() => {
        syncFromCloud().then(() => {
          showSyncStatus('æ•°æ®å·²åŒæ­¥');
        });
      }, 500);
    });
  } else if (isLocalMode) {
    refreshDataFromStorage();
    showSyncStatus('æ•°æ®å·²åŒæ­¥');
  } else if (authToken) {
    syncFromCloud().then(() => {
      showSyncStatus('æ•°æ®å·²åŒæ­¥');
    });
  }
};
</script>
</body>
</html>
